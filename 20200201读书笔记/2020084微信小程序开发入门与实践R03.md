## 记忆时间

## 卡片

### 0101. 反常识卡——

这本书的主题核心，就是最大的反常识卡，并且注意时间脉络。

#### 01. 常识

#### 02. 反常识

#### 03. 知识来源

比如提出者，如何演化成型的；书或专栏具体出现的地方。

#### 04. 例子

### 0201. 术语卡——

根据反常识，再补充三个证据——就产生三张术语卡。

例子。

### 0202. 术语卡——

### 0203. 术语卡——

### 0301. 人名卡——

根据这些证据和案例，找出源头和提出术语的人是谁——产生一张人名卡，并且分析他为什么牛，有哪些作品，生平经历是什么。

维基百科链接：有的话。

#### 01. 出生日期

用一句话描述你对这个大牛的印象。

#### 02. 贡献及经历

#### 03. 论文及书籍

#### 04. 演讲汇总

找一个他的 TED 演讲，有的话。

### 0401. 金句卡——

最后根据他写的非常震撼的话语——产生一张金句卡。

### 0501. 行动卡——

行动卡是能够指导自己的行动的卡。

### 0601. 任意卡——

最后还有一张任意卡，记录个人阅读感想。

## 模板

### 1. 逻辑脉络

用自己的话总结主题，梳理逻辑脉络，也就是这本书整个地图里这一章所在的节点。

### 2. 摘录及评论

1『自己的观点』

2『行动指南』

3『与其他知识的连接』

[codeyu/orange-can-step-by-step: 微信小程序开发入门与实践](https://github.com/codeyu/orange-can-step-by-step)

## 10. 电影

### 1. 逻辑脉络

利用 wx.request 和后端服务交互。使用 wx.request 获取真实的网络数据，并将这些数据「填充」到小程序中；tabBar 控件和嵌套模版的使用。tabBar 在 app.json 里设置，跳转到带 tabBar 的页面，需要用 wx.switchTab 方法。

### 2. 摘录及评论

本章我们编写了一个类似「豆瓣影评」的小功能，所有数据来自于豆瓣开放的 API。通过编写这部分的功能，我们将学习如何使用 wx.request 获取真实的网络数据，并将这些数据「填充」到小程序中。此外，本章中最重要的内容是多层嵌套模板的使用技巧，多层嵌套模板的优势将在本章中得到体现。此外本章还指出了很多小程序的「坑」，希望可以帮助开发者节约宝贵的时间。

电影部分同文章部分属于同一级别，我们在本章的开始部分使用小程序提供的 tab 选项卡来实现电影模块和文章模块的切换。需要注意的是，我们不需要自己编写代码实现 tab 选项卡。小程序提供了现成的 tab 选项卡，我们只需要在 app.json 中配置一些参数即可实现 tab 选项卡的效果。

tab 选项卡的配置是通过 app.jon 文件中的 tabBar 选顼来实现的。在配置 tab 选项卡之前，我们新建一个页面 movie 页面（位于 pages/movie 目录下）。或者直接在 app.json 的 pages 选项下新增 ρages/move/move 并保存，这将直接在 pages/move 目录下新建 movie 页面的 4 个页面文件。接着配置文章和电影页面的 tab 选项卡，代码如下：

黑色加粗部分是新增的代码。tabbar 配置项有以下几个属性：1）color 未选中时的 tab 选项卡文字颜色。2）selectedColor 选中时 tab 选项卡文字颜色。3）backgroundColor，tab 选项卡背景颜色。4）borderstyle，tab 选项卡上边框的颜色，注意它只支持 black 和 white 两个取值，默认是 black。5）list，tab 选项卡列表，是一个数组，接受一组 object 对象，我们在后面会具体给出每个对象的属性。6）position 可选值有 bottom 和 top，默认为 bottom，指定选顼卡位于底部还是顶部。

再来具体看看 list 这个数组。list 数组的每一项都是一个 object 对象，每个 object 对象代表ー个 tab 选项，最少必须有两个 tab 选项，而最多只能有 5 个 tab 选项。tab 选项卡出现的顺序由数组中 object 的顺序来決定。object 对象包含以下几个属性：1）pagePath，每个 tab 选项的页面路径。注意，用于 pagepath 的路径必须预先已在 app.json 的 pages 中定义。2）text，tab 选项卡上出现的文字。3）iconPath，tab 选项卡上的图片路径，图片大小限制为最大 40KB，建议尺寸为 81x81px。4）selectedlconPath，选中是的图片路径，图片大小限制为最大 40kb，建议尺寸为 81x81 px。

这里要特别注意，对于 pagePath、iconPath 和 selectedlconPath 这几个路径，一定不要以「/」开头。即使它们看起来是绝对路径也不要在路径前面加「/」 。在 pagePath 前面加「/」将导致错误。如果在 iconPath 前加「/」 ，虽然在模拟器中不会出现问题，但将项目在真机上预览时（在开发工具的「项目」里点击「预览」时）开发工具将报如图 10-2 所示的错误。

此时，我们保存并运行代码，会发现页面停留在 welcome 页面，点击「开启小程序之旅」，页面没有反应。如果在 welcome.js 的 navigateTo 中设置了 fail 函数，点击「开启小程序之旅」就将进入 navigateTo 的 fail 函数中。

为什么会出现这样的情况？我们在 4.112 小节中介绍 redirecTo 和 navigateTo 时，提到过这两个方法只能用于不帯 tab 选顼卡的页面。此时要跳转的 post 页面已经被设置成了带选项卡的页面，所以无论使用 redirecTo 还是 navigateTo 都不能成功跳转，必须使用 4.11.2 小节中我们提到的另外一个导航方法 wx.switchTab 方法，才能成功跳转到帯有 tab 选项卡的页面。修改 welcome.js 页面的 onTapJump 方法。

以上代码仅仅是将原先所调用的 wx.NavigateTo 修改成了 wx.switchTab。保存并运行代码，此时再次点击 welcome 页面的「开启小程序之旅」，可以成功打开 post 页面。此时的 post 页面底部出现了ー个 tab 选项卡，如图 10-3 所示。

可以通过点击「文字」和「光影」进行文章和电影页面的切换。需要特别注意的是，wx.redirecTo 和 wx.navigateTo 无法跳转到带有 tab 选项卡的页面；同理，使用 wx.switchTab 也无法跳转到不带 tab 选项卡的页面。它们各司其职，不能滥用。开发者还可以尝试ー下 tab 选项卡在页面上部的布局，将 app.json 中 tabBar 配置下的 position 由 「bottom」修改为「top」，tab 选项卡将出现在页面的上部，如图 10-4 所示。可以看到在上部的 tab 选项卡是不包含 tab 图标的，即使你设置了 tab 的图标也不会出现。

### 10.2 电影页面介绍

电影模块部分总共有以下几个展示模块：1）电影首页展示正在热映、即将上映和豆瓣 top250 三种类型的电影。2）每种电影只展示最前面 3 部。3）每种电影有一个「更多」按钮，点击将打开一个新页面，展示该类型下所有的电影。4）支持电影搜索功能。5）点击任意一部电影都将打开电影详情页面。

开发者可以参考本书彩页中的设计图，直观且详细地了解各个功能模块。所有电影数据均来自于豆瓣电影开放 API，以下是豆瓣电影 API 文档的地址：[豆瓣 Api V2（测试版） | douban-api-docs](https://douban-api-docs.zce.me/)

1『原书的链接失效了，上面的是搜索到的有关豆瓣 API 的信息，API 是数据挖掘里一个重要的数据源。具体技术还要去深入了解。发现豆瓣官方 API 已经关闭了。[zce/douban-api-proxy: 一个豆瓣 API 的反向代理，旨在解决豆瓣屏蔽小程序请求问题（豆瓣接口 403 问题）](https://github.com/zce/douban-api-proxy)』

对于电影页面的编写，我们将大量使用 template 模板，甚至是使用多层次嵌套模板。图 10-5 解释了电影模块中所有页面及模板的结构关系。开发者不需要现在马上看明白上面的结构关系图，只需要在后续章节中时时回顾一下此图即可。箭头中没有标注包含数量的表示只包含个模板。

我们大概解释一下以上关系调用图：电影功能部分总共有 3 个页面，分别是电影首页、更多电影和电影详情页面以及 1 个电影搜索模块（电影搜索不是单独的一个页面，位于电影首页）。以电影首页为例：电影首页由 3 个 movie-list-tpl 模板构成，每个 movie-list-tpl 模板由 n 个 movie-tpl 模板构成，而每个 movie-tpl 模板又包含 1 个 stars-tpl 模板。我们基本可以人以上 3 个示意图中完全解析出模板的嵌套关系：电影首页由 3 个 movie-list-tpl 模板构成，每个 movie-list-tpl 模板又由 3 个 movie-tpl 模板构成，而每个 movie-tpl 模板又包含了 1 个 stars-tρl 模板。从图 10-5 中我们可以看到，嵌套模板的使用可以避免编写重复代码，大量的 wxml 代码将被复用。如果你已经忘记了 template 模板的使用，请回顾一下本书第 5 章的内容。

### 10.3 编写豆瓣星星评分组件：stars-tpl 模板

当点击 tab 选项卡的「光影」选项时将跳转到电影首页。在 10.3-10.5 这 3 节中，我们将连续编写 3 个模板。对于这些模板，我们只需要大概浏览一下它们的骨架结构，对于 {{}} 中所绑定的数据，无须太过关心。当这 3 个模板被编写完成并在电影首页中传入数据调用时自然会明白每个份所绑定的数据意义。

在 10.2 节中，我们分析了电影首页的模板构成。下面我们首先编写电影首页所需要的几个模板，这里从最小的模板（stars-tpl 模板）开始编写。在 movie 目录下新建一个 stars 文件夹，并在该文件夹下新建两个文件：stars-tpl.wxml 和 stars-tpl.wxss。随后在 stars-tpl.wxml 中新增以下代码：

```
<template name="starsTpl">
  <view class="stars-container">
    <view class="stars">
      <block wx:for="{{stars}}" wx:for-item="i">
        <image wx:if="{{i===1}}" src="/images/icon/wx_app_star.png"></image>
        <image wx:elif="{{i===0.5}}" src="/images/icon/wx_app_star@half.png"></image>
        <image wx:else="{{i===0}}" src="/images/icon/wx_app_star@none.png"></image>
      </block>
    </view>
    <text class="star-score">{{score}}</text>
  </view>
</template>
```

stars 模板是需要从外部传入一些数据才可以正常使用的，所以我们现在无法直接预览 stars 模板的效果。stars 模板接收一个数组作为参数，这里先给出接收数组的形式：[1,1,1,0,0] 表示 3 星评价，[1,1,1,1,1] 表示 5 星评价，[1,1,1,0.5,0] 表示 3 星半。注意，模板中 3 个 image 组件的使用技巧在前面的已提过，条件渲染不仅仅可以使用 wx:if 和 wx:else，还可以多层次地使用 if else if else......3 个 image 组件中的 if else 展示了这种多层次条件的用法。

block 标签将循环评分数组，循环一定会执行 5 次，出现 5 颗星星，但会根据数据组中当前位的取值是 1、0.5 还是 0 来决定当前的星星图片是满星、半星还是空星。这样评分组件的星级就实现。同时 {{star}} 还需要绑定一个评分的分数，这个分数也需要由外部传入。接着，我们在 stars-tpl.wxss 中编写 stars 模板的样式。

以上就是 stars-tpl 模板的全部代码，我们暂且放下，接着编写其他模板的代码，最后再将这些模板组装起来。

### 10.4 编写 movie-tpl 模板

接着我们编写电影首页中需要用到的另外一个模板：movie-tpl。模板的示意图请参考图 10-7。在 pages 的 movie 目录下新建一个 single-movie 目录，用来存放 movie-tpl 模板。在 /pages/movie/single-movie 目录下新建两个文件：movie-tpl.wxml 和 movie-tpl.wxss 文件。首先在 movie-tpl.wxml 中编写 movie-tpl 模板的骨架代码：

```
<import src="../stars/stars-tpl.wxml"></import>
<template name="movieTpl">
  <view class="movie-container" catchtap="onMovieTap" data-movie-id="{{movieId}}">
    <image class="movie-img" src="{{coverageUrl}}"></image>
    <text class="movie-title">{{title}}</text>
    <template is="starsTpl" data="{{stars:stars,score:average}}"></template>
  </view>
</template>
```

在以上代码的顶部我们使用 import 引入了在 10.3 节中定义 stars-tpl 模板。Moive-tpl 模板由一张电影海报、电影标题以及 stars-tpl 模板构成。对于整个 movie-tpl 模板，我们在其容器上注册了一个事件 onMovieTap，并绑定了当前电影的 id 号 —— movield。

需要注意的是，stars-Tpl 模板的 data 属性，该属性将 stars 数组和 score 评分传入 stars-Tpl 中（请开发者回顾一下 10.3 节中的 tars-Tpl 定义），那么 movie-tpl 模板中的 stars 数组和 score 评分又是从哪里来的呢？答案依然是从外部传入的。在 10.5 节中编写 movie-list-tpl 时将看到如何传入这两个参数。接着编写 move-tpl 模板的样式。注意，在样式的顶部我们依然需要引入 stars-tpl 模板所使用的样式。

### 10.5 编写 movie-list-tpl 模板

直接被电影首页调用的模板是 movie-list-tpl 模板，movie-list-tpl 模板中引用了 movie-tpl 模板，而 movie-tpl 模板中又引用了 stars-tpl 模板。这就是我们所说的 3 层模板嵌套关系。首先在 pages/movie 目录下新建 movie-list 目录，接着在 movie-list 目录下新建两个文件：movie-list-tpl.wxml 和 movie-list-tpl.wxss 文件。下面编写 movie-list-tpl 模板的骨架。在 movie-list-tpl.wxml 中添加以下代码：

```
<import src="../single-movie/movie-tpl.wxml"></import>
<template name="movieListTpl">
  <view class="movie-list-container">
    <view class="inner-container">
      <view class="movie-head">
        <text class="slogan">{{categoryTitle}}</text>
        <view class="more" catchtap="onMoreTap" data-category="{{categoryTitle}}">
          <text class="more-text">更多</text>
          <image class="more-img" src="/images/icon/wx_app_arrow_right.png"></image>
        </view>
      </view>
      <view class="movies-container">
        <block wx:for="{{movies}}" wx:for-item="movie">
          <template is="movieTpl" data="{{...movie}}"></template>
        </block>
      </view>
    </view>
  </view>
</template>
```

同样，我们在代码的开头部分使用 import 引入 movie-tpl 模板，并在 block 标签中使用 move-tpl 这个模板。注意 template 标签中的 data 属性，我们在这里将 movie-tpl 模板所需要的数据传进去。接着编写 movie-list-tpl 模板的样式。在 movie-list-tpl.wxss 文件中编写以下代码：

注意在代码的开头部分使用 import 引入 movie-tpl 模板所使用的 movie-tpl 模板的样式文件 movie-tpl.wxss。

### 10.6 电影首页的骨架与样式

在我们编写好 3 个 template 组件后，电影首页的骨架编写将变得非常简单，只需要在电影首页中引用 movie-list-tpl 模板即可。

在 movie.wxml 页面中添加以下代码：

```
<import src="movie-list/movie-list-tpl.wxml" />

<view class="container" wx:if="{{containerShow}}">
  <view class="movies-template">
    <template is="movieListTpl" data="{{...inTheaters}}" />
  </view>
  <view class="movies-template">
    <template is="movieListTpl" data="{{...comingSoon}}" />
  </view>
  <view class="movies-template">
    <template is="movieListTpl" data="{{...top250}}"/>
  </view>
</view>
```

注意，在代码开头部分使用 import 引入了 movie-list-tpl 模板。同时在本段代码中使用了 3 次 movie-list-tp 模板，分别代表 inTheaters正在热映、comingSoon 即将上映和 top250 经典电影 3 种类型的电影。接着编写电影首页的样式。在 move.wxss 文件中添加以下代码：

### 10.7 豆瓣电影 API 分析

在编写电影首页的 js 调用豆瓣 API 之前，我们首先应当对豆瓣电影 API 有一个直观的认识和了解。所谓开放 APl，是指某些公司、企业将自己公司所持有的数据、用户数据选择性地开放给开发者调用，让开发者可以使用数据并围绕这些数据构建自己的应用，从而帮助公司、企业完善其平台和生态。

目前，绝大多数的开放 API 都属于 RESTFUl 风格的 APl，比如豆瓣 API、github 开发者 API 等。豆瓣 API（V2 版）就属于这类 API，其 API 权限有 3 种：公开、高级和商务。所有开发者无须申请即可调用公开权限的 APl，但只有部分 API 是公开权限的，一些高级接口无法调用，且公开 API 具有 40 次 / 分钟的访问限制。如果开发者在调试代码时遇到豆瓣返回错误信息，就有可能是因为已经超过允许访问的次数。这个时候唯一的办法就是稍等片刻。高级权限和商务权限需要开发者向豆瓣发邮件申请。

本书中所调用的豆瓣 API 均为公开 API，所以要注意访问频率限制的问题。在 Orange Can 项目中总共使用了以下几个豆瓣电影 API：1）获取正在热映的电影。2）获取即将上映的电影。3）获取豆瓣 top250 电影。4）电影搜索。5）获取电影条目信息（电影详情数据）。以获取豆翔瓣 top250 的 API 地址为例，一个完整的获取豆瓣 top250 电影的 API 地址为：

1『官方接口已关闭。』

在以上 APl 中，我们向豆瓣请求 top250 电影中的前 15 条电影信息。start=0 和 count=15 是查询参数，可根据需求自行调整，但要注意每次加载最多只能获取 20 条数据，count 超过 20 是没有意义。开发者可直接在浏览器中输入以上 URL 地址，豆瓣将返回我们需要的数据，返回数据的类型是 JSON 类型，如图 10-9 所示。关于其他几个 API 接口的使用方法，我们将放在后续实例编码中讲解。












