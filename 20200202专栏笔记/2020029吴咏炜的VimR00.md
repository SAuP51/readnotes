## 记忆时间

## 卡片

### 0101. 主题卡——高频操作汇总

1、ct)。当前位置到下一个 ) 之间的字符全部删除并进入插入模式。

2、D 或者 d\$，删除到行尾。d 加动作来进行删除（dd 删除整行）。

3、C 或者 c\$，删除到行尾然后进入插入模式。c 加动作来进行修改（cc 修改整行）。

### 0201. 术语卡——

根据反常识，再补充三个证据——就产生三张术语卡。

### 0202. 术语卡——

### 0203. 术语卡——

### 0301. 人名卡——

根据这些证据和案例，找出源头和提出术语的人是谁——产生一张人名卡，并且分析他为什么牛，有哪些作品，生平经历是什么。

### 0401. 金句卡——

最后根据他写的非常震撼的话语——产生一张金句卡。

### 0501. 任意卡——

最后还有一张任意卡，记录个人阅读感想。

## 0000开篇词.md

### 01. Vim 的「前世今生」

说到 Vim，就不能不谈一下 vi；要说 vi，那跟 Unix 就有着千丝万缕的联系。万物起源总有那么点故事，我们这个课程的主题也不例外。这个故事可以讲上很长时间，不过，今天不是故事会时间，我只会花几分钟给你快速梳理一下这段历史，带你了解 Vim 的「前世」，也就能更好地理解它的「今生」。

故事的开头是在 1975 年秋天，Unix 诞生之后的第六年。Ken Thompson（肯·汤普逊）来到了加利福尼亚大学伯克利分校，开始了为期一年的访问教授生活。当然，他也带上了最新版本的 Unix 的补丁。根据传说，由于贝尔实验室律师们的阻挠，他不能直接把补丁给其他人，而只能把装有补丁的磁带「丢」在某个地方，然后由别人「正好」捡到……Unix 就以这种「地下」的传播方式流传开了。

同年，年轻的 Bill Joy（比尔·乔伊）也进入了加利福尼亚大学伯克利分校，学习电子工程和计算机科学。他立刻就迷上了 Unix。在后面几年的硕士生涯里，他修正了 Unix 里的 Pascal 系统，使得 Pascal 成了学生编程的缺省选择。他在 1978 年负责发布了第一个伯克利发行版（BSD，即 Berkeley Software Distribution），其中包含了他写的 ex，一个编辑器 ed 的改进版本。随即，在 1979 年他发布了第二版的伯克利 Unix（2BSD），包含了他写的 vi 和 csh。他独立实现了 BSD 中的 TCP/IP 栈。离开伯克利后，他成了 Sun 的联合创始人和首席科学家，在 Solaris 操作系统、NFS 网络文件系统、SPARC 处理器、Java 语言的开发等多个领域中作出了自己的贡献……

在 Bill Joy 的无数传奇故事里，有一个是，他只花了一个周末就写出了 vi。这当然…… 不是真的。vi 是演进的结果，前面还有 ed、em、en、ex（哈，对于两字母的 Unix 命令，我看得也是有点晕了）等等一系列。只不过，那些都是基于命令的行编辑器，而不是全屏编辑器（部分原因是那时的很多系统仍然使用着电传打字机，而不是 CRT 终端）。vi 可以充分使用整个终端屏幕的资源，易用性的提升是毋庸置疑的。

不管怎么说，vi 只是一个 Bill 无意插柳柳成荫的结果，是他职业生涯中的一个副产品而已。在 1982 年初，Bill Joy 加入 Sun 公司之后，vi 就不怎么有人维护了。此外，由于没有得到 AT&T 授权的公司和个人也不能使用 vi 的源码（律师又一次发挥了威力），因此，大量的 vi 克隆版本纷纷出现。

目前大部分 Linux 发行版和 macOS 中的 vi 命令唤起的都是 Vim，一个由 Bram Moolenaar（布莱姆·穆勒纳尔）持续开发维护了三十多年的 vi 克隆（想想，三十年在计算机的发展中，那是经历了多少代技术的演进！）。在这些年里，其他的 vi 克隆诞生又死去，最后只剩下了 Vim（好吧，「只」是夸张手法）。起初，Vim 的意思是 Vi IMitation，但很快就成了 Vi IMproved。而这，就是我们这个课程的主题。

### 02. Vim 的优势

vi 有着一个非常老古董的设计，就是它是一个有「模式」的编辑器。其他大部分编辑器都相当于 vi 的插入模式，输入什么字符就会在屏幕上出现什么字符。但 vi 的行为不是如此。事实上，这种不那么直观的设计，即使在 vi 初次出现的 20 世纪 70 年代，也被认为是违反人机交互的原则的。所有的后续 vi 实现，包括 Vim，都继承了 vi 的模式设计。

令人惊讶的恐怕是，尽管有这些问题，Vim 在程序员群体中的流行程度并没有受到影响。根据 Stack Overflow 的开发者调查：2015 年程序员中最流行的编辑器是 Notepad++，Vim 的使用比例是 15.2%；2019 年最流行的开发环境变成了 Visual Studio Code，而 Vim 的使用比例还保持在了 25.4%。

这就是这门课程从头到尾都会试图回答的问题：Vim 到底好在哪里？

拿我自己来说，我刚开始使用 Vim 时，不是出于选择，而是在 Linux 上开发的需要。不过，用着用着我就喜欢上 Vim 了 —— 不仅在 Linux 下用，也在 Windows 下用（从十几年前开始，我就一直自己编译和维护着一个 Windows 下的最新 Vim 可执行文件）。自打切换到了 Mac 上之后，当然就更不用说，MacVim 是日常打开次数最多的工具。这里面最最主要的原因，就是使用 Vim 编辑文件非常高效。

在很大程度上，vi 的「高效」是一种历史性的设计要求，当年程序员需要在网速 300 波特（大致认为是今天网速的百万分之一吧）的环境里编辑文本文件。那个时代，人们还不可能拥有自己的计算机，大学、政府、公司里的计算机全都通过终端来进行分时共用。因此，vi 在命令上不得不非常「经济」。好玩的是，这种经济性，在今天仍然非常有用，它是 vi 及其克隆软件的高效之源。

我已经强调了几遍了，编辑的高效性，就是 Vim 最大的一个特点。除此之外，Vim 的优势还有很多，我来给你分享一下我认为最重要的三点。

第一，与 vi 最初只运行在 Unix 平台上不同，Vim 是一个完全跨平台的编辑器。它支持的第一个操作系统是 AmigaOS，然后被逐步移植到了大部分其他操作系统上，既有我们常见的 Unix/Linux、Windows、macOS，也有不常见或者过时的操作系统，如 OS/2、BeOS、OpenVMS，甚至在 iOS 和 Android 上也能找到 Vim 的移植版本。这可以算是 Vim 的一个重要优点了。这个课程里，我会介绍 Vim 在主流操作系统上的使用，包括 Linux、macOS 和 Windows。

第二，Vim 也是一个高度可定制、可扩展的编辑器。这对热爱折腾的程序员来说，绝对是一种乐趣，同时也是进一步提升效率的源泉。定制 Vim ，大部分情况下，你不需要什么特殊工具，使用 Vim 本身就可以。Vim 有自己的脚本语言，就叫 Vim 脚本（Vim script），语法相当简单，任何一个程序员应该都可以轻松地学会。配置文件和功能扩展都使用 Vim 脚本，使用统一的语法。同时，需要更强大的扩展能力还可以使用 Python、Perl、Ruby、Tcl 等其他通用的脚本语言，或者直接调用外部命令。你可以很容易打造一个你自己专属的开发环境，也很容易把这个环境从一台机器转移到另外一台机器上。

第三，作为一个发展了几十年的老牌开源软件，Vim 也有着良好的生态环境。网上可以找到大量的现成脚本和插件，能帮助你打造一个顺手的开发环境。总的来说，像语法检查、自动补全等程序员常用功能，全都可以在 Vim 里实现。你不需要离开 Vim，就可以完成从写代码、编译到运行的大部分工作。下面的这张图里，就展示了 Vim 的很多扩展一起工作的结果：

你可以看到，左边栏展示了 Vim 相对当前 Git 版本的修改状态（一处增，一处改），波浪线标出了代码中目前有错误的部分，底部显示了错误的原因，下面有个小窗口显示了光标所在处相对 Git 版本的变化，状态栏里更是密密麻麻地显示了编辑器模式、Git 分支、文件名、修改状态等信息。这里面用到了好几个扩展，包括颜色主题也是一个扩展。

虽然 Vim 最初是个针对字符界面的应用程序，但它也能支持主流的图形界面，包括 Windows 的图形界面，Linux 下的 GTK，以及 macOS 下的 Cocoa 和 Carbon，等等。作为一个并非「原教旨主义」的 Vim 用户，我个人是绝对赞成图形界面的使用的。因而我会推荐，只要有条件，就使用有图形界面的 Vim 版本。

不过，这个课程的绝大部分内容是对图形界面和文本界面都有效的（在两者有区别的地方，我则会明确指出）。换句话说，在你只能使用基于字符界面进行远程连接时，Vim 的功能仍然大部分有效，只是界面的美观程度会受一定的影响而已。也由于这个原因，Vim 在后端开发人员中特别受欢迎。

Vim 的模式是 Vim 的高效所在，但同时也是 Vim 学习上的一个难点。略有点搞笑的是，Stack Overflow 上有一个目前票数达到 3840 的问题是「如何退出 Vim 编辑器」，按问题票数排名可以进入前 100，这可能就是 Vim 的模式造成的困惑了。

反过来，这个反常规的设计使得 Vim 可以使用很逻辑的多个按键来处理文本，比如，在正常模式使用 daw 三个按键代表 delete a word 来删除光标下的一个完整单词，也可以输入：进入命令模式使用「make」这样的完整命令来进行项目的构建。

整体来说，Vim 会给你一个高效、跨平台、高定制性、易于扩展的开发环境。全面掌握 Vim 需要花费一定的时间进行学习。但这个时间不会白费，因为 Vim 可以在任何地方使用，它会成为你编程道路上一件称手的兵刃，让你成为更加高效的开发者。

### 03. 课程主要内容

比起很多「开箱即用」的编辑器，Vim 是有一定的学习曲线的。虽然学 Vim 比学编程容易多了，但对于非英语母语的人来说，Vim 又会难上一点点。我会尽量多讲原理，而不是枯燥地讲解命令。不得不讲命令的时候，我会使用图片和动画，让你能对相关内容有一个直观的理解。对于很多 Vim 的命令，我们是需要形成「肌肉记忆」的；我们不需要死记硬背，但需要多看、多练，熟能生巧，在学习过程中自然而然就掌握了使用 Vim 的技巧。

作为一个有历史的编辑器，Vim 一直保持着非常良好的向后兼容性。学 Vim 学到的东西不会过时，在你的程序员生涯中一直可以用下去。我个人的 Vim 配置文件始于约 20 年前，慢慢地添砖加瓦，一直用到了今天。同时，Vim 也一直在发展，虽然不快，却也从来没有停下来（从发布 8.0 版本算起，平均每天 3.7 个补丁吧）。

在这个课程中，我会基于目前最新的 Vim 8.2 来讲解 Vim 的功能。你将会学到：1）Vim 的安装。2）Vim 的模式和命令。3）Vim 的配置。4）Vim 的使用技巧。5）Vim 里的重要插件。6）及最最重要的，如何把 Vim 集成到你的工作流里，让它成为一件称手的工具，来进行高效的编辑。

### 04. 课程学习要求

我对这门课程的定位是零基础课，哪怕你以前没有用过 Vim ，也完全可以上手。这个课程不是 Vim 的百科全书，不会把 Vim 的所有命令选项，不管有用没用，全部都教给你。这是一个「新」教程，里面讲述的版本、很多技巧和插件是最近几年才有的，甚至是我在写专栏的时候才发现的。这也是一个面向实践者的教程，会让一个需要或想要使用 Vim 的开发者，从入门到精通，学会高效地使用 Vim 完成程序或其他文本文件的编辑。

虽然课程定位是零基础，但这并不意味着我对你没有任何要求。我仍然要求你在学习课程前：1）熟悉你使用的平台上的包管理器（yum、apt、brew 等；仅类 Unix 环境），知道如何完成程序的安装和卸载；2）安装了 Git，并对 Git 操作有基本的概念（不要求熟练掌握，因为我会给出大部分情况下需要的命令）；3）有一颗勇于探索的心，愿意花点力气把手里的「武器」打造得更为好用、称心。

使用 Vim 有不同的场景。在我设想的环境里，你是一个程序员，但我不对语言作出要求。课程的大部分内容完全是语言无关的，无论你使用什么编程语言开发，都应该可以获得有用的知识。不过，如果你使用 C、C++ 或 Python 进行开发，你可以得到一些额外的福利，因为这些是我主要使用的语言。这三个语言的额外重要性在于，Vim 的插件有可能会用到这三种语言。

### 黑板墙

完全用 vim 做开发工具有两年了，之前的很多年都只是用它来看日志。看过 《vim 实用技巧 》《the viml primer》《modern vim》。最后，还是看中文的收获最大（因为看的懂）。作者回复：嗯，是的，中文资料比英文资料还是缺了不少。2020-07-20

vim 是很强大，不过模式切换带来的中英文切换有点搞心态，有没有什么解决办法呢？作者回复：估计你是 Windows 上没有装一个纯英文的输入法？我是一定要装一个美国键盘用来写程序，而不是在中文输入法中用 Shift 来切换 —— 那很不可靠的。2020-07-24

macOS 终端有一个简易教程，终端输入 vimtutor 即可。作者回复：所有平台都有的。2020-07-21

Vim 有没有 JavaScript 或 Typescript 语言相关插件。前端程序员来报道。作者回复：https://github.com/neoclide/coc.nvim。2020-07-20

作者回复：这两本新一点：1）Neil, Drew. 2015. *Practical Vim*, 2nd ed. O’Reilly. 中文版：杨源、车文隆译《Vim 实用技巧》，人民邮电出版社，2014（第一版），2016（第二版）。2）Osipov, Ruslan. 2018. *Mastering Vim*. Packt. 中文版：王文涛译《Vim 8 文本处理实战》，人民邮电出版社，2020。2020-07-20

2『已下载书籍「2020154Vim实用技巧1Ed | 2020154Practical-Vim」，中文版目前只有第一版，可以先看英文的第二版，另外这本书排版给我的感觉很好；第二本书微信读书上有中文版，但稍微读了一些，感觉一般般，目前没有下载。』

挺喜欢用 vim 的，几个月前折腾了一下，比如整了一个 molokai 配色，剩下的都是高亮当前行、高亮当前列、显示 tab 和空格之类的小细节，前几天刚看完的正则表达式入门课也是在 vim 末行模式练习的，然后别的就不会什么了。作者回复：高亮当前行列有助于写，不有助于读。鉴于程序员读代码的时间通常比写长，我一般不用这样的设定。意见仅供参考。2020-07-20

一直没把 vim 用的很熟练，也是很遗憾，希望能在老师这里把 vim 发展成为我的主要编辑器，之前看到一个大佬用 vim 写笔记的，是真的厉害。作者回复：学习用好是对的。但不要把工具神圣化了。编程语言比编辑器重要，你做什么又比编程语言重要。2020-07-28

C 和 Python 程序员路过，期待老师 C 语言高效工作流中的最佳实践，以及如何一套配置玩转 C 和 python 两种语言的最佳实践。作者回复：嗯，C 和 Python 都是没问题的，我一直在用。2020-07-25

作为一个一直使用 vim 的重度用户来说，我是来支持一下老师的，我也是一个 vim 传播的使者！希望老师讲的更好！听的人越来越多！当你熟悉了 vim，就大半只脚加入了 Linux 的世界....shell，python，c 语言，都可以在 vim 下快速编辑...vim 不仅是编辑器，更是你操作 Linux 的入口之一。作者回复：对的。这也算是一个 Unix 传统工具了。2020-07-22

作者回复：嗯，批量、快速地改文本是 Vim 的强项。2020-07-22

最近准备搞 Java，以前弄过一次，用 VIM 写 Java 感觉好卡，也不知道是什么原因。作者回复：某个插件引起的吧？纯 Vim 本身、没有第三方插件的话，无论如何卡跟 Vim 是很难挂钩的。2020-07-21

作者回复：我会在课程里用 Git 跟踪配置文件的整体变化过程，跟课程结合，你基本上会知道每行做什么。2020-07-21

感觉 vim 对于 cpp 代码支持如何，有哪些好用的插件。作者回复：很好啊。后面我会讲的。主要是 YouCompleteMe，但安装和配置都不是一两句话都说清楚的。2020-07-21

## 0001导读Vim就是唯快不破.md

### 1.1 缘起

当时正值第一波互联网浪潮，我刚毕业不久，一如现在的热血青年，投身到互联网的大熔炉中。我所在的公司叫洪恩教育，公司里聚集了很多清华北大的同学，技术牛人扎堆，大家清一色使用 Vim 在服务器端编程，语法高亮都不设，内部 BBS 也是水木清华那种，通过终端访问，非常极客。走进办公室一眼望去，满目皆是黑漆漆的屏，绿瓦瓦的字，每个人都在那里噼噼啪啪地敲击键盘，韵律十足，我想，这简直酷毙了。

我最初还在使用 Editplus 编程，隶属菜鸟帮。别人的开发、编译和发布环境都在服务器端，而我则需要在本地编写好程序，通过 Editplus 的 ftp 功能上传到服务器端，再进行调试、测试和发布，不仅麻烦，而且不够酷。

那时候不酷是不行的，我这种行为遭到了小伙伴的无情嘲讽，于是我把愤怒都发泄在键盘上，每天在满天星斗的夜色中学习 Vim 技法，在清晨的微光中编译 Linux 内核，上午敲打键盘输出 Perl 程序，中午吃完五又四分之一口米饭之后开始研习 Vim 的多窗口和标签……

那时候我住在公司，时间充裕到让你不好意思不学习，虽然 Vim 资料匮乏，但我周边都是牛人啊，随时随地请教，不断练习，很快小有所成，编码时鼠标锁进抽屉，双手敲击键盘上下翻飞，成就感十足。我对语法高亮情有独钟，经常把自己的界面配置得花花绿绿，没事看看也是一件乐事。

自此以后，我就与 Vim 结下不解之缘，十几年过去了，工作中一直没有离开过 Vim，断断续续一直在用。到了 2009 年，我开始把工作环境完全切换到了 Mac 上，记得当时打开 Mac 的终端时，欣喜若狂地想，这不就是 Vim、Shell 和 IDE 的完美集成么？

### 1.2 场景

在不同的场景下应该采用最适合的工具，这时就会有人问了，Vim 适合什么场景呢？简单说来，Vim 比较适合 Unix/Linux 服务器端编程，如果你使用 Mac 电脑，Vim 是直接集成在你的终端环境中的，用起来十分方便。我以前用 Vim 主要用来进行 Shell/Python/C 编程。在 Unix/Linux 服务器端编辑和修改文件也离不开 Vim，另外由于我个人工作环境是 Mac，所以修改文本文件、Code Reiview、批量替换文件、比对文件等工作，用 Vim 顺手就做了。

写 Java 程序、前端 HTML/CSS/JS、Objective-C 和 Swift，最优方案依次是 IDEA、VS Code、XCode 等，这些优秀的工具可以帮助我们提升效率，减少错误，但是如果你还想更进一步，那么 Vim 绝对值得拥有。

### 1.3 历史

Vim 源于 vi，但不是 vi，vi 作为计算机的文本编辑器历史极为悠远，它是由美国计算机科学家比尔·乔伊编写并于 1976 年发布的，同年苹果公司成立。比尔·乔伊是 Sun 公司的联合创始人和首席科学家，一位传奇的技术天才，我个人以为他最伟大的贡献是独立编写 BSD 操作系统，开发 vi 编辑器，创立 Sun 公司，当然，他还是 Java 语言的主要贡献者之一，任何人有幸完成其中一项工作已经足以名垂计算机发展史，而乔伊则通过一己之力完成了这些科技成果，推动了整个计算机科技的发展。

Vim 诞生得要晚一些，它的第一个版本由布莱姆·米勒在 1991 年发布，这个兄弟也是一位声名显赫的程序员，80 年代买了一台 Amiga 电脑，打开电脑一看，米勒鼻子差点气歪了，居然没有他最常用的 vi 编辑器！对于米勒来说这是不可接受的。

愤怒的米勒决定自己开发一个文本编辑器，完全复制 vi 的功能，并起名为 Vi IMitation（模拟）。事实证明，优秀的程序员都具备这种品质，感到不爽了，就会写出个什么东西，要么完善一下，要么创新一下，要么是你写，要么是我写，于是很多伟大的软件程序就发明出来了。随着 Vim 的不断发展，更多更好的功能被加了进来，正式名称改成了 Vi IMproved（增强），也就形成了现代的 Vim，目前最新的稳定版本是 8.2，Vim 的开发语言是 C 和 VimScript。

### 1.4 理念

Vim 是一款完全面向程序员的软件，我很少见到用 Vim 编辑文字的普通用户，如果你是，一定要告诉我。写过程序的人都知道，编程的时候双手大部分时间都放在键盘上，或编码、或插入、或移动、或定位、或查找，这种连续操作的时间和频率远远大于阅读、翻页、设置字体、摆弄样式等文案工作，而二者往往产生很多停顿和间隙，而编程时的停顿是非常影响编程效率的，所以 Vim 的设计理念就是通过模式的转换、命令的组合和数以万计的插件，保证程序员在编程的过程中，双手尽可能保留在键盘中央的区域，并且，不需要鼠标。

想用好 Vim，先要理解 Vim 的模式转换。Vim 常用的模式有四种：1）普通模式：Vim 启动后的默认模式，用来移动光标、删除文本、覆盖输入文本、恢复操作、粘贴文本等等。2）插入模式：输入 i 或 a 进入插入模式，在这个模式下敲击键盘会往文字缓冲区增加文字，相当于普通编辑器的编辑模式。3）可视模式：选择文本，可以行选、块选和依次选择，选择后可以进行复制、删除、排序等操作。4）命令模式：执行内部和外部命令，通过「:」「/」「?」「:!」可以进入命令模式，分别对应的是：执行内部命令、向上或向下搜索、执行外部命令。

Vim 的模式和普通的编辑器有所不同，而且命令繁多千变万化，所以初期的学习曲线较高，一旦你坚持练习并且度过了最早的平台期，就会领略 Vim 的妙和全键盘的好。事实上 Vim 除了能够快速编辑文本文件之外，还能够通过简单的命令做更多的事情。

### 黑板墙

如果是 java 的话，是不是就只能使用 IDE 中的插件了。作者回复: Vim 能支持 Java 的。如果你要自动完成的话，YouCompleteMe 插件可以编译出相应的支持。2020-07-20

新手程序员，用 shell 在服务器开发，vim 确实快。自己安了几个花花绿绿的插件，本来还挺开心的。结果，某日和组长一起看问题，跟变量跳转几次就找不到了。被组长说水平不够，不会用就别用，老老实实的改用 source insight。作者回复：商业软件有商业软件的强项，也毋庸置疑。用来阅读，SI 总体不错，但我了解有下面的缺点（不知道最新版本是不是全解决了）：1）对 UTF-8 自动识别有问题。2）对现代 C++ 支持不够好。3）如果编码识别出问题，改文件极易导致所有非 ASCII 字符紊乱。直接编辑不够高效我就不用提了吧。2020-07-25

Emacs 是一个伪装成编辑器的操作系统。不论是 Arch, Ubuntu, CentOS 还是 MacOS，他们都是我 Emacs 的加载系统。作者回复：哈哈，唯一的问题是编辑器不咋地，所以需要 evil 模式。2020-07-22

在使用 vim 之前，我也是用的 editplus。它需要通过 ftp 把文件下载回来和把修改上传上去，文件大了传输耗时就很长。在准备购买 mac，使用 mosh 时，才下定决心完全使用 vim 做开发。作者回复：哈哈，我最早用的也是 EditPlus。这东西现在应该没了吧？2020-07-20

## 0101各平台下的Vim安装方法.md

今天我们讨论了 Vim 在常见平台上的安装过程。顺便说一句，以后在牵涉到环境问题时，我一般也会以上面提到的几种典型情况为例来进行讲解：1）Linux（CentOS 和 Ubuntu）。2）macOS。3）Windows。你可能看着多个平台的安装过程有点晕，这却是我的实际使用环境了 —— 我就是在各个平台下都安装、配置、使用着 Vim 的，这也就是 Vim 的全平台、跨平台优势了。

当然，必须得承认，Vim 还是最适合类 Unix 环境，它的生态系统也是在类 Unix 环境下最好。鉴于在 Windows 下已经越来越容易接触到类 Unix 环境（像 Git Bash、Docker 和 Windows Subsystem for Linux），服务器开发上 Linux 也已经成了主流，在 Windows 上熟悉 Vim 的完整环境对你也应该是件好事 —— 尤其如果你是做服务器或嵌入式开发的话。

Vim 在 Linux 和 macOS 上一般是默认安装的，在 Windows 上不是。不过 Vim 的网站上提供了 Windows 下的安装包，自己安装也很容易。所以，今天的课程我不会手把手、一步步地讲，而是挑选一些重点。对于默认安装的情况，主要讨论的是版本老旧或功能不全的问题。对于其他情况，我则会给出一个基本指引，减少你走弯路的可能性。

### 1.1 Linux 下的安装

#### 1.1.1 Red Hat 和 CentOS 系列

在 Red Hat Linux 和 CentOS Linux 上，默认安装的 Vim 可能是一个最小功能的版本。虽然这个版本启动速度很快，但它缺少了很多对开发有用的功能，如语法加亮、Python 集成和图形界面。一般情况下，应至少安装更全功能版本的 Vim；如果能使用 X Window 的话，则应安装图形界面版本。

你可以通过下面的命令来查看已经安装的 Vim 版本：

```c
yum list installed | grep vim
```

如果输出只有下面这样的内容的话，就说明安装的 Vim 版本只有基本功能：

```c
vim-minimal.x86_64 2:8.0.1763-13.el8 @System
```

此时，我建议使用 sudo yum install vim-X11 来安装图形界面的 Vim，或至少使用 sudo yum install vim-enhanced 来安装增强版本的 Vim（如果你不在这台机器上进行图形界面登录的话）。

只要你使用图形界面，一般而言，你都应该安装有图形界面支持的 Vim。总体而言，图形界面 Vim 的功能更丰富，并且即使你只在终端里使用 Vim，含图形界面支持的 Vim 会带剪贴板支持，跟整个图形环境的交互也就比较容易。当然，如果你只是远程通过 SSH 使用 Vim 的话，那确实图形界面支持就没有意义了。

#### 1.1.2 Debian 和 Ubuntu 系列

在 Debian、Ubuntu 等使用 apt 的 Linux 发行版上，Vim 同样有着不同功能版本的区别，而且选择更多。我们可能会看到：

```c
vim
vim-athena
vim-gnome
vim-gtk
vim-gtk3
vim-nox
vim-tiny
```

它们中有编译进最小功能的 Vim 包（vim-tiny），有较全功能的文本界面 Vim 包（vim-nox），有适用于老的 X-Window 界面的版本（vim-athena），有适用于 KDE 环境的 GTK2 版本（vim-gtk），等等。

如果你不确定要装什么版本的话，那可以遵循我下面的建议：1）如果你使用标准的 GNOME 桌面环境的话（大部分的情况），安装 vim-gtk3 或 vim-gnome。2）如果你使用 KDE 桌面的话，安装 vim-gtk。3）如果你只使用文本界面的话，安装 vim-nox。4）都不是？那你是个爱自己定制的家伙，也就不需要我告诉你该安装什么了。

你可以通过下面的命令来查看已经安装的 Vim 版本：

```c
apt list --installed | grep vim
```

我们先执行 sudo apt update 来确保更新环境，然后使用 sudo apt install vim-gtk3 安装 GTK3 版本的 Vim（或者其他你需要的版本）。如果你安装了图形界面的版本，不必单独再另外安装其他版本的 Vim，因为图形版本的 Vim 也是可以纯文本启动的。事实上，在 Ubuntu 上，vim 和 gvim 都是指向同一个应用程序的符号链接，且 gvim 的执行效果和 vim -g 相同。

```
在终端中运行 vim.gtk3，执行 :version
```

#### 1.1.3 手工编译

如果你用的 Linux 发行版较老的话，你可能会希望手工编译 Vim 来得到最新的版本。此时需要注意的是，Vim 有很多的编译配置选项，有些缺省是不打开的。对于这个课程来讲，我们会希望至少加上 Python 支持和图形界面支持。你首先需要确保自己已经安装了所需的开发包（可以参考这个网上的回答：[linux - Compile gvim from sources? - Super User](https://superuser.com/questions/288206/compile-gvim-from-sources/749760#749760)）。然后，我们可以使用下面的命令来配置 Vim 和编译（根据需要，「auto」也可以替换成「gtk3」等其他需要的数值）：

```c
./configure --enable-pythoninterp \
            --enable-python3interp \
            --enable-gui=auto
make -j
sudo make install
```

如果上述步骤正常没有出错，Vim 就被成功安装到 /usr/local 下了。你可以用 which vim 来检查系统是否会自动优先选择你的 vim：如果不是的话，你可能需要调整 PATH 里的顺序，或者设置别名来优先启动 /usr/local/bin/vim）。然后，你可以使用 vim --version 命令来输出 vim 的版本信息。我们希望能在输出里看到：

```c
Huge version with … GUI
+python/dyn
+python3/dyn
```

目前 Python 2 已经停止支持，所以你最好可以确保上面的输出中包含「+python3」（很多 Vim 的插件已经开始要求 Python 3、不再支持 Python 2 了）；没有「+python」（即 Python 2）则没什么关系（有没有「dyn」关系也不大）。好了，关于 Linux 环境下的 Vim 安装和配置要点我们就讲完了，接下来继续看在 macOS 上如何安装。

### 1.2 macOS 下的安装

在 macOS 中一般已经内置了 vim，并提供了除图形界面外的较完整功能集。如果你希望使用图形界面，则需要自行安装 MacVim，一个跟现代 macOS 融合较好的独立 Vim 版本。安装 MacVim 有两种常用方式：1）使用 Homebrew。我推荐你使用这种方式，这样的话，以后升级也会比较容易。2）使用 MacVim 的独立安装包。如果你之前没有在用 Homebrew 的话，或处于不方便使用 Homebrew 的网络环境中，这种方式也可以。由于使用 Homebrew 已经足够简单，日后升级也非常方便，我个人觉得我们没必要自己去编译 MacVim。

#### 1.2.1 使用 Homebrew 安装 MacVim

首先，如果你没有 Homebrew，那你需要先安装 Homebrew。安装信息可以在 Homebrew 的主页上找到（这个网站是支持中文的）。在安装了 Homebrew 之后，一般情况下，你需要修改你的 .bash\_profile（如果使用 Bash 的话）、.zprofile（如果使用 Zsh 的话）或是相应的 shell 的配置文件，调整 PATH，把 /usr/local/bin 放到 /usr/bin 前面。我个人在 .bash_profile 里是这样配置的：

```c
if [[ $PATH != "$HOME/bin"* ]]; then
  PATH=~/bin:/usr/local/bin:/usr/local/sbin:`echo $PATH|sed -e "s!:$HOME/bin!!" -e 's!:/usr/local/bin!!'`
fi
```

这样，可以确保个人的路径优先于 /usr/local，而 /usr/local 下的路径又优先于系统的路径。

1『果然，之前就意识到 shell 脚本也是一种语言，上面的配置语法验证了自己的看法。』

如果你这样配置的话，那只要执行 brew install macvim，然后在等待安装完成之后，你用 vim 启动的就是 MacVim 了。缺省用 vim 运行的仍然是纯文本界面的 Vim，但跟 Linux 一样，你可以用 vim -g 或 gvim（还有仅用在 Mac 上的 mvim）来启动 Vim 的图形界面。

1『

大赞啊，以后在 shell 里可以直接用 macvim 打开文件了，哈哈。

```c
gvim .vimrc

// 或者
vim .vimrc -g
```

』

跟 Homebrew 里的其他软件一样，你以后要升级 MacVim 的话，只需要输入命令 brew upgrade macvim 即可。是不是很简单？这就是为什么我比较推荐这种安装方式，后期升级真的更容易。不过我下面还是会介绍下安装包的方式，以满足我们不同的应用需求。

#### 1.2.2 使用安装包安装 MacVim

跟大部分的 Mac 软件一样，你也可以直接使用 DMG 安装包来安装 MacVim。目前可从以下网址下载 MacVim 的安装包：https://github.com/macvim-dev/macvim/releases

等待下载完成后，双击下载的文件，然后会打开一个访达（Finder）窗口。你只需要把 MacVim 拖拽复制到应用程序文件夹即可。

在这种安装方式下，手工键入 vim、gvim 或 mvim 命令是无法启动 MacVim 的。你需要手工创建这些命令的符号链接（symlink）或别名（alias）才行。假设你的 MacVim 是直接安装在应用程序文件夹里的话，这些命令本身可以在 /Applications/MacVim.app/Contents/bin 文件夹里找到；使用下面的命令可以在你自己的 bin 目录下创建这些命令的符号链接：

```c
[ -d ~/bin ] || mkdir ~/bin
ln -s /Applications/MacVim.app/Contents/bin/* ~/bin/
```

### 1.3 Windows 下的安装

最后，我们来看在 Windows 下怎么安装。课程开头我提到了，Windows 上缺省是没有 Vim 的。我们可以从 Vim 的网站下载 Windows 下的安装包：https://www.vim.org/download.php#pc

在 Linux 和 macOS 上，64 位应用程序已经成为主流。而与此不同的是，在 64 位 Windows 上，32 位应用程序仍然很常见。默认的 Vim 8 的安装包安装的仍然是一个 32 位的应用程序。不过，32 位的 Vim 也足够满足一般需求了，除非你需要编辑 2 GB 以上的大文件。

安装界面会有一个选择组件的步骤，如下图所示：

这个界面中，下面几项我们可以关注一下：1）「安装批处理文件」（Create .bat files）：对于用 Vim 的开发者来说，通常命令行是刚需，所以我们一般需要勾上这项。2）「创建图标」（Create icons for Vim）：根据你自己的需要进行选择，通常我会去掉展开子项里的「桌面图标」（On the Desktop），不在桌面上创建 Vim 的图标。3）「创建默认配置文件」（Create Default Config）：去掉这项 —— 我们马上会创建配置文件。4）「安装多语言支持」（Native Language Support）：这项功能使得 Vim 的菜单可以显示中文的命令，但实际上还是有点鸡肋，因为 Vim 的主要功能不是靠菜单驱动的，安装程序安装的帮助文件也只有英文版。所以，这项选和不选关系不大，你可以自由选择。

然后我们点「下一步」（Next），不需要修改安装目标文件夹，完成安装即可。完成安装后，Vim 会缺省打开一个 README 文件。在这个窗口中，我们应当键入「:e ~\_vimrc」，回车键，然后把下面的内容粘贴进去（这些配置项的意义我们以后会讨论）：

```c
set enc=utf-8
set nocompatible
source $VIMRUNTIME/vimrc_example.vim
```

然后键入「ZZ」（大写）存盘退出即可。

注意由于历史上的文件系统限制，在 Windows 下 Vim 的配置文件名称是 \_vimrc 而不是 .vimrc（虽然 Windows 命令行不支持像 Unix 一样用「~」代表用户的主目录，在 Vim 里我们仍然可以使用「~\_vimrc」或「~/_vimrc」这样的写法）。这是 Unix 和 Windows 下的 Vim 配置的区别之一。其他的主要区别是以下两点：1）点打头的 Vim 文件都成了「\_」打头，如 .viminfo 也成了 \_viminfo。2）点打头的 Vim 配置目录 .vim 在 Windows 下则成了 vimfiles。

除此之外，Vim 的配置在 Windows 下和 Unix 下（如 Linux 和 macOS）并没有根本不同。Windows 上的主要麻烦在于，由于 Vim 的生态主要在 Unix 上，某些 Vim 的插件在 Windows 上安装配置需要花费更大的力气。但就一般的文本和程序编辑而言，Vim 在 Windows 下和 Linux 下没有本质的不同。甚至 Windows 下还有一个小小的优势：Unix 下虽然 Vim 可以编译成支持 Python 2 和 Python 3，但在 Vim 里一旦执行了 Python 2 的代码，就不能再执行 Python 3 的代码了；反之亦然。Windows 下则没有这个限制。

有没有注意到我只在 Windows 的安装部分讨论了配置？这是因为 Unix 下主流的缺省编码已经是 UTF-8 了，而 Vim 只能在内码是 UTF-8 的情况下才能处理多语言的文本。而我们有自己的配置文件，是为了确保启用一些最为基本的配置选项，来保证基本行为的一致性。

Windows 上可以把 Vim 配置成跟普通的编辑器行为差不多，包括支持 Ctrl-A 全选，选择内容后输入任何内容替换选择的内容，等等。但是，这种行为跟 Vim 的标准行为是冲突的。我们要学习 Vim，还是忘了这些 Windows 特有的功能为好，去学习掌握 Vim 的跨平台标准功能。上面的配置文件也同样没有启用 Windows 下的特有行为。

#### 1.3.1 Cygwin/MSYS2

Windows 有 Cygwin 和 MSYS2，可以提供类似于 Linux 的 POSIX shell。在这些环境里，Vim 都是标准组件，按这些环境的标准方式来安装 Vim 就行。如果你使用 Git Bash 的话，里面就直接包含了 MSYS2 的终端、Bash 和 Vim。唯一需要提一句的是，这些类 POSIX 环境里面的 Vim 配置应当参照 Linux 终端来，而不是 Windows 下的标准方式（也就是说，个人配置目录和配置文件是 .vim 和 .vimrc，而非 vimfiles 和 \_vimrc）。我以后对这种情况就不再单独描述了。

#### 1.3.2 远程使用 Vim

还有一种常用的环境恐怕是使用 mintty、PuTTY、SecureCRT 之类的软件在 Windows 上远程连接到 Linux 机器上。在这种情况下，需要特别注意的，是远程终端软件的远程字符集（如 PuTTY 中的「Windows> Translation > Remote character set」）应当设置成 UTF-8。这个设定跟具体的软件及其版本有关，我就不详细说明了；请自行查看你所使用的远程终端软件的设定和相关文档。

### 1.4 学习 Vim

上面我们讲解了 Vim 的安装。如果安装过程中遇到了什么问题，可以留言提问。接下来，我会给你提供一些 Vim 的学习资料，帮助你进入 Vim 的世界。你应该仔细看一下你所使用的平台上的 Vim 安装信息（其他平台的可以略过），并且应该自己打开 Vim 教程练习一遍（除非这些基础知识你都了解了）。键盘配置相关信息属于可选，可以根据自己的兴趣和需要决定是否了解一下。

#### 1.4.1 中文帮助文件

Vim 内置了完整的英文帮助文件。如果你想要中文帮助文件的话，有个好消息是，有网友同步翻译了最新的帮助文件，而且安装过程在 Vim 8 （或将来的版本）里是非常简单的。以 Unix 下为例（Windows 下类似，但路径 .vim 需要修改为 vimfiles）：

```
cd ~/.vim
mkdir -p pack/my/start
git clone https://github.com/yianwillis/vimcdoc.git pack/my/start/vimcdoc
```

如果你不需要以后利用 Git 来快速升级文档的话，也可以在这个 Vim 中文文档计划的下载页面下载 tar 包，然后自行解压到 ～/.vim/pack/my/start 目录下（或 Windows 用户目录下的 vimfiles\pack\my\start 目录下）。Windows 用户有一个简单的安装程序（当前为 vimcdoc-2.3.0-setup-unicode.exe），可以自动帮你完成中文帮助文件的安装任务。如果你的机器上没有 git 和 tar 可执行程序的话，那这个方式最简单。

3『 [Vim 中文文档计划](https://github.com/yianwillis/vimcdoc)』

#### 1.4.2 Vim 教程

Vim 在安装中自带了一个教程，可供快速入手使用。如果你对 Vim 的基本操作不熟的话，建议你完整学习一下，我也就不必多费笔墨介绍一些最基础的用法了。Vim 教程支持多语言，可使用命令 vimtutor 来启动。如果启动的教程的语言不是你希望的，你可以使用环境变量 LANG 来设定希望的语言。比如，下面的命令可以在 Unix 环境中启动一个中文的 Vim 教程：

```
LANG=zh_CN.UTF-8 vimtutor
```

Windows 下你可以在开始菜单里找到 Vim tutor。但我测试下来它有一个问题。虽然我提交的解决方法已经作为补丁（8.2.0412）合并，但目前（Vim 8.2）安装程序安装的文件多半仍然是有问题的，你会无法成功地创建一个 tutor 文件的副本供编辑使用。我建议手工创建一个这个教程的副本。可以在命令提示符下输入：

```
vim --clean -c "e $VIMRUNTIME/tutor/tutor.zh_cn.utf-8" -c "w! TUTORCOPY" -c "q"
```

这样即可在当前目录下创建一个教程的副本。然后我们可以用 gvim TUTORCOPY 来打开这个副本进行学习。

#### 1.4.3 键盘重配置

最后，有些重度的 Vim 用户会重新配置键盘，把使用频度较低的大写锁定键（Caps Lock）重新映射成 Esc 或 Ctrl 键。对于这个问题，如果你需要的话，网上很容易就能找到攻略，如：1）[Linux 下将大写锁定键键映射为 Ctrl 键](https://blog.csdn.net/daerzei/article/details/89414610)。2）[mac book 更改 caps lock 键为 esc/ctrl 键](https://blog.csdn.net/tbestcc/article/details/52287622)。3）[windows 交换大写锁定键与 ESC 键](https://blog.csdn.net/P_LarT/article/details/72829425)。4）[在任何操作系统上，如何禁用或者重新分配 Caps Lock 键](https://www.kutu66.com/Mac/article_11233)

这当然是一件非常个人化的事情，而且有一个风险，你一旦跑到别人的机器上操作，你的「肌肉记忆」可能会让你常常按错键。鉴于你目前可能只是个 Vim 的初学者，现在不一定需要这么去做。等到你觉得按 Esc 太麻烦了，再想起这个可能性去修改键盘配置也来得及。

### 黑板墙

作者回复：看不懂你的问题。Vim 加载文件是有规则的（:help initialization），不会随意加载 .vim 目录下的文件。.vimrc 习惯上放用户配置的、可能更改的信息。plugin 目录下的 .vim 脚本是会执行的，放特定（通用）功能相关的代码。从电脑的角度，放哪儿只有执行顺序的差别。该放哪里，则是人组织代码的约定。2020-07-20

内网环境，有没有离线装插件的好方法？作者回复：很简单的，其他机器上装好，把 pack 下的相关目录复制过去就行。如果没有原生代码，机器平台不一样都没问题。2020-07-21

大小写锁定键不推荐更换为 ESC，因为 Ctrl+[ 就是 ESC 键的效果。在自定义的组合键中，Ctrl 和 Leader 健是使用非常频繁的。也有神人把连按两次大小写锁定键替换为 Esc，理论上是可行的，但我没这么干。作者回复：大写锁定键重映射还是可以的，因为熟手应该不需要这个功能吧？我输大写从来是用 Shift 键的……2020-07-20

1『涨了 2 个知识，哈哈：1）输入大写直接按住 shift 再加字母。2）用 ctrl + [ 组合可以替代 esc。』

请问在 VS Code 下使用 Vim 插件和直接使用 Vim 比起来怎么样？推荐这种方式吗？作者回复：按键差不多，但你就是用 VS Code 的插件而不是 Vim 的插件了。我还是有不少需要使用的 Vim 插件。不过这个就因人而异了。2020-07-20

1『问出了我想问的问题。』

通过 putty 这类工具 ssh 到服务器，然后通过 vim 打开文件，使用的 vim 都是服务器配置的 vim，但是由于无法获取 sudo 权限，导致在 home 目录下定制自己的 vim 遇到好多困难，依赖太多的库，最终放弃。老师是否可以提供一个教程，针对无 sudo 权限在用户目录下安装自己的 vim。作者回复：为什么要 sudo？配置文件是 ～/.vimrc，配置目录是 ～/.vim，都是你自己的目录下。如果是安装新版，./configure 时加上 --prefix=\$HOME，单给你自己安装就行。2020-07-21

Mac 执行 vim --version 会列出 vim 支持的功能，有的前面有 + 有的是 -，现在想安装某个缺失的功能应该怎么去做的？ 比如要支持 python3（Mac 自带的 vim）。作者回复：只能从源代码重新编译，或找别人编译好的。Homebrew 里的 macvim 有 python3 支持的。系统内置的可能没有。2020-07-20

将一个窗口 vim 内的内容复制到另外一个窗口给我造成了很大的困扰。看了各种回答我也没搞懂 + 寄存器到底怎么用。希望老师能给个解决，让系统剪切板脱离鼠标！作者回复：不同进程的终端 Vim？那你脱离不了鼠标。图形界面的 Vim 一般支持系统剪贴板，终端 Vim 一般只能在同一进程里分享信息。如果你跑 Linux 桌面的话，可以试试在终端里运行支持图形界面的 Vim，一般是编译进剪贴板支持的。2020-07-20

请问，我的 macvim 配置和 neovim 配置光标游走都会出现卡顿现象，如何诊断原因和解决问题？作者回复：先试试无插件运行是不是有问题 vim -u NONE。如果能解决问题，二分法来逐步引入 / 去掉你的插件和 vimrc 中设置，直到找到问题原因。2020-07-20

感谢老师的中文帮助文档，对我帮助很大，英文文档真的看不进去。之前学习正则有些功能不知道在 vim 里怎么用，也在文档里找到了，甚至有一些和 Perl 正则的语法对比。今天也重新试着安装了一下 YCM，终于成功了，以前试过两次都失败了。感觉最近比较顺，期待后续课程。2020-07-22

工作中，服务器通常是没有装 window 图形界面的，开发环境也是 securityCRT 或 xshell 等方式连接后进行。vim 通过源码安装 gui 支持选项配的是 auto，安装后查看版本结果是 Huge version without GUI。请问老师这个结果是对的吗？再请问支持图形界面和不支持图形界面，主要差别在哪些重要的功能呢？能先简单举例一下吗？作者回复：如果你远程连接，那图形界面界面总是没有用的 —— 除非你本机起 X server。最主要的区别是图形界面多了字体、图标、按钮、剪贴板等图形界面支持，颜色经常也更好。少量特殊 Vim 功能，如 server，一般也只放图形界面版本里。2020-07-22

YouCompleteMe，在 vimrc 里 plug（VimPlug）一个插件（a.vim），然后 vimrc 里 unmap 该插件的快捷键无效。但是启动后，手动 :unmap 可以去掉。是因为插件的 vim 脚本是后于 vimrc 执行吗？作者回复：是这样。可以在 :help initialization 看 Vim 的初始化顺序。2020-07-21

## 0102基本概念和基础命令.md

今天我给出了一张键盘图，带你复习了 Vim 教程的内容，这里我要再强调一遍，这部分的内容如果你还有不熟悉的，一定要再去学习一下 Vim 教程，这段时间我们一定要多花点时间和精力来练习，把这一步跨过去。掌握了 Vim 教程里的基础信息还远远不够，我们还得了解 Vim 的四种主要模式，你只要记住最重要的就是正常模式就可以了。最后我带你学习了 Vim 的几个基本配置选项，包括对撤销、鼠标、中文和字体的支持，来满足最基本的编辑需要。最终的 Vim 配置文件可以在 GitHub 上找到：[geek_time_vim: Vim configuration for Geek Time](https://github.com/adah1972/geek_time_vim)。

关于这个配置文件，我这里做个备注说明：主（master）分支可以用在类 Unix 平台上，windows 分支则用在 Windows 上。适用于今天这一讲的内容标签是 l2-unix 和 l2-windows：你可以用 git checkout l2-unix 或 git checkout l2-windows 来得到相应平台对应本讲的配置文件。

### 2.1 Vim 教程的内容概要

上节课我给你留的作业，就是花时间学习一下 Vim 教程，下面我们就来检验一下。只有你自己先对照着教程操作了一遍，今天我再带着你过一遍里面的基本概念和配置，你才能查漏补缺，发现自己遇到的问题，明确自己需要多加练习的地方。

好，现在请查看下面的键盘图。简单说明一下，这张图上展示了一个键盘。图中的「·」表示，单个字母不是完整的命令，必须再有进一步的输入。比如，单个「g」没有意义，而「gg」表示跳转到文件开头。（对于命令后面明确跟一个动作的，如「c」，我们不使用「·」。）一个键最多有三排内容：最底下是直接按键的结果，中间是按下 Shift 的结果（变大写），上面偏右的小字是按下 Ctrl 的结果。我们还用了一些特殊符号来表示操作的位置，如果你已经了解了这些命令的功能，你也自然就明白它们的意义了。

请检查一下有颜色的那些键，看看你是否有任何不熟悉的地方。如果看下来有让你感到陌生的内容，请复习 Vim 教程。

这张图里没有写出 Vim 的命令行命令。你现在应该已经掌握了以下这些：1）「:q!」：退出 Vim。2）「:wq」：存盘退出。3）「:s」：执行替换。4）「:!」：执行外部命令。5）「:edit」（一般缩写为「:e」）：编辑文件。6）「:w」：写文件。7）「:r」：读文件。8）「:help」：查看帮助。9）使用键 Ctrl-D 和 Tab 来进行命令行补全。

同样，如果你发现上面列举的命令有你不熟悉的，也请重新打开 Vim 教程复习一下 —— 这些属于 Vim 的最基本功能，一定要能熟练运用才行。

### 2.2 Vim 的模式

接下来我们进入本讲的正题，讲述 Vim 的四种主要模式、键描述的体例和 Vim 需要的基本配置选项。掌握了这些内容之后，我们就能应对基本的编辑任务了。下面我们一一来看。

Vim 最特别的地方就是它的模式了。与其他大部分编辑器不同，进入 Vim 后，缺省状态下键入的字符并不会插入到所编辑的文件之中。Vim 的模式（mode，可以简单地理解为「状态」）是它的麻烦所在，但同时也是它的威力所在。

我们需要知道，Vim 有以下四种主要模式：1）正常（normal）模式（也称为普通模式），缺省的编辑模式；如果不加特殊说明，一般提到的命令都直接在正常模式下输入；在任何其他模式中，都可以通过键盘上的 Esc 键回到正常模式。2）插入（insert）模式，输入文本时使用；比如在正常模式下键入 i（insert）或 a（append）即可进入插入模式。3）可视（visual）模式，用于选定文本块；教程中已经提到可以用键 v（小写）来按字符选定，Vim 里也提供其他不同的选定方法，包括按行和按列块。4）命令行（command-line）模式，用于执行较长、较复杂的命令；在正常模式下键入冒号（:）即可进入该模式；使用斜杠（/）和问号（?）开始搜索也算作命令行模式。命令行模式下的命令要输入回车键（Enter）才算完成。

此外，Vim 也有个选择（select）模式，与普通的 Windows 编辑器行为较为接近，选择内容后再输入任何内容，将会替换选择的内容。在以可视模式和选择模式之一选定文本块之后，可以使用 Ctrl-G 切换到另一模式。这个模式主要是为了模拟 Windows 编辑器的行为，并不是 Vim 的主要用法，使用它反而会给 Vim 里的自动化带来麻烦，所以我们也就不多作介绍了。

关于 Vim 的模式，我们重点掌握正常模式就可以了，刚刚也说过，Vim 里的大部分操作会在正常模式下完成。如果你做编辑工作时有超过几秒的停顿，就应当考虑按下 Esc 键，回到正常模式。记住，正常模式就是正常情况下你应当处于的模式。

### 2.3 Vim 的键描述体例

清楚了 Vim 模式之后，我们来对 Vim 里的按键作一下清晰的体例描述，毕竟，Vim 里的键真的有点多。从现在开始，我会使用 Vim 里的标准键描述方式来讲解。根据 Vim 的一般习惯，我们使用尖括号来描述特殊的输入序列。下面我会提供一个列表，给出常用键的表示方式及在动图中的显示方式。这部分内容不需要记住，你用的时候作为参考就行。

```c
<Esc> 表示 Esc 键；显示为「⎋」

<CR> 表示回车键；显示为「↩」

<Space> 表示空格键；显示为「␣」

<Tab> 表示 Tab 键；显示为「⇥」

<BS> 表示退格键；显示为「⌫」

<Del> 表示删除键；显示为「⌦」

<lt> 表示 <键；显示为「<」

<Up> 表示光标上移键；显示为「⇡」

<Down> 表示光标下移键；显示为「⇣」

<Left> 表示光标左移键；显示为「⇠」

<Right> 表示光标右移键；显示为「⇢」

<PageUp> 表示 Page Up 键；显示为「⇞」

<PageDown> 表示 Page Down 键；显示为「⇟」

<Home> 表示 Home 键；显示为「↖」

<End> 表示 End 键；显示为「↘」

<F1> - <F12> 表示功能键 1 到 12；显示为「F1」到「F12」

<S-…> Shift 组合键；显示为「⇧」（较少使用，因为我们需要写！而不是 <S-1>；和特殊键组合时仍然有用）

<C-…> Control 组合键；显示为「⌃」

<M-…> Alt 组合键；显示为「⌥」（对于大部分用户，它的原始键名 Meta 应该只具有历史意义）

<D-…> Command 组合键；显示为「⌘」（Mac 键盘）
```

现在回到前面的模式部分，我们提到的 Esc、Enter、v、V 和 Ctrl-V，按我们现在的描述惯例，以后就会写成 \<Esc>、\<CR>、v、V 和 \<C-V>。这也是以后在 Vim 里对键进行重映射的写法 —— 如果你还不了解重映射是什么也没关系，我们很快就会讨论到。

这里我要强调一下，对「<」的特殊解释仅在描述输入时生效。在描述命令行和代码时，我们写「\<CR>」仍表示四个字符，而非回车键。特别是，如果我们描述的命令行首是「:」，表示这是一个输入：开始的 Vim 命令行模式命令（以回车键结束）；如果行首是「/」或「?」，表示这是一个输入 / 或？开始的搜索命令（以回车键结束）；如果行首是「\$」，表示这是一个在 shell 命令行上输入的命令（以回车键结束），「\$」（和后面的空格）不是命令的一部分，通常后续行也不是命令的一部分，除非行尾有「\」或「^」字符，或行首有「\$」字符。

也就是说，下面的命令是在 Vim 里输入「:set ft?<CR>」（用来显示当前编辑文件的文件类型）：

```
:set ft?
```

### 2.4 Vim 命令示例

下面的命令则是在 shell 里输入「which vim<CR>」（用来检查 vim 命令的位置）：

```
$ which vim

/usr/bin/vim
```

此外，当我用「:help」描述帮助命令时，你不仅可以在 Vim 里输入这个命令来得到帮助，也可以点击这个帮助的链接，直接在线查看相应的中文帮助页面。这节内容不需要死记。建议使用「收藏」功能，这样，你可以在以后碰到不认识的符号标记的时候，返回来查看这一节的内容。

### 2.5 Vim 的选项和配置

了解了 Vim 模式和键描述，我们对 Vim 的认识又多了一些，第一步的学习成就达成。要想更好地使用 Vim，下一个关键点就是配置了，接下来我就带你看看 Vim 配置都有哪些需要注意的点。

作为一个可以越用越顺手的应用程序，Vim 是需要配置的。我们才刚开始学习，所以目前我们的配置文件是相当简单的，但随着课程的进展和你使用 Vim 越来越多，你的 Vim 配置文件必然会越变越复杂。我们今天就先来做一些初步的讨论，看看能实际使用的一个最基本 Vim 配置文件是什么样子。

我们上节课已经讨论过，根据 Unix 下的惯例，Vim 的配置文件放在用户的主目录下，文件名通常是 .vimrc；而它在 Windows 下名字是 \_vimrc。我们前面给出最基本的配置文件是这个样子的：

```c
set enc=utf-8
set nocompatible
source $VIMRUNTIME/vimrc_example.vim
```

如果你熟悉 shell 语法，你肯定能看到不少熟悉的影子在里面。这三行完成了下列功能：1）设置编辑文件的内码是 UTF-8（非所有平台缺省，但为编辑多语言文件所必需）。2）设置 Vim 不需要和 vi 兼容（仅为万一起见，目前大部分情况下这是缺省情况）。3）导入 Vim 的示例配置（这会打开一些有用的选项，如语法加亮、搜索加亮、命令历史、记住上次的文件位置，等等）。

对于现代 Unix 系统上的 Vim 8，实际上只需要最后一句就足够了。对于现代 Windows 系统上的 Vim 8，中间的这句 set nocompatible 也可以删除。如果你在较老的 Vim 版本上进行配置，那么把这三行全放进去会比较安全。接下来，我会讲一些基本的配置项，保证你的日常工作流顺畅。它们是：备份和跨会话撤销、鼠标支持、中文支持及图形界面的字体支持。除了字体支持主要牵涉到美观性，其他三项都是对编辑至关重要的基本功能。我们一一来看。

#### 2.5.1 备份和撤销文件

上面的基本设置会产生一个有人喜欢、但也有很多人感到困惑的结果：你修改文件时会出现结尾为「\~」的文件，有文件名后面直接加「\~」的，还有前面加「.」后面加「.un~」的。这是因为在示例配置里，Vim 自动设置了下面两个选项：

```
set backup
set undofile
```

前一个选项使得我们每次编辑会保留上一次的备份文件，后一个选项使得 Vim 在重新打开一个文件时，仍然能够撤销之前的编辑（undo），这就会产生一个保留编辑历史的「撤销文件」（undofile）了。

我的通常做法是，不产生备份文件，但保留跨会话撤销编辑的能力；因为有了撤销文件，备份其实也就没有必要了。同时，把撤销文件放在用户个人的特定目录下，既保证了安全，又免去了其他目录下出现不必要文件的麻烦。

要达到这个目的，我在 Linux/macOS 下会这么写：

```
set nobackup
set undodir=~/.vim/undodir
```

在 Windows 下这么写：

```
set nobackup
set undodir=~\vimfiles\undodir
```

无论哪种环境，你都需要创建这个目录。我们可以用下面的命令来让 Vim 在启动时自动创建这个目录：

```
if !isdirectory(&undodir)
  call mkdir(&undodir, 'p', 0700)
endif
```

如果我告诉你，&undodir 代表 undodir 这个选项的值，那么其他代码的基本作用，相信你也一定能看出来了吧？我们暂时就不做进一步分析了。如果你好奇的话，可以提前看一下下面各项的 Vim 帮助文档：

```
:help isdirectory()
:help mkdir()
:help :call
```

这个跨会话撤销的能力，我还真不知道其他哪个编辑器也有。更妙的是，Vim 还有撤销树的概念，可以帮助你回到任一历史状态。这个我们以后会和相关的插件一起讨论。

#### 2.5.2 鼠标支持

我不知道你会不会像某些资深 Vim 用户一样，只用键盘不用鼠标。我反正是做不到的，也没有动力去那样做 —— 毕竟，浪费计算机界一项伟大的发明并不那么有必要。手一直在键盘上的本位排（home row）打字当然会更快，但一个程序员看代码的时间比写代码的时间要多得多，而在非线性的跳转任务上，鼠标比键盘更加快，也更加有效。

在 Vim 的终端使用场景下，鼠标的选择有一定的歧义：你希望是使用 Vim 的可视模式选择内容，并且只能在 Vim 里使用呢，还是产生 Vim 外的操作系统的文本选择，用于跟其他应用程序的交互呢？这是一个基本的使用问题，两种情况都可能发生，都需要照顾。

如果你使用 xterm 兼容终端的话，通常的建议是：1）在不按下修饰键时，鼠标选择产生 Vim 内部的可视选择。2）在按下 Shift 时，鼠标选择产生操作系统的文本选择。

对于不兼容 xterm、不支持对 Shift 键做这样特殊处理的终端，我们一般会采用一种「绕过」方式，让 Vim 在某种情况下暂时不接管鼠标事件。通常的选择是在命令行模式下不使用鼠标。下面，我们就分这两种情况来配置。

虽然最新的 Vim 缺省配置文件（示例配置文件会包含缺省配置），在大部分情况下已经可以自动设置合适的鼠标选项了，不过为照顾我们课程的三种不同平台，我们还是手工设置一下：

```c
if has('mouse')
  if has('gui_running') || (&term =~ 'xterm' && !has('mac'))
    set mouse=a
  else
    set mouse=nvi
  endif
endif
```

上面代码说的是，如果 Vim 有鼠标支持的话，那在以下任一条件满足时：1）图形界面正在运行。2）终端是 xterm 兼容，并且不是 Mac（Mac 上的终端声称自己是 xterm，但行为并不完全相同）。我们将启用完全的鼠标支持（mouse=a）。特别是，此时鼠标拖拽就会在 Vim 里使用可视模式选择内容（只能在 Vim 里使用）。而当用户按下 Shift 键时，窗口系统接管鼠标事件，用户可以使用鼠标复制 Vim 窗口里的内容供其他应用程序使用。

否则（非图形界面的的终端，且终端类型不是 xterm），就只在正常模式（n）、可视模式（v）、插入模式（i）中使用鼠标。这意味着，当用户按下：键进入命令行模式时，Vim 将不对鼠标进行响应，这时，用户就可以使用鼠标复制 Vim 窗口里的内容到其他应用程序里去了。

图片：可视模式的选取和按「:」后的选取。

非 xterm 的鼠标支持在 macOS 和 Windows 下都有效。但在 Windows 下需要注意的一点是，如果使用非图形界面的 Vim 的话，应当在命令提示符（Command Prompt）的属性里关闭「快速编辑模式」（QuickEdit Mode），否则 Vim 在运行时将无法对鼠标事件进行响应。鉴于命令提示符的行为有很多怪异和不一致之处，强烈建议你在 Windows 下，要么使用图形界面的 Vim，要么使用 Cygwin/MSYS2 里、运行在 mintty 下的 Vim。

#### 2.5.3 中文支持

接下来我和你讲讲中文支持的问题。如果你一直在 UTF-8 下使用中文的话，那这一小节的内容可以跳过。对于大部分在 Unix 下工作的人员，应该是这样的情况。而如果你在 Windows 上工作，或者有需要跟别人交换 GB2312、GBK、GB18030 编码的文本文件，那这部分的内容还是需要看一下的。

完整的 Unicode 历史和原理可以讲上整整一讲，但从实用的角度，我们就简化成下面几条吧：1）整个世界基本上在向 UTF-8 编码靠拢。2）微软由于历史原因，内部使用 UTF-16；UTF-16 可以跟 UTF-8 无损转换。

GB2312、GBK、GB18030 是一系列向后兼容的中文标准编码方式，GB2312 编码的文件是合法的 GBK 文件，GBK 编码的文件是合法的 GB18030 文件。但除了 GB18030，都不能做到跟 UTF-8 无损转换；目前非 UTF-8 的简体中文文本基本上都用 GBK/GB18030 编码（繁体中文文本则以 Big5 居多）。鉴于 GB18030 是国家标准，其他两种编码也和 GB18030 兼容，我们就重点讲如何在 Vim 中支持 GB18030 了。

举一个具体的例子，「你好」这个字符串，在 UTF-8 编码下是下面 10 个字节（我按字符进行了分组）：

```
e4bda0 e5a5bd f09f9884
```

如果使用 GB18030 编码（GB2312/GBK 不能支持表情字符）的话，会编码成 8 个字节：

```
c4e3 bac3 9439fd30
```

这么看起来，GB18030 处理中文在存储效率上是优势的。但它也有缺点：1）GBK 外的 Unicode 字符一般需要四字节编码（非中文情况会劣化）。2）GBK 外的 Unicode 字符跟 Unicode 码点需要查表才能转换（UTF-8 则可以用非常简单的条件判断、移位、与、或操作来转换）。一旦出现文件中有单字节发生损毁，后续的所有中文字符都可能发生紊乱（而 UTF-8 可以在一个字符之后恢复）。

因此，GB18030 在国际化的软件中不会作为内码来使用，只会是读取 / 写入文件时使用的转换编码。我们要让 Vim 支持 GB18030 也同样是如此。由于 UTF-8 编码是有明显规律的，并非任意文件都能成功地当成 UTF-8 来解码，我们一般使用的解码顺序是：1）首先，检查文件是不是有 Unicode 的 BOM（字节顺序标记）字符，有的话按照 BOM 字符来转换文件内容。2）其次，检查文件能不能当作 UTF-8 来解码；如果可以，就当作 UTF-8 来解释。3）否则，尝试用 GB18030 来解码；如果能成功，就当作 GB18030 来转换文件内容。4）最后，如果上面的解码都不成功，就按 Latin1 字符集来解码；由于这是单字节的编码，转换必定成功。

事实上，Vim 缺省差不多就是按这样的顺序，但第三步使用何种编码跟系统配置有关。如果你明确需要处理中文，那在配置文件里最好明确写下下面的选项设定：

```
set fileencodings=ucs-bom,utf-8,gb18030,latin1
```

#### 2.5.4 图形界面的字体配置

图形界面的 Vim 可以自行配置使用的字体，但在大部分环境里，这只是起到美化作用，而非必需项。不过，对于高分辨率屏幕的 Windows，这是一个必需项：Vim 在 Windows 下缺省使用的不是 TrueType 字体，不进行配置的话，字体会小得没法看。

在 Windows 的缺省字体里，一般而言，Consolas 和 Courier New 还比较合适。以 Courier New 为例，在 \_vimrc 里可以这样配置（Windows 上的基本写法是字体名称加冒号、「h」加字号；用「_」取代空格，否则空格需要用「\」转义）：

```c
// 设置了 10 磅 Consolas 字体的 Vim
if has('gui_running')
  set guifont=Courier_New:h10
endif
```

字体名称如何写是件平台相关的事（可参见帮助文档「:help gui-font」）。如果你不确定怎么写出你需要的字体配置，或者你怎么写都写不对的话，可以先使用图形界面的菜单来选择（通常是「编辑> 选择字体」；在 MacVim 里是「Edit> Font > Show Fonts」），然后使用命令「:set guifont?」来查看。

注意，Vim 在设置选项时，空格需要用「\」进行转义。比如，如果我们要在 Ubuntu 下把字体设成 10 磅的 DejaVu Sans Mono，就需要写：

```
  " Linux 和 Windows 不同，不能用 '_' 取代空格
  set guifont=DejaVu\ Sans\ Mono\ 10
```

此外，宽字符字体（对我们来讲，就是中文字体了）是可以单独配置的。这可能就更是一件仁者见仁、智者见智的事了。对于纯中文的操作系统，这一般反而是不需要配置的；但如果你的语言设定里，中文不是第一选择的话，就有可能在显示中文时出现操作系统误用日文字体的情况。这时你会想要手工选择一个中文字体，比如在 Ubuntu 下，可以用：

```
  set guifontwide=Noto\ Sans\ Mono\ CJK\ SC\ 11
```  

注意，在不同的中英文字体搭配时，并不需要字号相同。事实上，在 Windows 和 Linux 上我通常都是使用不同字号的中英文字体的。

图图：Ubuntu 下的 gvim 设置中文字体。

在上面的动图中，你可以观察到设了中文字体之后，不仅中文字变大，更美观了，「将」、「适」、「关」、「复」、「启」等字的字形也同时发生了变化。由于字体在各平台上差异较大，字体配置我就不写到 Vim 的参考配置中去了，只把如何选择和配置的方法写出来供你参考。

### 黑板墙

请使用本讲的配置文件，并尝试以下操作：1）退出 Vim 然后重新打开文件，仍然可以撤销上次的编辑。2）使用终端的 Vim，在终端里用鼠标复制 Vim 里的文本到另外一个文本编辑器中（仅 Unix 下，可选）。3）在 Vim 中使用「:help」命令（大部分环境下也可以使用 \<F1> 功能键），尝试查看命令说明，以及使用键盘和鼠标在帮助主题中跳转。

老师的撤销文件和对于鼠标的处理我都挺喜欢的，后面的中文支持自己之前解决过，有一端时间在 gitbash 里使用 vim，出现过乱码。也顺便了解了 vim 不同层面对于编码的处理和转换。贴一下自己在 Windows 里的配置文件：

```
set fileencodings=utf-8,ucs-bom,gb18030,gbk,gb2312,cp936
set termencoding=utf-8
set encoding=utf-8
```

后两行好像是展示到终端时采用的编码，还有 vim 内部处理时使用的编码，记不大清了。所以我真的挺不喜欢 Windows 的。作者回复：你的第一行等价于：

```
set fileencodings=utf-8,ucs-bom,gb18030
```

不可能走到后面几种编码。termencoding 要跟你的终端编码匹配。Windows 上大概率不是 UTF-8。事实上在 Windows 上不需要设。2020-07-27

这个 undofile 的功能太强大了，以前把 backup 禁用后，老是碰到远程掉线，然后不记得上次修改的情况，这以后就不用怕了啊。作者回复：如果没存盘的话，还是要靠交换文件，而不是撤销文件。2020-07-27

老师怎么看待新的 NeoVim，貌似更多人选择 NeoVim 来替代 Vim 因为更加开放和更加现代。同时 VSCode 也有插件支持 NeoVim 作为后端，提供 vim 的便利。作者回复：参见 01 评论下我的回答。2020-07-27

话说一个 undo 插件是真的厉害，像 git 一样保存着历史的修改记录，可以随时撤回到指定状态。说实话，在使用 vim 的内置功能时，我极少数会用到鼠标。虽然我设置了一个快捷键，在 set mouse=a 和 n 间切换。但除了调整分割窗口的大小时，平常几乎不会用鼠标了。平常在 vim 中使用鼠标最多的场景是：在编辑状态，想插入屏屏幕上其他某个内容时，会借助 iTerm2 的选取即复制功能，然后按下 Cmd+v 来粘贴。开启鼠标模式下，点击内容，光标会切换到指定地方。但在 vim 中，有两个方法可以快速的跳转和选取内容。1）使用插件，easymotion。2）使用书签和 ctrl-i/o。使用书签可以快速的选中大段的范围。类似鼠标框选的效果。作者回复：这也是一种用法。跟我的不太一样。2020-07-27

我觉得 vim 的备份文件还是有必要设置一下的，与 undo 目录一样，backupdir 也可以设置到外面。类似这样：

```
set backup
set writebackup
set backupdir=~/.cache/vimbackup//
```

这个 mac 下显示按键的 app 是？作者回复: KeyCastr 开源，免费：https://github.com/keycastr/keycastr。2020-07-29

不知道是不是安装了 MacVim，需要改变配置项？按老师之前的安装配置，一般使用 vim 都会默认使用 mvim ？还烦请老师解答。作者回复：我提到的 source 命令都是 Vim 命令，是在 Vim 里面，不是在 Bash 里……如果安装了 MacVim，并且 printenv PATH 看到 /usr/local/bin 在 /usr/bin 前面，那 vim 命令启动的就是 MacVim 的版本。2020-07-29

macOS 上 set mouse=a 和 set mouse=nvi 在 NORMAL、VISUAL、INSERT 模式操作都是一致的，鼠标选中内容会自动切换 VISUAL 模式，单击会自动切回原来模式，并会改变光标位置；主要区别是在 COMMAND-LINE 模式，set mouse=a 下鼠标选择没有任何反应，set mouse=nvi 可以触发窗口系统接管鼠标事件。2020-07-28

生成的 undofile 怎么使用的？ 我用 vim 打开这个文件 是乱码的。作者回复：不是让你自己打开的。Vim 会自动用这个文件来做 undo （\<u>）和 Redo（\<C-r>）。2020-07-27

使用鼠标一般都是因为都要与 Vim 之外的其他软件交互，只要其他软件比如浏览器之类的也变成全键盘操作就好了，通过一些插件软件的辅助，99% 的操作都不用鼠标，很爽的。作者回复：我不完全同意。交互这部分没问题，但鼠标可以做到眼到手到，用键盘我很难想象这一点。个人意见，非线性的操作鼠标就是有优势的，用键盘去替代不是不可能，但不必要，徒增脑力负担。此外，用过有惯性滚轮的鼠标（如罗技的）之后，真的就回不去了。不管是快速浏览网页，还是看代码，滚动的丝滑体验用键盘不可能做到。尤其是看网页和文档（Vim 里做不到），滚动距离是在像素级控制的。2020-07-27

## 0103更多常用命令应对稍复杂的编辑任务.md

我们讨论了更多的一些常用 Vim 命令，包括：1）基本光标移动命令（可配合 c、d 和 v）。2）文本修改命令小汇总。3）文本对象命令（c、d、v 后的 a 和 i）。4）更快的光标和屏幕移动功能。5）重复功能。今天讲的内容不难，重点是文本对象。你知道吗？我见到的 Vim 命令速查表里通常也没有它们，因而连很多 Vim 的老用户都不知道这些功能呢。所以，掌握了这部分内容，我们就已经走在很多 Vim 用户的前面了。请一定要多加练习，用好这个功能会大大提升你的代码编辑效率。最后，提醒你去 GitHub 上看配置文件。配置文件我们有一处改动。类似地，适用于本讲的内容标签是 l3-unix 和 l3-windows。

学习更多 Vim 的常用命令，以便更高效地进行编辑。我会先带你过一下光标移动命令和文本修改命令，然后重点讲解文本对象，随后快速讨论一下不能搭配文本修改的光标移动命令，最后讨论如何重复命令。

### 3.1 光标移动

我们先来讨论一下可以跟文本修改搭配的光标移动命令。通过前面的课程，你已经知道，Vim 里的基本光标移动是通过 h、j、k、l 四个键实现的。之所以使用这四个键，是有历史原因的。你看一下 Bill Joy 开发 vi 时使用的键盘就明白了：这个键盘上没有独立的光标键，而四个光标符号直接标注在 H、J、K、L 四个字母按键上。

当然，除了历史原因外，这四个键一直使用至今，还是有其合理性的。它们都处于打字机的本位排（home row）上，这样打字的时候，手指基本不用移动就可以敲击到。因此，即使到了键盘上全都有了光标移动键的今天，很多 Vim 的用户仍然会使用这四个键来移动光标。不过，标准的光标移动键可以在任何模式下使用，而这四个键并不能在插入模式下使用，因此，它们并不构成完全的替代关系。

顺便提一句，你有没有注意到 ADM-3A 键盘上的 Esc 键在今天 Tab 的位置？在 Bill Joy 决定使用 Esc 来退出插入模式的时候，Esc 在键盘上的位置还没像今天那样跑到遥远的左上角去……

Vim 跳转到行首的命令是 0，跳转到行尾的命令是 \$，这两个命令似乎没什么特别的原因，一般用 \<Home> 和 \<End> 也没什么不方便的，虽然技术上它们有一点点小区别。如果你感兴趣、想进一步了解的话，可以参考帮助 :help \<Home>。此外，我们也有 ^，用来跳转到行首的第一个非空白字符。

对于一次移动超过一个字符的情况，Vim 支持使用 b/w 和 B/W，来进行以单词为单位的跳转。它们的意思分别是 words Backward 和 Words forward，用来向后或向前跳转一个单词。小写和大写命令的区别在于，小写的跟编程语言里的标识符的规则相似，认为一个单词是由字母、数字、下划线组成的（不严格的说法），而大写的命令则认为非空格字符都是单词。

根据单个字符来进行选择也很常见。比如，现在光标在 if (frame->fr_child != NULL) 第五个字符上，如果我们想要修改括号里的所有内容，需要仔细考虑 w 的选词规则，然后输入 c5w 吗？这样显然不够方便。这种情况下，我们就需要使用 f（find）和 t（till）了。它们的作用都是找到下一个（如果在输入它们之前先输入数字 n 的话，那就是下面第 n 个）紧接着输入的字符。两者的区别是，f 会包含这个字符，而 t 不会包含这个字符。在上面的情况下，我们用 t 就可以了：ct) 就可以达到目的。如果需要反方向搜索的话，使用大写的 F 和 T 就可以。

1『上面的几个命令实在太方便了，正是自己之前一直在找的。比如修改函数传参 () 里的数据，直接使用「ct)」即可。』

对于写文字的情况，比如给开源项目写英文的 README，下面的光标移动键也会比较有用：( 和 ) 移到上一句和下一句；{ 和 } 移到上一段和下一段。

在很多环境（特别是图形界面）里，Vim 支持使用 \<C-Home> 和 \<C-End> 跳转到文件的开头和结尾。如果遇到困难，则可以使用 vi 兼容的 gg 和 G 跳转到开头和结尾行（小区别：G 是跳转到最后一行的第一个字符，而不是最后一个字符）。光标移动咱们就讲到这里。你需要重点掌握的就是 Vim 里除了简单的光标移动，还有「小词」、「大词」、句、段的移动，以及字符的搜索；每种方式都分向前和向后两种情况。

### 3.2 文本修改

接着，我们来看文本修改。在 Vim 的教程里，我们已经学到，c 和 d 配合方向键，可以对文本进行更改。本质上，我们可以认为 c（修改）的功能就是执行 d（删除）然后 i（插入）。在 Vim 里，一般的原则就是，常用的功能，按键应尽可能少。因此很多相近的功能在 Vim 里会有不同的按键。不仅如此，大写键也一般会重载一个相近但稍稍不同的含义：

```
d 加动作来进行删除（dd 删除整行）；D 则相当于 d$，删除到行尾。

c 加动作来进行修改（cc 修改整行）；C 则相当于 c$，删除到行尾然后进入插入模式。

s 相当于 cl，删除一个字符然后进入插入模式；S 相当于 cc，替换整行的内容。

i 在当前字符前面进入插入模式；I 则相当于 ^i，把光标移到行首非空白字符上然后进入插入模式。

a 在当前字符后面进入插入模式；A 相当于 $a，把光标移到行尾然后进入插入模式。

o 在当前行下方插入一个新行，然后在这行进入插入模式；O 在当前行上方插入一个新行，然后在这行进入插入模式。

r 替换光标下的字符；R 则进入替换模式，每次按键（直到 <Esc>）替换一个字符。

u 撤销最近的一个修改动作；U 撤销当前行上的所有修改。
```

熟练掌握这些按键需要一定的记忆和练习。但是，当你熟练掌握之后，大部分编辑操作只需要按一两个按键就能完成；而在你还没有做到熟练掌握之前，记住最简单、最有逻辑的按键也可以让你至少能够完成需要的编辑任务。

### 3.3 文本对象选择

好，接下来就是我们今天的重点内容，文本对象的选择了。我之所以把这部分内容作为这节课的重点，是因为这是一个很方便很强大的功能，并且特别适合程序中的逻辑块的编辑。

到现在，我们已经学习过，可以使用 c、d 加动作键对这个动作选定的文本块进行操作，也可以使用 v 加动作键来选定文本块（以便后续进行操作），我们也学习了好些移动光标的动作。不过，还有几个动作只能在 c、d、v 这样命令之后用，我们也需要学习一下。

这些选择动作的基本附加键是 a 和 i。其中，a 可以简单理解为英文单词 a，表示选定后续动作要求的完整内容，而 i 可理解为英文单词 inner，代表后续动作要求的内容的「内部」。这么说，还是有点抽象，我们来看一下具体的例子。

假设有下面的文本内容：

```c
if (message == "sesame open")
```

我们进一步假设光标停在「sesame」的「a」上，那么：

```
dw（理解为 delete word）会删除 ame␣，结果是 if (message == "sesopen")

diw（理解为 delete inside word）会删除 sesame，结果是 if (message == "open")

daw（理解为 delete a word）会删除 sesame␣，结果是 if (message == "open")

diW 会删除 "sesame，结果是 if (message == open")

daW 会删除 "sesame␣，结果是 if (message == open")

di"会删除 sesame open，结果是 if (message =="")

da"会删除"sesame open"，结果是 if (message ==)

di (或 di) 会删除 message == "sesame open"，结果是 if ()

da (或 da) 会删除 (message == "sesame open")，结果是 if␣
```

上面演示了 a、i 和 w、双引号、圆括号搭配使用，这些对于任何语言的代码编辑都是非常有用的。实际上，可以搭配的还有更多：

```
搭配 s（sentence）对句子进行操作 —— 适合西文文本编辑

搭配 p（paragraph) 对段落进行操作 —— 适合西文文本编辑，及带空行的代码编辑

搭配 t（tag）对 HTML/XML 标签进行操作 —— 适合 HTML、XML 等语言的代码编辑

搭配 ` 和 ' 对这两种引号里的内容进行操作 —— 适合使用这些引号的代码，如 shell 和 Python

搭配方括号（「[」和「]」）对方括号里的内容进行操作 —— 适合各种语言（大部分都会用到方括号吧）

搭配花括号（「{」和「}」）对花括号里的内容进行操作 —— 适合类 C 的语言

搭配角括号（「<」和「>」）对角括号里的内容进行操作 —— 适合 C++ 的模板代码
```

再进一步，在 a 和 i 前可以加上数字，对多个（层）文本对象进行操作。下面图中是一个示例：修改往上第 2 层花括号内的所有内容「c2i{」。

你看，无论你使用什么语言，这些快捷的文本对象选择方式是不是总会有一种可以适用？我个人觉得这些功能绝对是 Vim 的强项了，所以，我再敲一次黑板，这部分内容是重点，不要嫌内容多，挨个儿用一用、练一练，你会发现这个功能非常实用，在写代码的时候常常会用得上。

### 3.4 更快地移动

除了这讲开头提到的光标移动功能外，还有一些通常不和操作搭配的光标和屏幕移动功能。我们在这节里会快速描述一下。

我们仍然可以使用 \<PageUp> 和 \<PageDown> 来翻页，但 Vim 更传统的用法是 \<C-B> 和 \<C-F>，分别代表 Backward 和 Forward。除了翻页，Vim 里还能翻半页，有时也许这种方式更方便，需要的键是 \<C-U> 和 \<C-D>，Up 和 Down。如果你知道出错位置的行号，那你可以用数字加 G 来跳转到指定行。类似地，你可以用数字加 | 来跳转到指定列。这在调试代码的时候非常有用，尤其适合进行自动化。

下图中展示了 iTerm2 中捕获输出并执行 Vim 命令的过程（用 vim -c 'normal 5G36|' 来执行跳转到出错位置第 5 行第 36 列）：捕获错误信息并自动通过 Vim 命令行来跳转到指定位置。（如果你用 iTerm2 并对这个功能感兴趣，我设置的正则表达式是 ^([_a-zA-Z0-9+/.-]+):([0-9]+):([0-9]+): (?:fatal error|error|warning|note):，捕获输出后执行的命令是 echo "vim -c 'normal \2G\3|' \1"。）

1『不错不错，跳转到特定的行，直接一直用的是 gg，那么现在该用 G（shift + g）。』

你只关心当前屏幕的话，可以快速移动光标到屏幕的顶部、中间和底部：用 H（High）、M（Middle）和 L（Low）就可以做到。

顺便提一句，vimrc\_example 有一个设定，我不太喜欢：它会设 set scrolloff=5，导致只要屏幕能滚动，光标就移不到最上面的 4 行和最下面的 4 行里，因为一移进去屏幕就会自动滚动。这同样也会导致 H 和 L 的功能发生变化：本来是移动光标到屏幕的最上面和最下面，现在则变成了移动到上数第 6 行和下数第 6 行，和没有这个设定时的 6H 与 6L 一样了。所以我一般会在 Vim 配置文件里设置 set scrolloff=1（你也可以考虑设成 0），减少这个设置的干扰。

只要光标还在屏幕上，你也可以滚动屏幕而不移动光标（不像某些其他编辑器，Vim 不允许光标在当前屏幕以外）。需要的按键是 \<C-E> 和 \<C-Y>。另外一种可能更实用的滚动屏幕方式是，把当前行「滚动」到屏幕的顶部、中部或底部。Vim 里的对应按键是 zt、zz 和 zb。和上面的几个滚动相关的按键一样，它们同样受选项 scrolloff 的影响。

### 3.5 重复，重复，再重复

今天的最后，我来带你解决一个你肯定会遇到的问题，那就是如何更高效地解决重复的操作。我们已经看到，在 Vim 里有非常多的命令，而且很多命令都需要敲好几个键。如果你要重复这样的命令，每次都要再手敲一遍，这显然是件很费力的事。作为追求高效率的编辑器，这当然是不可接受的。除了我们以后要学到的命令录制、键映射、自定义脚本等复杂操作外，Vim 对很多简单操作已经定义了重复键：

```
; 重复最近的字符查找（f、t 等）操作

, 重复最近的字符查找操作，反方向

n 重复最近的字符串查找操作（/ 和？）

N 重复最近的字符串查找操作（/ 和？），反方向

. 重复执行最近的修改操作
```

有了这些，重复操作就非常简单了。要掌握它们的方法就是多练习，多用几次自然就会了。

### 黑板墙

请把本讲里面描述的 Vim 功能自己练习一下，尤其需要重点掌握的是文本修改命令、文本对象命令和重复功能。其他某些功能可能只对部分人和某些场景有用，如果一个功能你觉得用不上，不用去强记。毕竟，不用的功能，即使一时死记硬背可以记住，也很快会遗忘的。

我的 scrolloff 好像配置到是 1。最早一直是 0，不知道还可以调这玩意。后来看网上别人设置的 3，但体验后发现不太好，比较浪费空间。但是这个还有那么一点作用，所以就调成了 1。另外，针对插入模式下，hjkl 无法移动光标的问题，我很早就给他们映射了按键。Ctrl+hjkl 在插入模式下移动光标，还蛮方便的。2020-07-29

c2i{ 真是神操作，要是我的话就只会通过 V 模式先选中再修改了。选这门课也是希望能看到更多这样的操作，即在同样的情况下有经验的人是如何做的。作者回复：是的。这个是特色功能。2020-07-29

文本对象操作，再补充一个常用的复制动作 y。作者回复：补充得有道理！我比较少这么用。更常见是先用 v 选择，看清选择后，再 y 比较有信心。不过道理上讲，y 确实算。2020-07-29

基本光标移动命令（可配合 c、d 和 v），结束语的这句话没太明白，光标移动怎么结合 c 和 d 使用啊。作者回复：指 dw、dW 这样的正常模式命令。2020-07-29

命令模式下的光标基于单词的移动，有什么好方法吗？感觉 S-Left/Right 比较麻烦。我一般都是 ^f 切到命令历史，^c 切回命令，对于输入一部分，发现有输入错误，想要修正比较麻烦。作者回复：如果命令真复杂到这种程度，复制出来，编辑完，y\$，然后在命令行模式里 \<C-r> 如何？2020-07-29

补充两个上下移动的键，gj 和 gk，这两个可以在由于屏幕限制而导致的换行中使用。作者回复：我没讲的功能永远有很多。这两个按键，我后面倒是会讲到（拓展 1）。它们的主要功用是在很长的文本行里，而非一般的代码。2020-07-29

老师您好，在插入模式下使用标准的光标移动键似乎不是很方便，或者退出到正常模式然后使用 hjkl，频繁切换模式也不方便，这个有什么好的替代方法吗？作者回复：没更好的。移动少就光标移动键了。移动多、或后续操作不是插入，就回到正常模式。2020-07-29

文本对象确实应该是 vim 中的神器，其他编辑器没有普通模式，估计是不好实现这个了。文中的命令算是非常基础和全面的了。w/b/e/ge/W/B/E/gE ，0/^/\$ 和 f/t/F/T 在行内跳转，还是很灵活的。另外推荐一个 tpope 的一个插件：[tpope/vim-surround: surround.vim: quoting/parenthesizing made simple](https://github.com/tpope/vim-surround)。这个和 easymotion（[easymotion/vim-easymotion: Vim motions on speed!](https://github.com/easymotion/vim-easymotion)）是 vscode 中 vim 内置的两个插件。都是非常强大的。2020-07-29

## 0104初步定制让你的Vim更顺手.md

我们讨论了 Vim 8 下的基本目录结构和 Vim 8 的软件包。你需要知道，Vim 的运行支持目录和用户配置目录有相似的结构，用户配置目录下的文件优先于 Vim 安装目录下的文件。因此，在用户配置目录里进行修改，可以在 Vim 版本有变化时保留自己的定制行为。而 Vim 8 的软件包使得维护 Vim 的扩展变得更为容易，每一个 Vim 软件包都是独立的目录，可以单独安装、修改和升级。包管理器，如 minpac，则可以帮助我们更方便地安装和管理 Vim 软件包。对于配置文件，适用于本讲的内容标签是 l4-unix 和 l4-windows。

在前几讲，我已经介绍了不少 Vim 的常用命令，我想你已经略有心得了吧。今天我们转换一下视角，来讲一下 Vim 这个软件本身。作为一个 Vim 的使用者，光熟悉命令是不够的，你还需要定制 Vim。因为每个人的习惯和需求都是不一样的，一个高度定制化的 Vim 环境能大大提高你的工作效率。今天，我会先带你了解一下 Vim 的运行支持文件目录结构，然后我们再一起探索 Vim 8 带来的新功能，及如何对 Vim 进行初步配置来使得 Vim 更加好用。

### 4.1 Vim 的目录结构

Vim 的工作环境是由运行支持文件来设定的。如果你想要定制 Vim，就要熟知 Vim 有哪些不同类型的运行支持文件，分别存放在哪里，怎样能快捷地找到它们。Vim 比较有意思的一点的是，虽然运行支持文件是在 Vim 的安装目录下，但用户自己是可以「克隆」这个目录结构的。也就是说，你自己目录下的用户配置，到你深度定制的时候，也有相似的目录结构。所以，我就先从这些文件的目录结构开始讲起。

### 4.2 安装目录下的运行支持文件

Vim 的运行支持文件在不同的平台上有着相似的目录结构。以 Vim 8.2 为例，它们的标准安装位置分别在：1）大部分 Unix 下面：/usr/share/vim/vim82。2）macOS Homebrew 下：/usr/local/opt/macvim/MacVim.app/Contents/Resources/vim/runtime。3）Windows 下：C:\Program Files (x86)\Vim\vim82。

在这个目录下面，你可以看到很多子目录，如 autoload、colors、doc、pack、plugin、syntax 等等。这些子目录下面就是分类放置的 Vim 支持文件。最常用的子目录应该是下面这几个：1）syntax：Vim 的语法加亮文件。2）doc：Vim 的帮助文件。3）colors：Vim 的配色方案。4）plugin：Vim 的「插件」，即用来增强 Vim 功能的工具。

以 syntax 目录为例，当前我在下面看到有 617 个文件，也就是说，Vim 对 617 种不同的文件类型提供了语法加亮支持！这里面的文件去掉「.vim」后缀后，就是文件类型的名字，你可以用类似 :setfiletype java 这样的命令来设置文件的类型，从而进行语法加亮。目录下我们可以看到大家都很熟悉的语言，也有很多我从来都没听说过的东西。

只要有正当的理由，你就可以向 Vim 的作者 Bram 提交改进版本，或是对全新的语言的支持。我就对若干种文件类型提交过补丁，新增了对《计算机编程艺术》中的 MIX 汇编语言的语法支持，并维护着微软宏汇编（MASM）的语法文件。

在图形界面的 Vim 里，你可以通过「语法 > 在菜单中显示文件类型」（Syntax > Show File Types in Menu）来展示 Vim 的所有文件类型，然后可以选择某一类型来对当前文件进行设置。这儿的菜单项，跟 syntax 目录下的文件就基本是一一对应的了。

在菜单中显示文件类型这个额外的步骤，可能是因为很久很久以前，加载所有文件类型的菜单是一个耗时的操作吧。在 menu.vim 里，目前有这样的代码：

```
" Skip setting up the individual syntax selection menus unless
" do_syntax_sel_menu is defined (it takes quite a bit of time).
if exists("do_syntax_sel_menu")
  runtime! synmenu.vim
else
  …
endif
```

不知道这段注释是什么年代加上的…… 但显然，我们的电脑已经不会再在乎加载几百个菜单项所占的时间了。即使我不怎么用菜单，我也找不出不直接展示这个菜单的理由；我可不想在需要使用的时候再多点一次鼠标。所以，我会在我的 vimrc 文件里写上：

```
let do_syntax_sel_menu = 1
```

同理，我会加载其他一些可能会被 Vim 延迟加载的菜单，减少需要在菜单上点击的次数：

```
let do_no_lazyload_menus = 1
```

上面两个设置在我的机器上会让我打开 Vim 的速度下降大概 20 毫秒。我想我不在乎这点时间差异……

我们用「:help」命令查看的帮助文件就放在 doc 目录下。我们可以用菜单「编辑 > 配色方案」（Edit> Color Scheme）浏览配色方案，相应的文件就在 colors 目录下。

在 plugin 目录下的系统内置插件不多，我们下面就快速讲解一下：

```
getscriptPlugin：获得最新的 Vim 脚本的插件（在目前广泛使用 Git 的年代，这个插件过时了，我们不讲）

gzip：编辑 .gz 压缩文件（能在编辑后缀为 .gz 的文件时自动解压和压缩，你会感觉不到这个文件是压缩的）

logiPat：模式匹配的逻辑运算符（允许以逻辑运算、而非标准正则表达式的方式来写模式匹配表达式）

manpager：使用 Vim 来查看 man 帮助（强烈建议试一下，记得使用 Vim 的跳转键 C-] 和 C-T）

matchparen：对括号进行高亮匹配（现代编辑器基本都有类似的功能）

netrwPlugin：从网络上编辑文件和浏览（远程）目录（支持多种常见协议如 ftp 和 scp，可直接打开目录来选择文件）

rrhelper：用于支持 --remote-wait 编辑（Vim 的多服务器会用到这一功能）

spellfile：在拼写文件缺失时自动下载（Vim 一般只安装了英文的拼写文件）

tarPlugin：编辑（压缩的）tar 文件（注意，和 gzip 情况不同，这儿不支持写入）

tohtml：把语法加亮的结果转成 HTML（自己打开个文件，输入命令「:TOhtml」就知道效果了）

vimballPlugin：创建和解开 .vba 文件（这个目前也略过时了，我们不讲）

zipPlugin：编辑 zip 文件（和 tar 文件不同，zip 文件可支持写入）
```

除了 rrhelper 和 spellfile 属于功能支持插件，没有自己的帮助页面，其他功能都可以使用「:help」命令来查看帮助。查看帮助时，插件名称中的「Plugin」后缀需要去掉：查看 zip 文件编辑的帮助时，应当使用「:help zip」而不是「:help zipPlugin」。

从这些插件当中，我们已经可以看到 Vim 的一些特殊威力了吧。下面的动图里，我们可以看到部分插件功能的展示：1）浏览远程目录，打开一个 tar.gz 文件。2）使用 Vim 查看 man 帮助。

### 4.3 用户的 Vim 配置目录

Vim 的安装目录你是不应该去修改的。首先，你可能没有权限去修改这个目录；其次，即使你有修改权限，这个目录会在 Vim 升级时被覆盖，你做的修改也会丢失。用户自己的配置应当放在自己的目录下，这也就是用户自己的主目录下的 Vim 配置目录（Unix 下的 .vim，Windows 下的 vimfiles）。这个目录应和 Vim 安装目录下的运行支持文件目录有相同的结构，但下面的子目录你在需要修改 Vim 的相关行为时才有必要创建。如果一个同名文件出现用户自己的 Vim 配置目录里和 Vim 的安装目录里，用户的文件优先。

换句话说，修改 Vim 行为最简单的一种方式，就是把一个系统的运行支持文件复制到自己的 Vim 配置目录下的相同位置，然后修改其内容。我自己常常用这种方式来精调 Vim 的语法加亮。显然，这种方式的缺点（在适当的时候也是优点）是，如果 Vim 的运行支持文件后来被修改 / 更新了，你也会继续使用你自己目录下的老版本修改版。如果你的修改不只是你自己的临时方案、同时也适合他人的话，最佳做法还是给 Vim 项目提交补丁，让其他所有人都能用上你的修改，这样才是开源的最佳使用方式。

关于 Vim 的公用脚本，这儿再多说几句。Vim 的网站过去是用来集中获取各种脚本 —— 如插件和配色方案 —— 的地方，而 getscriptPlugin 可以帮助简化这个过程。今天你仍然可以使用这个方法，但 Git 和 GitHub 的广泛使用已经改变了人们获取和更新脚本的方式。现在，最主流的分发 Vim 脚本的方式是利用 GitHub，而用户则使用包管理器来调用 Git 从 GitHub（或类似的 Git 库）获取和更新脚本，下面我们很快就会讲到。理解了 Vim 的目录结构，我们接着来看 Vim 8 的新功能。

### 4.4 Vim 8 新功能

Vim 是一个持续改进中的应用程序。从 Vim 8.1（2018 年 5 月 17 日）到 Vim 8.2（2019 年 12 月 12 日），Vim 有 2424 个补丁，也就是说，平均每天超过 4 个补丁。很多 Vim 8 里的大功能，并不是一次性引入，而是在补丁中慢慢引入的。比如，Vim 里现在有终端支持，这个功能从 Vim 8.0.0693 开始引入，到了 Vim 8.1，成为一个正式的大功能。

站在我个人的角度看，从 Vim 7.4 到 Vim 8.2，最大的新功能是：1）Vim 软件包的支持（「:help packages」）。2）异步任务支持（「:help channel」、「:help job」和「:help timers」）。3）终端支持（「:help terminal」）。今天我们就重点讲一下 Vim 软件包。这是 Vim 8 里带来的一个重要功能，也让我们在扩展 Vim 的时候变得更方便了。

### 4.5 Vim 软件包

Vim 的目录结构有点传统 Unix 式：一个功能用到的文件可能会分散在多个目录下。就像传统 Unix 上 Vim 的文件可能分散在 /usr/bin、/usr/share/man、/usr/share/vim 等目录下一样，一个 Vim 的插件（严格来讲，应该叫包）通常也会分散在多个目录下：1）插件的主体通常在 plugin 目录下。2）插件的帮助文件在 doc 目录下。3）有些插件只对某些文件类型有效，会有文件放在 ftplugin 目录下。4）有些插件有自己的文件类型检测规则，会有文件放在 ftdetect 目录下。5）有些插件有特殊的语法加亮，会有文件放在 syntax 目录下……

以前我们安装插件，一般是一次性安装后就不管了。安装过程基本上就是到 .vim 目录（Windows 上是 vimfiles 目录）下，解出压缩包的内容，然后执行 vim -c 'helptags doc|q' 生成帮助文件的索引。到了「互联网式更新」的年代，这种方式就显得落伍了。尤其糟糕的地方在于，它是按文件类型来组织目录的，而不是按相关性，这就没法用 Git 来管理了。

Vim 上后来就出现了一些包管理器，它们的基本模式都是相通的：每个包有自己的目录，然后这些目录会被加到 Vim 的运行时路径（runtimepath）选项里。最早的 runtimepath 较为简单，在 Unix 上缺省为：

```
$HOME/.vim,
$VIM/vimfiles,
$VIMRUNTIME,
$VIM/vimfiles/after,
$HOME/.vim/after
```

而在有了包管理器之后，runtimepath 就会非常复杂，每个包都会增加一个自己的目录进去。但是，好处也是非常明显的，包的管理变得非常方便。从 Vim 8 开始，Vim 官方也采用了类似的体系。Vim 会在用户的配置目录（Unix 下是 \$HOME/.vim ，Windows 下是 \$HOME/vimfiles ）下识别名字叫 pack 的目录，并在这个目录的子目录的 start 和 opt 目录下寻找包的目录。

听着有点绕吧？我们看一个实际的 Vim 配置目录的结构就清楚了：

```

.
├── colors
├── doc
├── pack
│   ├── minpac
│   │   ├── opt
│   │   │   ├── minpac
│   │   │   ├── vim-airline
│   │   │   └── vimcdoc
│   │   └── start
│   │       ├── VimExplorer
│   │       ├── asyncrun.vim
│   │       ├── fzf.vim
│   │       ├── gruvbox
│   │       ├── killersheep
│   │       ├── nerdcommenter
│   │       ├── nerdtree
│   │       ├── tagbar
│   │       ├── undotree
│   │       ├── vim-fugitive
│   │       ├── vim-matrix-screensaver
│   │       ├── vim-rainbow
│   │       ├── vim-repeat
│   │       ├── vim-rhubarb
│   │       └── vim-surround
│   └── my
│       ├── opt
│       │   ├── YouCompleteMe
│       │   ├── ale
│       │   ├── clang_complete
│       │   ├── cvsmenu
│       │   └── syntastic
│       └── start
│           ├── vim-gitgutter
│           └── ycmconf
├── plugin
├── syntax
└── undodir
```

可以看到，pack 目录下有 minpac 和 my 两个子目录（这些名字 Vim 不关心），每个目录下面又有 opt 和 start 两个子目录，再下面就是每个包自己的目录了，里面又可以有自己的一套 colors、doc、plugin 这样的子目录，这样就方便管理了。Vim 8 在启动时会加载所有 pack/*/start 下面的包，而用户可以用 :packadd 命令来加载某个 opt 目录下的包，如 :packadd vimcdoc 命令可加载 vimcdoc 包，来显示中文帮助信息。

有了这样的目录结构，用户要自己安装、管理包就方便多了。不过，我们还是推荐使用一个包管理器。包管理器可以带来下面的好处：1）根据文本的配置（一般写在 vimrc 配置文件里）决定要安装哪些包。2）自动化安装、升级和卸载，包括帮助文件的索引生成。

在我们这门课程里，我会使用 minpac，一个利用 Vim 8 功能的小巧的包管理器。如果你已经在使用其他包管理器，我接下来讲的两个小节你可以考虑跳过。

### 4.6 安装 minpac

根据 minpac 网页上的说明，我们在 Windows 下可以使用下面的命令：

```
cd /d %USERPROFILE%
git clone https://github.com/k-takata/minpac.git ^
    vimfiles\pack\minpac\opt\minpac
```

在 Linux 和 macOS 下则可以使用下面的命令：

```
git clone https://github.com/k-takata/minpac.git \
    ~/.vim/pack/minpac/opt/minpac
```

然后，我们在 vimrc 配置文件中加入以下内容（先不用理解其含义）：

```
if exists('*minpac#init')
  " Minpac is loaded.
  call minpac#init()
  call minpac#add('k-takata/minpac', {'type': 'opt'})

  " Other plugins
endif

if has('eval')
  " Minpac commands
  command! PackUpdate packadd minpac | source $MYVIMRC | call minpac#update('', {'do': 'call minpac#status()'})
  command! PackClean  packadd minpac | source $MYVIMRC | call minpac#clean()
  command! PackStatus packadd minpac | source $MYVIMRC | call minpac#status()
endif
```

存盘、重启 Vim 之后，我们就有了三个新的命令，可以用来更新（安装）包、清理包和检查当前包的状态。

### 4.7 通过 minpac 安装扩展包

下面我们就来试验一下通过 minpac 来安装扩展包。我们在「Other plugins」那行下面加入以下内容：

```
call minpac#add('tpope/vim-eunuch')
```

保存文件，然后我们使用 :PackUpdate 命令。略微等待之后，我们就能看到类似下面的界面。这就说明安装成功了。我们可以按 q 来退出这个状态窗口。我们也可以使用 :PackStatus 来重新打开这个状态窗口。要删除一个插件，在 vimrc 中删除对应的那行，保存，然后使用 :PackClean 命令就可以了。愿意的话，你现在就可以试一下。

### 4.7 最近使用的文件

安装好 Vim 软件包之后，我们进一步来实现一个小功能。Vim 的缺省安装缺了一个很多编辑器都有的功能：最近使用的文件。我们就把这个功能补上吧。你只需要按照上一节的步骤安装 yegappan/mru 包就可以了（MRU 代表 most recently used）。安装完之后，重新打开 vimrc 文件，你就可以在图形界面里看到下面的菜单了：

估计你很可能会问：如果是远程连接，没有图形界面怎么办？我们仍可以在文本界面上唤起菜单，虽然美观程度会差点。你需要在 vimrc 配置文件中加入以下内容（同样，我们暂时先不用去理解其意义）：

```
if !has('gui_running')
  " 设置文本菜单
  if has('wildmenu')
    set wildmenu
    set cpoptions-=<
    set wildcharm=<C-Z>
    nnoremap <F10>      :emenu <C-Z>
    inoremap <F10> <C-O>:emenu <C-Z>
  endif
endif
```

在增加上面的配置之后，你就可以使用键 \<F10>（当然你也可以换用其他键）加 \<Tab> 来唤起 Vim 的文本菜单了。如下图所示。