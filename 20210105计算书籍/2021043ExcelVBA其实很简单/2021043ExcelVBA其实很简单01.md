## 0101. 走进 Excel VBA 的世界 

VBA 就像一座神秘的城堡，对很多人来说都是神秘的。很多人想走进 VBA 的世界，却始终找不到打开大门的钥匙。什么是 VBA？ 怎样学习 VBA？ 面对这些问题，让我们从身边开始，一起探索，一起解答。

### 1.1 不会 Excel 的人，真伤不起 

1.1.1 做不完的表 

数据采集、数据处理、数据分析…… 这是小张每天都在做的工作。老板的需求和基础数据一样每天都在改变，而小张做表的速度却永远也跟不上老板敏捷的思维。不同的数据，相同的操作。小张感叹：「和数据打交道的日子，真烦！」单位来了新同事，接手小张平时的工作。

1.1.2 神速的「超人」终于告别上万条的数据，离开乱七八糟的报表，脱离「苦海」的日子，小张的日子要多舒心有多舒心。可是…… 电话里，老板那可以撑爆整幢大楼的赞扬声和新同事腼腆的笑容，让小张心里很不是滋味：「一个小时和一星期，中间的差距不仅只是时间。不会 Excel 的人，真伤不起！」

1.1.3 你是怎样做工资条的 

小张决定向新同事取取经…… 同事打开一张工资表，如图 1-1 所示，让小张把它做成工资条，如图 1-2 所示。

图 1-1 工资表 

图 1-2 工资条 

小张熟练地拿起鼠标，选中工资表头所在行 → 复制 → 选中第二条工资记录所在行 → 单击右键 → 插入复制单元格。完成后，又按同样的操作进行第三条，第四条…… 新同事看完后，笑了：「如果是 1000 条记录的工资表，这样做需要多久？」小张苦笑，也只能苦笑。工作的内容不少，但都是重复的操作。而这种重复不但枯燥而且费时，尽管小张天天时时刻刻都在做表，却永远也跟不上老板的节奏。

### 1.2 走自己的「录」，让别人重复去吧 

新同事的建议让小张感到很茫然。面对小张满脑子的疑问，新同事耐心地给他解释，并示范操作过程…… 

1.2.1 什么是宏 

就像用摄像机录下来的视频，在 Excel 里，宏就是 Excel 用户使用宏录制器录下的一组操作。选中工资表头所在行 → 复制 → 选中工资记录所在行 → 单击右键 → 插入复制单元格，这是小张制作工资条时重复的操作。

1.2.2 用宏录下 Excel 操作 

录制宏前需要进行一些简单的设置，如图 1-3 所示。

图 1-3 录制宏前的设置 

完成上述设置后就可以录制宏了，如图 1-4 所示。

图 1-4 用宏录下 Excel 操作 这样，宏就录制好了。

1.2.3 让录下的操作再现一遍 

录制完成后，通过下面的方法运行宏，如图 1-5 所示。

图 1-5 执行宏

如果要继续插入新的工资表头，就继续执行宏。

### 练习小课堂 

学会使用录制和执行宏代替手工完成重复操作后，小张很高兴。他发现工作中很多问题都可以借助宏来提高工作效率。可是，他不明白相对引用和绝对引用的区别，你能分别录制不同的宏，执行它们，找到它们之间的区别吗？ 

### 参考答案 

绝对引用：如果使用绝对引用，在执行宏的过程中，无论选中了哪个单元格，宏都在特定的单元格中执行录制的操作。

相对引用：如果使用相对引用，在执行宏的过程中，将以活动单元格为 A1 单元格，宏在相对于活动单元格的特定单元格中执行录制的操作。如果你想让录制的宏可以在任意区域中使用，就使用相对引用。

### 1.3 还可以怎样执行宏 

【宏】对话框里的「执行」按钮就是运行宏的开关。不够方便，不够快捷，是这个开关的缺点。如果你不喜欢这个开关，可以选择其他执行宏的方法。

1.3.1 给宏设置快捷键 

录制宏前，可以在【录制新宏】对话框里为宏设置快捷键，如图 1-6 所示。

图 1-6 录制宏前为宏设置快捷键 

也可以在录制宏后进行设置，如图 1-7 所示。

图 1-7 录制宏后给宏设置快捷键 

给宏设置快捷键后，就可以按下相应的组合键执行宏。注意： 因为给宏指定的快捷键会覆盖 Excel 默认的快捷键。例如：把 `<Ctrl+C>` 指定给某个宏，那在 Excel 中按下 `<Ctrl+C> `组合键将不再执行复制操作。

1.3.2 将宏指定给按钮 

不便记忆，不易上手。快捷键虽快却不实用。无论出于什么目的，都应尽量让设计的表格显得直观一些。拿过电视机的遥控板，扫一眼就知道该按下哪个按钮来加减声音，按下哪个按钮来调节频道。如果你担心忘记为宏设置的快捷键，可以绘制一块直观形象的「遥控板」，通过单击按钮来执行宏。

图 1-8 所示为将宏指定给按钮的方法。

图 1-8 将宏指定给按钮 

如果是已经添加的按钮，可以用鼠标右键单击它，在右键菜单中执行【指定宏】菜单命令打开【指定宏】对话框，再将宏指定给按钮，如图 1-9 所示。

图 1-9 打开指定宏对话框 

当按钮呈编辑状态（如果不是编辑状态，可以先用鼠标右键单击它）时，单击按钮表面，更改标签为「生成工资条」，调整按钮的大小和位置，完成后单击按钮外的任意区域退出对按钮的编辑，如图 1-10 所示。

图 1-10 更改标签后的按钮 

完成上述设置后即可单击按钮执行宏，如图 1-11 所示。

图 1-11 单击按钮执行宏 

还可以用同样的方法将宏指定给图片或自选图形等。

1.3.3 将宏指定给常用工具栏按钮 

将宏指定给常用工具栏按钮的操作步骤如图 1-12 所示。

图 1-12 将宏指定给自定义工具栏按钮 

还可以在右键菜单中对按钮进行其他的设置，如更改按钮的名称、图像等，如图 1-13 所示。

图 1-13 设置自定义按钮 

完成后关闭【自定义】对话框，就可以单击自定义的按钮执行宏了。

### 1.4 是谁「挡住」了宏 

1.4.1 宏为什么不能工作了 

有时，打开一个保存有宏的工作簿或试图执行一个宏时，Excel 会显示如图 1-14 所示的对话框，而并不执行宏。

图 1-14 禁用宏的提示对话框 

这是小张遇到的一个新问题，他再次向新同事求助。

1.4.2 怎样修改宏安全级 

修改宏的安全级的操作如图 1-15 所示。

图 1-15 打开【安全性】对话框 

如果希望录制的宏或编写的 VBA 程序得到运行的机会，应将安全级设置为「中」或「低」。如果设置为「中」，每次打开文件时，Excel 都会显示【安全警告】对话框，让用户选择启用或禁用宏，如图 1-16 所示。

图 1-16 打开文件时的安全警告对话框 如果将安全级设置为「低」，打开文件时 Excel 不会给出任何提示并直接启用工作簿里所有的宏，如果工作簿里带有恶意代码，这样做是非常危险的，所以，建议将安全级设置为「中」。注意： 在 Excel 2003 中，修改宏安全级后需要关闭工作簿再重新打开它，修改才能生效。

### 1.5 VBA，Excel 里的编程语言 

1.5.1 录制宏不能解决的问题 

尽管可以录下用户在 Excel 里的操作，但却不能满足用户所有的需求。

1.5.2 让工资条一「输」到底 

Step 1：查看已经录制的宏，见图 1-17。

图 1-17 录制的宏 

Step 2：在第一行代码 `Sub 生成工资条 ()` 的后面添加两行新代码： 在最后一行代码 `End Sub` 的前面添加一行代码： 

图 1-18 修改后的宏 

1『

看原书里加的代码如下：

```
  Dim i As Long
  For i = 2 To 1000
  ......
  ......
  Next
```

但是看后面的代码又没有出现变量 i，目前不明白，打个标记。（2021-03-16）

』

Step 3：关闭窗口，返回 Excel 工作表界面，重新执行宏，所有的工资条就全部完成了，如图 1-19 所示。

图 1-19 一次性生成所有工资条 

1.5.3 VBA 编程，让你的表格更加灵活 

不管你是否知道应该怎样修改和使用录制的宏，但从小张的故事里，应该看到了修改前与修改后的宏在工作效率上的差别。实际上，在运行宏的过程中，我们总希望能自主地判断和选择需要执行的操作或计算，而录制的宏并不能满足类似的需求。这就要求我们对宏进行适当的修改，甚至自己动手编写满足需要的代码，即：使用 VBA 编程。

1.5.4 什么是 VBA 

VBA（Visual Basic For Application）是一种编程语言，是建立在 Office 中的一种应用程序开发工具。可以利用 VBA 有效地扩展 Excel 的功能，设计和构建人机交互界面，打造自己的管理系统，帮助 Excel 用户更有效地完成一些基本操作、函数公式等不能完成的任务，从而提高工作效率。同你的名字一样，VBA 也只是一个名字，一种编程语言的名字。

1.5.5 宏和 VBA 有什么关系 

VBA 是编程语言，宏是用 VBA 代码保存下来的程序。录制的宏只是 VBA 里最简单的程序，正因为如此，录制的宏存在许多的缺陷：如无法进行判断和循环，不能显示用户窗体，不能进行人机交互…… 要想打破这些局限，让自己的程序更加自动化和智能化，仅仅掌握录制和执行宏是远远不够的，还需要掌握 VBA 编程的方法，自主地编写 VBA 程序。这就是我们学习 VBA 的目的。

## 0201. 开始 VBA 编程的第一步

优秀的运动员总是非常注重起跑的第一步。准确的姿势，恰到好处的起跑时间，再加上中间的努力拼搏，总能带给运动员优秀的成绩。比赛的最终赢家不但有过硬的运动天赋，而且一定经过长期学习和坚持训练的过程。想成为一名优秀的 VBA 编程者，最先应该了解什么？让我们一起来学习。

### 2.1 揭开神秘面纱背后的真面目 

从小张的故事里走出来，我们正式开始学习 Excel VBA。既然录制的宏就是 VBA 程序，那让我们打开第 1 章 1.2.2 小节中录制的宏所在的工作簿文件，一起研究研究。

2.1.1 程序保存在哪里 

参照图 2-1 所示的操作，可以查看宏对应的代码。

图 2-1 查看录制的宏 这个窗口是 VBE 窗口，打开它，在右面的【代码窗口】中可以看到一串代码，这就是使用宏录制器录下来的操作，以代码的形式保存在模块里。

### 练习小课堂 

动手录几个不同的宏，比一比，宏的代码有什么共同的地方？把你总结的结论写下来，然后再继续后面的内容。

2.1.2 应该怎样编写程序 

图 2-2 所示为录制宏得到的程序。

图 2-2 录制宏得到的程序

### 2.2 程序里都有什么 

为了在编程时能更加得心应手，有必要先花点时间了解一下在编程的过程中，会反复提到的一些概念。

2.2.1 代码 VBA 的程序由代码组成，可以通过录制宏或自主编写得到 VBA 代码。

2.2.2 过程 

用 VBA 代码把完成一个任务的所有操作保存起来就是一个 VBA 过程。一个过程可以有任意多的操作，可以有任意长的代码。在本书中，只介绍 Sub 过程和 Function 过程。

2.2.3 模块

模块是保存过程的地方，一个模块可以保存多个不同类型的过程。2.2.4　对象 用代码操作和控制的东西即为对象，如工作簿、工作表、单元格、图片、图表、透视表等。2.2.5　对象的属性 每个对象都有属性，属性是对象包含的内容或特点。从对象的属性，可以了解该对角具有的性质和特点。如字体的颜色，颜色就是字体的属性；按钮的宽度，宽度就是按钮的属性。从对象的属性还可以了解到这个对象包含了哪些其他的对象。如 Sheet1 工作表的 A1 单元格，A1 单元格就是 Sheet1 工作表的属性；A1 单元格的内容，内容就是 A1 单元格的属性。在书写时，对象和属性之间用点（.）连接，对象在前，属性在后，如 A1 单元格的内容，用汉字表达为：A1. 内容 写成代码为： 对象的某些属性也是对象，属性和对象是相对而言的。2.2.6　对象的方法 每个对象都有方法，方法是指在对象上执行的某个动作。如选中 A1 单元格，「选中」是在 A1 单元格这个对象上执行的操作，就是 A1 单元格的方法。对象和方法之间也用点（.）连接，对象在前，方法在后，如选中 A1 单元格写成代码为： 2.2.7　关键字 关键字是 VBA 中的保留字或符号，如语句名称、函数名称、运算符等都是关键字。

2.3　VBA 的编程环境 ——VBE 在第 2 章 2.1.1 小节中打开的窗口就是编写 VBA 程序的地方 ——VBE（Visual Basice Editor），了解 VBA 程序中经常提到的概念后，我们再花一点时间来熟悉它。2.3.1　打开 VBE 编辑器 要进入 VBE，首先必须启动 Excel 程序，启动 Excel 后，要切换到 VBE 窗口，常用的方法有以下几种。方法一： 按 <Alt+F11> 组合键。方法二： 依次执行【工具】→【宏】→【Visual Basic 编辑器】菜单命令，如图 2-3 所示。图 2-3　利用菜单命令打开 VBE 方法三： 右键单击工作表标签，执行【查看代码】菜单命令，如图 2-4 所示。图 2-4　利用右键菜单打开 VBE 方法四： 单击【Visual Basic】工具栏中的【Visual Basic 编辑器】按钮，如图 2-5 所示。图 2-5　利用 Visual Basic 工具栏打开 VBE 方法五： 单击【控件工具箱】中的「查看代码」按钮，如图 2-6 所示。图 2-6　利用控件工具箱打开 VBE 方法六： 利用【控件工具箱】新建一个 ActiveX 控件，双击控件打开 VBE 窗口，如图 2-7 所示。图 2-7　利用控件打开 VBE 2.3.2　主窗口 进入 VBE 后，首先看到的就是 VBE 的主窗口，主窗口通常由【工程资源管理器】、【属性窗口】、【代码窗口】、【立即窗口】、【菜单栏】和【工具栏】组成，如图 2-8 所示。图 2-8　VBE 的主窗口 2.3.3　菜单栏 VBE 的【菜单栏】和 Excel 2003 的菜单栏类似，包含了 VBE 中各种组件的命令。2.3.4　工具栏 默认情况下，【工具栏】位于【菜单栏】的下面，可以在【视图】→【工具栏】菜单里显示或隐藏它，如图 2-9 所示。图 2-9　显示或隐藏工具栏 2.3.5　工程资源管理器 在【工程资源管理器】中可以看到所有打开的 Excel 工作簿和已加载的加载宏，一个 Excel 的工作簿就是一个工程，工程名称为 "VBA Project（工作簿名称）"。【工程资源管理器】中最多可以显示工程里的 4 类对象，即 Excel 对象（包括 Sheet 对象和 ThisWorkbook 对象）、窗体对象、模块对象和类模块对象，如图 2-10 所示。图 2-10　工程资源管理器 但并不是所有工程里都包含这类对象，新建的 Excel 文件只有 Excel 类对象。2.3.6　属性窗口 可以在【属性窗口】中查看或设置对象的属性。2.3.7　代码窗口 【代码窗口】由对象列表框、过程列表框、边界标识条、代码编辑区、过程分隔线和视图按钮几部分组成，如图 2-11 所示。图 2-11　代码窗口栏 【代码窗口】是编辑和显示 VBA 代码的地方，【工程资源管理器】中的每个对象都拥有自己的【代码窗口】，如果想将 VBA 程序写在某个对象里，首先应在【工程资源管理器】中双击以激活它的【代码窗口】。反过来，如果想查看某个对象里保存有哪些程序，也必须先在【工程资源管理器】中双击以激活它的【代码窗口】。2.3.8　立即窗口 在【立即窗口】中直接输入命令，回车后将显示命令执行后的结果，如图 2-12 所示。图 2-12　使用立即窗口执行代码 【立即窗口】一个很重要的用途是调试代码，相应的内容请参阅第 7 章 7.3.4 小节。如果打开 VBE 窗口后，【立即窗口】（或其他窗口）没有显示，可以在【视图】菜单中设置显示它，如图 2-13 所示。图 2-13　利用视图菜单显示窗口

2.4　试写一个简单的 VBA 程序 运行 Excel 程序，新建一个工作簿，进入 VBE，让我们动手编写一个简单的程序，当程序运行后，用一个对话框说出现在的心情。2.4.1　添加或删除模块 因为 VBA 程序一般保存在模块里，所以在编写程序前，应先添加一个模块来保存它。添加模块 方法一： 利用菜单命令插入模块的具体操作如图 2-14 所示。图 2-14　利用菜单命令插入模块 方法二： 利用右键菜单插入模块的具体操作如图 2-15 所示。图 2-15　利用右键菜单插入模块 练习小课堂 怎样添加用户窗体和类模块？试一试，然后再继续后面的内容。参考答案 方法一： 右键单击【工程资源管理器】中的空白处，在【插入】菜单选择要插入的对象； 方法二： 单击菜单栏中的【插入】菜单，选择要插入的对象。方法参照 2.4.1 小节中插入模块的方法。删除模块 如果工程中有多余的模块，可以删除它。方法一： 利用文件菜单移除模块的具体操作如图 2-16 所示。图 2-16　利用文件菜单移除模块 方法二： 利用右键菜单移除模块的具体操作如图 2-17 所示。图 2-17　利用右键菜单移除模块 注意： 删除模块后，同时也将删除保存在该模块中的所有程序。2.4.2　动手编写程序 Step 1： 在代码窗口中添加一个空过程，如图 2-18 所示。图 2-18　插入空过程 当然，你也可以在【代码窗口】中手动录入这些代码。Step 2： 将下面的代码写到前文两行代码的中间，如图 2-19 所示。图 2-19　添加代码后的过程 Step 3： 运行过程，如图 2-20 所示。图 2-20　运行程序

2.5　解除疑惑，一「键」倾心 对刚刚涉足 VBA 世界的我们，面对满眼陌生的代码，类似这样的困惑总是很多。如果你想知道类似 MsgBox 这样的关键字是什么意思，F1 键会是你最的好帮手，如图 2-21 所示。图 2-21　利用 F1 键查询 MsgBox 函数的帮助信息 帮助是 Excel VBA 自带的一本百科全书，它能有效地帮助你解答在学习或编程过程中遇到的许多困惑。记住 F1 键，它是打开这本书的一把「金钥匙」。
