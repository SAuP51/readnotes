# 08. 网络

这一章，我们介绍几种家庭、办公室或者宿舍里常见的联网技术。我们正是通过这些局域网与互联网连接起来的。

所有通信系统都有一些共性。从最根本处说，它们都是把信息转换成物理表现形式，以便通过某种媒介传输。而在传输目的地，它们再把这些物理形式转换回人们能够理解的形式。

带宽是最基本的一个特性，它描述的是系统传输数据的速度。在供电条件不好、环境很差的情况下，某些系统的带宽可能只有每秒几比特。而与之形成鲜明对比的，则是带宽高达每秒数万亿比特的光纤网络。

等待 或延迟衡量的是特定信息块通过系统所需要的时间，用卡车满载硬盘穿越整个国家，带宽显然是巨大的，但延迟也是极高的。

抖动，即延迟的可变性，对某些通信系统（特别是语音通信），同样也很重要。

信程指的是某种技术能够在多大地理范围内实现联网。有些网络的范围不过数米，有些网络则可以覆盖全球。

还有一些特性表明发送端口是会向所有接收端口都发送广播消息（跟收音机原理相同），还是会点到点地传输，或者只能在特殊的发送方和接收方之间通信。广播网络固有的问题就是容易被监听，因而遭遇攻击的可能性大，存在安全隐患。为此，必须采取预防措施，以备不测。当然，成本也是要考虑的一个主要因素。

8.1 电话与调制解调器

电话网作为一个覆盖全球的大型网络，从一开始只传送语音，到后来同时传输语音和可观的数据，为人类做出了贡献。大约有近 20 年的时间，人们都是通过电话网把家用计算机接入互联网的。

在家庭中，电话系统传送模拟的声音信号，不传输数据。因此，必须有一种设备来实现数字化信息（比特）和模拟的声音之间的转换，才能利用电话网络传输数据。改变要通过声音信号传输的信息的形式叫调制。相反，把这种形式再转换成比特叫解调。而能够完成调制和解调功能的设备就叫调制解调器（modem）。过去的电话调制解调器是一个价格不菲的大型机柜，后来逐步缩小为一个小芯片，成本也极其低廉。不过，通过有线电话上网的方式在今天已经不常见了，因此配备调制解调器的计算机也越来越少。

使用电话网络传输数据有很多缺点。因为要占用电话线路，所以假如你家里只有一根电话线，那你在上网的同时就不能打电话。不过，对多数人来说，最大的问题还是通过电话线传输数据非常慢。最大带宽不过 56 Kbit/s（即每秒 56 千比特每秒，这里小写的字母 b 代表 bit，一般用大写字母 B 表示 byte），或 6~7 KB/s。那么下载一个 20 KB 的网页，得花 3 秒钟，要是 400 KB 的图片呢，差不多要 60 秒。赶上升级软件，轻而易举就得花几个小时。总之，速度太慢。在普遍使用调制解调器上网的年代，大部分时间内的「长途拨号」（实际上也远不到哪儿去）费用也是相当昂贵的。AOL 等提供拨号上网服务的公司，必须提供一系列的市话号码供用户选择，才能让用户免交长途费。即便如此，电话公司也不情愿，因为用户上网占用线路的时间通常都比打电话长，而这些时间又不会产生额外的收入。如前所述，电话网络是为 3 分钟左右的语音通话而非几个小时的数据通信设计的，因此市话一直都按固定标准收费。

8.2 有线和 DSL

电话线传输信号的速度限制是与生俱来的。因为电话只需传输语音，所以有 3 kHz 的带宽就够了。即使再怎么编码、压缩，或者想其他办法，最终都不可能让速度超过 56 Kbit/s。为此很多人选择了另外两种上网方式，带宽至少是电话线的 10 倍。

首先是使用千家万户都安装的有线电视电缆。这种电缆可以同时传输数百个频道的信号，因此有足够的剩余容量让家庭用户来回传送数据。通常的有线电视网的传输速度都以 Mbit/s 计。来回转换有线信号与比特数据的设备叫有线调制解调器。这个名字显然是因为它与电话调制解调器功能相近，当然其速度快多了。

这里所谓的速度快，某种意义上是一种错觉。无论你看不看电视，同样的电视信号都会广播到千家万户。另一方面，虽然大家共享有线电缆，但进入我家的数据就是我的，它不会同时进入你家成为你的数据。换句话说，用户之间没办法共享内容。而数据带宽必须由有线数据的用户共享，如果我用多了，那留给你的就少了。更可能的情况是我们两家的带宽都会变少。值得庆幸的是，我们相互之间倒是不会干扰。通过有线电缆共享上网与航空公司或者酒店有意安排的超额预订非常相似。他们知道预订的人不会全都如约而至，因此超额出售不会出问题。这种策略也同样适用于通信系统。

说到这，又出现了另一个问题。虽然我们实际上都在接收相同的电视信号，但我不希望自己的数据跑到你家去，而你也不希望你的数据跑到我家来。毕竟，这些数据都是个人隐私，比如电子邮件、在线购物订单、银行卡信息，甚至包括自己绝不想让任何人知道的娱乐癖好。这个问题可以通过加密解决，加密可以防止他人偷看我收到或发出的数据。关于加密的话题，我们将在第 10 章讨论。

这里还有一个小插曲。最早的有线网络是单向传输的，即信号会广播到所有家庭。这种网络容易铺设，但用户却不能向有线公司发送信息。有线公司必须解决这个问题，因为视频点播收费和其他服务需要从用户那里接收信息。于是有线网络就变成了双向的，这就为利用有线网络来实现计算机之间的数据通信提供了条件。有时候，「双向通信」会分别使用不同的通道。比如，某些卫星电视系统使用电话线作为上传通道。虽然上网速度慢得让人无法接受，但对于下订单购买电影来说是够用了。而且，上传速度大大低于下载速度也是惯例，所以我们上传图片和视频才会那么慢。

另一种对家庭来说经济适用的联网技术是 DSL（Digital Subscriber Loop，数字用户环路），有时候也叫 ADSL（其中 A 代表 asymmetric，意为「非对称」，因为下载带宽比上传带宽高）。DSL 利用的也是家庭中原有的基础设施 —— 电话线路，而且提供的服务与有线电缆上网相同。但 DSL 与有线电缆相比还是有几个主要的区别。

DSL 在使用电话线发送数据时不会干扰语音信号，这种技术可以让用户打电话和上网冲浪两不误。但 DSL 有距离限制，一般城市或郊区的居民，房子距离本地电话公司的交换机房不超过 5 公里，可以使用 DSL。如果超过这个距离，就没办法用了。

DSL 的另一个优点是非共享。因为它使用电话线，而且也没有其他数据传输服务会同时占线，所以你不会跟自己的邻居共享带宽，你的数据也不会发送到他们家去。DSL 同样需要一个调制解调器，再配合电话公司机房里对应的设备，才能把信号调制成适合在电话线上传输的形式。除此之外，DSL 和有线电缆再没有什么分别了。而且它们的收费标准也差不多，尤其在二者有市场竞争的地区。

这些系统的容量由硬件决定，到了一定的限度之后，再为用户提供更大的容量就不必再购置新设备或增加新投入了。为此，供应商可以玩一个很讨巧的游戏，他答应你只要多掏钱就可以享用更高的带宽。而实际上，他收了钱之后，什么设备也不用添置，只消改动数据库里的一个字段，把你的带宽设置加大就行了。

这种系统都有这个共同的特点，即任何时候都有可用的资源。你想打电话就打电话，想上网就上网。

在技术不断进步的今天，很多地方已经实现了光纤入户，告别了同轴电缆和铜线上网时代。与同类技术相比，光纤传输数据的速度要快得多。光纤中的信号是以光脉冲形式传输的，传输通道是一条极细又极纯净的玻璃纤维，损耗很低。光纤信号在没有中继器的条件下可以传输数公里远。1990 年代早期，我参加了一个「光纤入户」的试验性研究项目，因此我家有 10 年时间在使用（据说是）160 Mbit/s 的光纤上网。虽然我因此有了雄厚的吹牛资本，但可惜如此之高的带宽在当时却没有什么用武之地。

8.3 局域网和以太网

电话、有线电缆和 DSL 等联网技术都可以把计算机连接到一个大型系统，但通常会有一定的距离限制。回顾历史，另外一个网络发展的分支 —— 以太网，最终成为了今天最常用的系统。

1960 年代末至 1970 年代初，施乐公司的帕洛阿尔托研究中心（PARC，Palo Alto Research Center）开发出一台个人计算机，取名「阿尔托」。这台计算机当时只是一个实验用具，但后来却引发了诸多领域的一系列革命。阿尔托拥有世界上第一套窗口系统，配有第一台位图显示器（不局限于显示字符）和第一台激光打印机。尽管相对于今天的个人计算机而言，阿尔托的价格非常昂贵，但 PARC 的研究人员却人手一台。

于是，怎么把所有阿尔托连到一起共享资源（比如打印机）就成了一个问题。而解决方案就是 1970 年代早期由鲍伯·梅特卡夫（Bob Metcalfe）和大卫·博格斯（David Boggs）发明的一种联网技术，叫做以太网（Ethernet）。以太网可以在通过同轴电缆相连的计算机之间传送信号。从外观上看，当时的同轴电缆与今天的有线电视使用的同轴电缆很相近。而信号则是基于强度和极性编码比特值的脉冲电压。最简单的情况就是用正电压表示比特 1，用负电压表示比特 0。每台计算机都通过一个设备连接到以太网，而且各有一个独一无二的数字标识符。某台计算机要向另一台计算机发送消息时，它会先通过监听信号来确定没有其他计算机正在向同一台计算机发送消息。然后，它把消息加上接收方的数字标识符广播到电缆中。电缆上连接的所有计算机都可以监听到这条消息，但只有指定的那台计算机才会读取和处理该消息。

每台以太网设备都有一个 48 位的数字标识符，这个标识符独一无二，叫做（以太网）地址。因此，以太网最多可以连接 248（约为 2. 8 × 1014）个设备。你的计算机也有以太网地址，这些地址通常会印刷在机器底部。当然，在 Windows 中使用 ipconfig，在 Mac 上使用 ifconfig 也可以显示这些地址。而且经常会有两个地址，一个是有线网卡地址，一个是无线网卡地址。以太网地址都是以十六进制数字表示的，而且两位数字表示一个字节，因此总共是 12 位十六进制数字。比如，我的笔记本电脑的以太网地址就是 00096BD0E705，这肯定跟你计算机的地址不一样。

了解了前面讨论的有线网络，也就不难想象以太网也存在同样的两个问题：隐私和资源争用。

资源争用可以借助一个很巧妙的办法来处理：如果某个网络接口在发消息时检测到其他接口正在发，它会先停下来，等一小会儿，然后再发。如果等待时间是随机的，而且会随着尝试次数逐渐加长，那么最终所有消息都会发出去。

隐私在最初的时候并不是问题，毕竟所有人都是同一家公司的员工，还都在同一栋楼里工作。不过到了今天，隐私确实是问题了。因为把以太网的接口设定为「混乱模式」后，就可以读取网络上所有消息的内容（不限于发给它的内容），所以很容易就会与一些重要的个人信息（如未经加密的密码）不期而遇。这种被称为「嗅探」的行为曾经是大学宿舍里使用以太网所面临的主要安全问题。好在，可以通过对电缆中的所有内容加密来解决问题，尽管说服人们使用加密软件并非易事。

想体验一下「嗅探」的感觉？好，推荐你试试一个名叫 Wireshark 的免费软件，它可以显示以太网（包括无线网）流量的各种信息。在发现学生们眼睛只盯着自己的笔记本电脑而不看我的时候，我偶尔会在课堂上播放一段 Wireshark 的演示。演示虽短，但效果很好，学生们明显会被吸引过来。Firefox 有一个叫 Firesheep 的插件更牛，不仅可以显示谁在访问什么站点，而且还可以让你轻松地伪装成其中的某个用户。Firesheep 可以监控开放（未加密）的网络，从 Facebook、Twitter 及其他站点收集认证信息，用以冒充真实的用户。随便找一个人流密集的地方，几分钟内就能捕获一二十个连接，然后只须点一下按钮就可以悄无声息地伪装成其中某个人。（警告：这样做很可能给你自己惹上麻烦。）

以太网中的信息以包的形式传输。顾名思义，包（packet）就是包装比特或字节信息的一种容器，其中信息的格式经过了精确的定义，以便发送时打包，接收时拆包。最形象的比喻就是把包想象成一个信封（或者明信片），上面写着寄信人地址、收信人地址、内容摘要以及其他信息，而且格式都是标准的。就跟联邦快递取货送货时使用的包裹一样。

包的格式因网络不同而异。拿以太网来说，每个包最小 64 字节，最大 1518 字节。其中源地址和目标地址各占 6 个字节，还有其他信息。因此每个包最多会有 1500 字节用于保存数据。

以太网出人意料地获得了巨大成功。它最早被集成到了商业产品中（还不是通过施乐，而是通过梅特卡夫创办的 3COM 公司），随着时间的推移，数不清的制造商卖出的以太网设备已达数十亿台。早期以太网设备的带宽是 3 Mbit/s，而今天 100 Mbit/s 乃至 10 Gbit/s 带宽的设备都已经随处可见。与调制解调器一样，第一代以太网设备既笨重又昂贵，现如今的以太网卡呢，不过是一小块便宜的芯片而已。

最早的同轴电缆已经被一种 8 芯电缆取代，电缆两头分别是一个常见的 8 针 RJ45 水晶头。这就是我们今天常说的网线。通过网线，可以把设备连接到集线器或交换机，后者会向相连的其他网络发送收到的数据。你的计算机多半都会有一个网口，可以插上标准的水晶头。这种网口也常见于无线基站、电缆调制解调器和 DSL 调制解调器等模拟以太网的设备。

以太网的传输距离也是有限制的，通常在几百米左右。通过硬件（中继设备）连接不同的网段并转发数据包，可以扩大传输范围。智能中继设备可以自动判断主机位置，只将包发送到它应该去的地方。所有这些细节对最终用户都是隐藏的，只有系统管理员在排除故障时才会关心。

8.4 无线网络

以太网有一个明显的缺点 —— 离不开网线。这些网线要么在墙壁里斗折蛇行，要么在地板下匍匐蜿蜒。有时候（我说的是我个人的经历），网线还会穿墙越室，顺梯而下，赫然招摇于餐厅、厨房和客厅之中。连接到以太网的计算机一般都放在几个固定的地方，不能轻易移动。如果你偏爱把笔记本搁在大腿上，那这些网线可真够烦人的。

无线网络同时解决了上网和移动的问题。无线网络（当然不用网线）通过无线电波传输数据，只要信号强度足够，在任何地方都可以通信。无线信号覆盖的范围从几十米到几百米不等。与电视遥控器使用的红外线不同，无线信号不一定非要直线传播。但是，金属物（比如墙壁和隔断）和混凝土结构（如楼板）会干扰无线信号，导致其实际覆盖的范围要远小于在空旷环境下所能覆盖的范围。

从技术角度讲，无线网络利用电磁波传送信号。电磁波是特定频率的电波，其振动频率以 Hz 来衡量（读者可能更熟悉广播电台常用的 MHz 或 GHz，比如北京交通广播电台的频率是 103.9 MHz）。在发送信号之前，首先要通过调制把数据信号附加到载波上。比如，调幅（AM）就是通过改变载波的振幅或强度来传达信息，而调频（FM）的原理则是围绕一个中心值来改变载波的频率。接收器接收到信号的强度与发射器的功率成正比，与到发射器距离的平方成反比。由于存在这种二次方递减的关系，距离发射器的距离增加一倍，接收器接收到的信号强度就只有原来的四分之一。无线电波穿越各种物质时强度都会衰减，物质不同衰减程度也不同，比如说金属就会屏蔽任何电波。高频比低频更容易被吸收，二者在其他方面都一样。

无线联网对可以使用的频率范围 —— 频段，以及使用多大的功率发送电波都有严格规定。频段分配始终都是一个有争议的话题，因为各种需求总会发生冲突。频段在美国由 FCC（Federal Communications Commission，联邦通信委员会）等政府机构负责分配，联合国下辖的 ITU（International Telecommunications Union，国际电信联盟）负责制定国际协议。

今天，计算机网络使用的无线标准有一个朗朗上口的名字，叫 IEEE 802.11b/g/n。但民间流行的称呼则是 Wi-Fi（音 wai-fai）。IEEE 指的是 Institute of Electrical and Electronics Engineers，即电气与电子工程师协会。这个协会除了开展其他工作之外，还负责制定一系列电子方面的标准，包括无线通信标准。802.11 是无线通信标准的编号，而这个标准由几个部分组成，其中 802.11b 定义的是 11 Mbit/s 标准，802.11g 定义 54 Mbit/s 标准、802.11n 定义 600 Mbit/s 标准。这些带宽都是名义上的，实用条件下没那么高，大约只有名义带宽的一半。

无线设备可以把数字化信息编码为适合通过无线电波传输的形式。802.11 无线网络中的数据包与以太网中的数据包类似，因此可以用无线连接代替以太网连接。两者的传输距离也相近，只不过无线网络少了电缆的羁绊。

无线以太网设备发射的电波频率为 2.4~2.5 GHz，某些 802.11 设备的频率会达到 5 GHz。所有无线设备的频率都局限于这一较窄的范围内，冲突的可能性大大增加。更糟的是，有些无线电话、医疗设备，甚至微波炉也跟着凑热闹，同样使用这一频段。有一次我在使用厨房里那台旧笔记本时无线连接突然断了，后来才发现是我用微波炉加热咖啡的缘故。30 秒钟的加热就足以让笔记本断开无线连接。

接下来我给大家简要介绍三种使用最广泛的无线联网技术。首先就是蓝牙，这个名字源自丹麦国王 Harald Bluetooth（约公元 935-985 年）。蓝牙技术是为近距离临时性连接而发明的，使用与 802.11 相同的 2.4 GHz 频段。蓝牙连接的距离是 1 到 100 米，具体取决于功率大小，数据传输速度为 1 到 3 Mbit/s。使用蓝牙技术的设备主要包括无线麦克风、耳机、键盘、鼠标、游戏手柄，功率相对较低。

第二种技术是 RFID（radio-frequency identification），即无线射频识别，主要用于电子门禁、各种商品的电子标签、自动收费系统、宠物植入芯片，以及护照等身份证明。RFID 标签其实就是一个小型无线信号收发装置，对外广播身份信息。被动式标签不带电源，通过天线接收到的 RFID 读取器广播的信号来驱动。RFID 系统使用多种不同的频率，比较常见的是 13.56 MHz。RFID 芯片让秘密监视物体和人的行踪成为可能。植入宠物体内的芯片就是一种常见的应用，我家的小猫身上就有一颗。你猜得对，已经有人建议也给人植入这种芯片了。至于动机嘛，就不好说了。

最后一种是 GPS（Global Positioning System，全球定位系统），它是一种重要的单向无线系统，常见于汽车和手机导航系统中。GPS 卫星会广播精确的时间信息，而 GPS 接收器会根据它从三四颗卫星接收到信号的时间来计算自己在地面的位置。然而，GPS 只接收信号不发送信号。以前曾有一个关于 GPS 的误解，认为它能悄悄地跟踪用户。我给大家摘录一段《纽约时报》几年前闹的一个笑话吧：「有些（手机）依靠全球定位系统，也就是 GPS，通过向卫星发送信号来精确地定位用户。」这完全是误解。要想利用 GPS 跟踪用户，必须得有地面系统（比如手机）转发位置信息。正如下一节所要讨论的，手机与基站之间保持密切通信，因而可以（而且确实会）不断地报告你的位置。只不过有了 GPS 接收器之后，它所报告的信息可以更加精确。

8.5 手机

对大多数人来说，最常用的无线设备就是手机了。这种设备曾被叫作「蜂窝电话」或「移动电话」，在 1980 年代还是个稀罕物。如今，地球上半数以上的人都与它须臾不离了。蜂窝电话是本书介绍的所有主题中最值得好好讨论的一个典型，它不仅涉及硬件、软件、通信，还关乎社交、经济、政治，甚至法律。

第一代蜂窝电话是由 AT&T 在 1980 年代早期研制成功的。当时的电话机又大又笨重，而蜂窝电话的广告中则有一个人手提一个装着电池的小箱子，站在一辆携带着天线的汽车旁边。何谓「蜂窝」？因为频段和无线电的覆盖范围都是有限的，因此就要把整个地区划分为蜂窝状的许多小区。可以将每个这样的小区想象为六边形，然后中央有一个基站，相邻的小区之间通过基站相连。打电话的时候，手机会与最近的基站通信。当用户移动到另一个小区时，进行中的通话就由原来的小区移交给新小区，但这个切换用户一般觉察不到。

由于接收功率会随着距离的二次方衰减，所以位于既定频段中的频带在不相邻的小区内可以重用，而不会相互干扰。这就是可以高效利用有限频段的秘密所在。大家看下面这幅示意图，1 号小区中的基站与 2 到 7 号小区中的基站不会使用相同的频率，但可以跟 8 到 19 号小区中的基站使用相同的频率，因为与它们之间的距离足以避免干扰了。「蜂窝」中小区的实际形状要取决很多因素，比如天线的辐射图形。这张图只是一种理想化的结果。

实际上，小区覆盖面积的大小并不相同，从几百米到几十公里的都有。具体取决于通信量、地形、障碍物，等等。

蜂窝手机是常规的电话网络的一部分，只不过连接这个网络不是靠电话线，而是靠基站发射无线电波。蜂窝电话的核心优势就是移动性。手机用户可以长距离（通常也是高速）旅行，中间会穿越很多小区，到了目的地也不一定会收到提醒。比如，我们坐了很长时间的飞机，当飞机降落在目的地之后再打开手机时不会觉得有任何异样。

手机使用的频段很窄，传输信息的能力有限。因为要使用电池，所以打电话时发射的都是低功率无线电波。而且根据法律规定，为了避免与其他无线设备发生干扰，它们的传输功率也受到限制。电池容量越大，待机时间越长，但手机也会更大更沉。这也是一个权衡。

手机在世界的不同地区会使用不同的频带，但一般都在 900 MHz 左右。每个频带被分成多个信道，每次通话时，收发信号各占用一个信道。发送呼叫信号的信道由小区中所有手机共享，在某些系统中这个信道也可以同时用于发送短信和数据。

每个手机都有唯一的识别码（可不是说手机号啊），相当于以太网的地址。启动手机后，它就会广播自己的识别码。距离最近的基站接收到手机信号后，会通过后台系统验证该识别码。随着手机移动，基站实时更新其位置信息，并不断向后台系统报告。如果有人呼叫该手机，后台系统就能通过一直与它保持联系的基站找到它。

手机与基站通信时的信号强度很高。但手机会动态调整功率，在距离基站较近时降低功率。这样不仅可以省电，也可以减少干扰。待机时的耗电量远远比不上一次通话，而这也是为什么待机时间以天为单位，而通话时间以小时为单位的原因。如果手机所在小区信号较弱或根本没有信号，那么它就会因为拼命查找基站而大量耗电。

美国使用了两种完全不同的手机通信技术。AT&T 和 T-Mobile 使用 GSM（Global System for Mobile Communications，全球移动通信系统），这是一种在欧洲使用非常普遍的系统，它把频带分成很窄的信道，在每个信道内依次附加多路通话。GSM 是世界上应用范围最广的系统。Verizon 和 Sprint 使用 CDMA （Code Division Multiple Access，码分多址），这是一种「扩展频段」技术，它把信号扩展到频带之外，但对不同的通话采用不同的编码模式进行调制。这就意味着，虽然所有手机都使用相同的频带，但大多数情况下通话之间不会发生干扰。

GSM 和 CDMA 都会利用数据压缩来尽可能减少封装信号的比特量。对于通过嘈杂的无线电信道发送数据时无法避免的错误，再添加错误校验来解决问题。

手机带来了一系列难解的非技术问题，频段的分配显然是其中之一。在美国，政府限制每个频带最多只能有两家公司使用指定频率。因此频段是非常稀缺的资源。

手机信号发射塔的位置同样如此。信号发射塔作为户外建筑算不上漂亮，很多地区为此拒绝在自己的地界上搭设这种东西。当然，他们依旧希望得到高品质的手机通话服务。下面这张照片中是「弗兰肯松树」，即勉强能伪装成树的信号发射塔。

电话公司一般会获准在需要的地块搭建信号发射塔，但有时也会经过一番旷日持久的司法程序才能获批。如果它们从那些非纳税机构（比如教堂）租得了架设手机天线的空间，那么发射塔的塔尖经常会是当地最高的结构，就算不想煞风景也不行。

说到社会，手机给我们生活的方方面面带来了翻天覆地的变化。现在的青少年平均每天要发送 50 到 100 条短信（因为提供短信服务所需的成本极低，所以这已经成为电话公司利润极高的收入来源）。iPhone 和 Android 智能手机甚至改变了人们对手机的认知。人们使用手机不再是为了打电话，而是为了其他功能。智能手机还改变了软件开发生态。如今，手机可以上网、收邮件、购物、娱乐和社交，虽然屏幕小了点，但已然成为访问互联网的一股重要力量。没错，笔记本电脑和手机之间存在交叉，因为后者越来越强大，而且便于携带。手机还集成了其他很多设备的功能，包括手表、地址簿、相机、音视频播放器、GPS 导航仪，不胜枚举。

有些手机功能，比如下载电影，需要很大带宽。平板电脑也一样，它不太用于语音传输，主要用在了跟手机一样的其他功能上。随着手机和平板的日益普及，对现有通信设施的压力也会与日俱增。在美国，运营商也开始根据使用量制定阶梯价格和带宽上限，很明显是为了抑制不必要的带宽占用，特别是那些下载大电影的需求。不过这些限制并没有区分忙时闲时，因此起不到鼓励错峰下载的作用。把手机连到笔记本电脑上，让笔记本通过手机上网已经成为可能。运营商不提倡这种使用方式，为此正在谋划着加以限制和额外收费，毕竟这种方式也会占用大量带宽。

8.6 小结

频段是无线联网系统的关键资源，人们对它的需求远远得不到满足。很多政治和经济组织都在激烈争夺频段空间。与此同时，广播公司和电话公司等既得利益集团则在抗拒变化。一种解决方案是有效地利用现有频段。手机通信最早使用的模拟编码技术已被淘汰，当前使用的是更节省带宽的数字系统。现有频段也可能会改换用途，比如 2009 年美国有线电视网经过数字化改造释放出一大块频段空间，成为很多梦寐以求者竞相争夺的目标。当然还可以使用更高的频率，但频率越高覆盖范围越小。

无线网络是广播媒体，任何人都可以监听。加密是保护无线信息和控制访问的唯一途径。事实证明，最初针对 802.11 网络的无线加密标准（WEP，即 Wired Equivalent Privacy，有线等效保密）存在重大缺陷。后来出现的 WPA（Wi-Fi Protected Access，受保护的 Wi-Fi 接入）等加密标准则要安全得多。有些人的无线网络还是开放的，即没有采取任何加密措施。这样一来，附近的任何人不仅可以监听，还能免费使用其无线服务。「沿街扫描」（war driving）指的是驾车寻找那些有开放网络的地方，享用免费服务。有趣的是，与几年前相比，现在的开放网络似乎少多了，或许是人们已经意识到被窃听和搭便车的风险。

咖啡店、机场等场所的免费 Wi-Fi 服务反而越来越多。咖啡店希望顾客能在自家门店里使用笔记本来消磨时间（顺便也消费几杯昂贵的咖啡）。要是不加密的话，在这些网络上传输的信息也将是公开的，并非所有服务器都会自动加密。当然，知道了有 Firesheep 这种软件存在，那最好就不要使用公共网络发送敏感信息了。

尽管存在这样那样的问题，但无线仍然是未来互联网的趋势。与此同时，有线连接必定也是互联网不可或缺的后台支撑。

第 9 章 互联网

前面的章节描述了以太网和无线网等本地网络技术。我们知道，电话系统把全世界的电话机连在了一起，那么如何通过计算机网络把全世界的计算机连接起来呢？怎样才能扩大网络规模，把不同的本地网络连接在一起？如把一幢大楼里的所有局域网都连通，或者用我家的计算机连接到另一个城市里你家的计算机，或者把分别位于加拿大和欧洲的公司网络连成一体。如果底层网络采用了不同的技术，不同的网络又是怎样互通的？当接入的网络和用户越来越多、距离越来越远、所用的设备和技术变化日新月异时，怎样才能从容地扩展网络来满足这些变化的要求？

我们说，「互联网」就是解答以上所有问题的一个答案。实际上，由于它实在太成功了，所以在大多数情况下，它就是唯一的答案。

互联网并不是一个巨型网络，更不是一台巨型计算机。它由定义了网络和其中的计算机相互通信规则的标准连接在一起，是一个松散、非结构化、混乱、自组织的网络集合。

如何才能把光纤网、以太网、无线网等不同物理属性的网络连接起来，甚至在它们之间相隔很远时也能连通？我们需要用名字和地址来识别网络和计算机，就像使用电话号码和电话簿那样。我们需要在间接相连的网络之间找到通信的路径，需要就信息采用何种格式传输达成协议，还需要在错误处理、时延、过载等一些不太容易想到的问题上达成协议。没有这些协议，就很难甚至无法进行通信。

所有的网络，尤其是互联网，都需要按照协议的约定来处理数据格式、谁先发起请求、后续可以跟随什么样的应答、错误如何处理等方面的问题。在这里，「协议」这个词跟生活中的意思差不多，表示用来跟对方交谈的一组规则。但是，网络协议是基于技术考虑而非社会习俗的，所以它要比最严格的社会结构还精确。

互联网必须满足以下这些不是那么显而易见的规则：互联网的所有接入方都要达成同样的协议和标准，如信息按什么格式组织、在计算机之间怎样交换，如何识别计算机身份并授权，以及错误发生了该如何处理。考虑到既得利益者的影响，网络协议和标准的达成可能会相当复杂：公司要制造设备、售卖服务，专利和技术持有者想到处渔利，政府则想要监视和控制国际和国内的网络信息。

还有稀缺资源的分配问题。在这方面，无线服务的频段就是一个显而易见的例子，网站域名的管理也不能放任自流。由谁来分配这些资源，按什么原则分配？要使用这些有限的资源，应该谁向谁支付，支付什么？资源分配中遇到纠纷谁来裁决？裁决时以哪套司法系统为依据？制定所有这些规则的可以是政府、公司、行业协会，也可以是像联合国下属的国际电联这种名义上的非营利性或中立团体。但无论谁制定规则，最终所有的参与者都要达成一致，照章办事。

显然这些问题都是能解决的，毕竟有先例在：遍布全球的电话系统就把散布在各个国家的设备成功地连接了起来。尽管互联网和电话系统并无本质区别，但互联网比电话系统更新潮、规模更大、变化更快，也更杂乱无章。这个行业对所有人都是开放的，而通信业则是由传统电信公司组成的受控环境，其中大部分公司是由国家垄断或者牢牢控制的。

9.1 互联网概述

在深入了解互联网的技术细节之前，让我们先看看其概貌。互联网初创于 1960 年代，其初衷在于建造一个网络来连接分散在不同地理位置的计算机。由于项目的大部分资金来自美国国防部的高级研究计划署（Advanced Research Project Agency，缩写为 ARPA），最初建成的网络就叫做 ARPANET。1969 年 10 月 29 日，ARPANET 上的第一条消息从加州大学洛杉矶分校发出，到达 550 公里外的斯坦福大学。这一天可以看成互联网的诞生日。

ARPANET 从设计伊始，就具有能处理网络任何局部错误的健壮性，能在网络出现问题时依然成功路由数据。经过多年发展，原始 ARPANET 中的计算机逐步更新换代，所用的技术也推陈出新。网络覆盖范围也从最初只连接美国部分大学计算机科学系和科研机构，到 1990 年代逐步扩大到商界，最终发展成为互联网。

如今的互联网由成千上万个松散连接的独立网络构成，其中的每个网络都连接到另外一个或多个网络。邻近的计算机通过以以太网为主的局域网连接，然后网络和网络再连起来。网络连接采用的设备叫网关或 路由器，其实就是一种专用的计算机，用来把组成信息的数据包从一个网络发送到下一个网络（维基百科上说网关是通用设备，而路由器是专用的，在本书里就不作区分通称为「网关」了）。网关之间互相交换着路由信息，这样它们就至少知道哪些网络与本地网络相连并可以被访问到。

每个网络都可以连接上许多计算机主机（以下简称「主机」），比如家里、办公室里、宿舍里的 PC 和 Mac。家用计算机可以通过无线网卡连接到路由器，然后路由器通过电缆或 DSL 链路连接到互联网服务提供商（Internet Service Provider，缩写为 ISP）。办公室的计算机则可用有线网卡与以太网连接。

上一章已经提到，信息在网络之间游弋的时候，被分作称为包（packet）的小块。一个包就是按特定格式组织起来的一串字节。不同设备使用不同的包格式。包的内容中首先是地址信息，用于标明这个包的发送方和接收方；然后是与这个包本身有关的信息，比如包的长度；最后，通常也是最大的部分，是包输送的信息，即有效载荷。

在互联网上，输送数据的包叫做 IP 包（IP 即 Internet Protocol，互联网协议）。所有的 IP 包都是一样的格式。在具体的物理网络上，IP 包通过一个或多个物理包来传输。比如，由于最大的以太网包是 1500 字节，远小于最大 IP 包的 65 000 字节，所以一个较大的 IP 包会被切分成多个较小的以太网包进行传输。

每个 IP 包会经过多个网关，每个网关都把这个包传递给离包的最终目的地更近的下一个网关。一个包在网络中的旅程可能会经过 20 个网关，这些网关很可能是不同国家的公司或研究所拥有和运行的。

要让这一切运转起来，我们需要以下机制。

地址。就像电话号码一样，每台主机都必须有一个辨识身份的地址，才能跟互联网上的其他主机区分开来。这个辨识号码叫做 IP 地址，长度为 32 位（4 字节）或 128 位（16 字节）。较短的地址用于互联网协议版本 4（IPv4），长的则用于版本 6（IPv6）。IPv4 已使用多年，现在仍占统治地位，但由于大部分 IPv4 地址都已经分配出去了，网络地址迁移到 IPv6 的进程正日益加快。

IP 地址和以太网地址类似。IPv4 地址通常用其 4 字节的值表示，其中每个字节对应一个十进制数，数与数之间用句点分割，如 128.112.132.86 就是普林斯顿大学网站 www.princeton.edu 的 IPv4 地址。这种奇怪的记法叫点分十进制表示法，相比纯十进制或十六进制数值更好记，因而得到广泛的使用。下面是分别用点分十进制、二进制和十六进制表示这个 IP 地址的例子：

十进制 128 .112 .132 .86

二进制 10000000 01110000 10000100 01010110

十六进制 80 70 84 56

IPv6 地址是这个样子：2620:0:1003:100c:9227:e4ff:fee9:05ec，看上去更难理解，所以我们暂时先不讨论。

IP 地址的分配机制是，先由一个中心权威机构把连续的 IP 地址段分配给某个网络的管理员，再由管理员把单个 IP 地址分配给网络里的主机。这样，每台主机就有一个基于它所在网络的独一无二的地址。对台式机来说，IP 地址可能是固定的；但移动设备往往使用动态地址，其 IP 地址至少在设备每次重新连接到互联网时会改变。

名字。由于人们不太擅长记忆无规律的 32 位数字，哪怕写成点分十进制也不好记，因此，要让人们直接访问一台主机，必须给它取个名字才方便。比如，像 www.stanford.edu 和 microsoft.com 这种常见的名字，我们称之为域名。域名系统（Domain Name System，缩写为 DNS）用于将名字转换为地址，是互联网基础设施的重要组成部分。

路由。必须有一种机制，能为每个包查找从源地址到目标地址的路径。前文提到的网关就提供了这种功能。网关之间持续交换路由信息，即互联网上网络和设备的相互连接情况，并根据路由信息把收到的每个包转发到下一个离最终目的地更近一些的网关。

协议。最后，为了使信息在不同计算机之间成功复制，必须有一些规则和步骤，用来准确描述上述机制和其他互联网组件是如何协作的。

互联网的核心协议称为 IP，该协议为信息传输定义了统一的传输机制和通用的格式。不同类型的物理网络用各自的底层协议来输送 IP 包。

在 IP 协议之上是传输控制协议（Transmission Control Protocol，缩写为 TCP），该协议利用 IP 协议来提供可靠的传输机制，以便能从源地址向目标地址发送任意长度的字节序列。在 TCP 协议之上，更高层的协议利用 TCP 协议来提供那些我们看起来是「互联网」的服务，如网页浏览、电子邮件、文件共享等。除此之外，互联网还有很多其他协议。例如，IP 地址的动态分配是通过 DHCP 协议（Dynamic Host Configuration Protocol，动态主机配置协议）来处理的。所有这些协议合起来就定义了互联网。

下面我们会详细探讨上述每个话题。

9.2 域名和地址

谁制定规则？谁控制名字和数字地址的分配？谁负责管理互联网？长期以来，互联网由一小群技术专家以松散合作的方式来管理。互联网的大部分核心技术是互联网工程任务组（Internet Engineering Task Force，IETF）开发的。IETF 是一个松散的联盟组织，它设计了构成互联网各要素的运行方式，并将之写成规范的文档。IETF 通过定期召开会议和频繁发布出版物的方式打造互联网的技术规范。这些出版物被称为「征求修正意见书」（Request for Comments，RFC），是互联网的事实规范。RFC 可以在网上找到，迄今为止已有 6000 多个 RFC。但并非所有 RFC 都是一本正经的，不信可以看看 1990 年愚人节应景发布的 RFC-1149——「A Standard for the Transmission of IP Datagrams on Avidan Carriers」（用鸟类运送 IP 数据报的标准）。

管理互联网其他事务的是一个叫互联网名称与数字地址分配机构（Internet Corporation for Assigned Names and Numbers，缩写为 ICANN，其网址为 icann.org）的非营利组织。ICANN 负责互联网的技术协调，包括分配为让互联网正常运行而不能重复的名字和数字地址，如域名、IP 地址和某些协议信息。ICANN 还负责给域名注册商授权，好让他们给个人和机构分配域名。ICANN 最初是美国商务部管辖的一个署，但现在已经是独立的非营利组织，其主要资金来源是对域名注册商和域名注册收取费用。

9.2.1 域名系统

域名系统（Domain Name System，DNS）规定了我们熟悉的分层命名方案，因此就有了 berkeley.edu 和 cnn.com 这样的名字。在域名系统中，.com、.edu 等组织机构代码和.us、.ca 等两个字母的国家代码被称为顶级域。顶级域把管理责任和更多名字委托给下级域。例如，普林斯顿大学负责管理 princeton.edu，在这个域名下可为计算机科学系规定子域名 cs.princeton.edu、为古典文学系规定子域名 classics.princeton.edu，计算机系则可进一步规定域名 www.cs.princeton.edu。这种层次式的命名可以一直扩展下去。

域名只表示逻辑结构，并不受任何地理限制。例如，IBM 的分支机构遍布全球，但公司的全部计算机都在 ibm.com 域名下。一台计算机可以为多个域名服务，这在提供网站托管服务的公司里再平常不过了。也可以用多台计算机为同一个域名服务，比如像 Facebook 和 Amazon 这种大型网站。

域名系统没有地理限制会带来很多有趣的结果。比如，南太平洋上位于夏威夷和澳大利亚之间有个群岛国叫图瓦卢，它在域名系统中的国家代码是.tv。图瓦卢把国家代码的使用权租给商业公司，后者则兴高采烈地把.tv 域名卖给客户。如果你要买 news.tv 这种显然有潜在商业价值的域名，可能就要准备掏一大笔钱。反之，kernighan.tv 这种只对姓柯尼汉的人有意义的名字，价格还不到每年 40 美元呢。由于语言上的巧合而受益的其他国家还包括：摩尔多瓦共和国，其.md 域名对医生很有吸引力；意大利，其.it 域名可以用于 play.it 这样的网站。域名通常只能使用 26 个英文字母、数字和连字符。但从 2009 年起，ICANN 批准了一些国际化顶级域名，比如中国除了用.cn 之外也可以用。中国。

9.2.2 IP 地址

每个网络和每台联网主机都必须有 IP 地址，这样才能互相通信。IPv4 地址是互不重复的 32 位二进制数，在同一时刻任一地址只能给一台主机使用。ICANN 把地址按块分配出去，得到地址块的机构再把它划分成子块分配给下级机构或个人。比如，普林斯顿大学有两个地址块，分别是 128.122.ddd.ddd 和 140.180.ddd.ddd，其中 ddd 是从 0 到 255 的数字。这里的每个地址块最多允许给 65 536（216）台主机分配地址，总共大约有 131 000 个可用地址。

这两个地址块没有数值或地理上的关系，这就像 212 是纽约市的长话区号而 213 却是洛杉矶的一样。没有任何理由认为相邻的 IP 地址块代表物理位置相近的计算机，同样也没办法仅靠 IP 地址本身判断地理位置 —— 尽管通常可以从其他信息推断出一个 IP 地址的来源。例如，DNS 支持从 IP 地址到名字的反向查找，可以从 128.112.132.86 查到 www.princeton.edu，于是就可以合理地猜测网站在新泽西州普林斯顿，尽管实际上服务器可能根本就在别的地方。

简单算一下就会发现，IPv4 地址只有大约 43 亿个，甚至还不够地球上每人分一个。因此，按照人类使用的通信服务数量的增长势头，这些 IPv4 地址迟早会被耗光。实际情况比这种「危言耸听」更糟糕，因为 IP 地址是按块划分的，这样用起来就没有理论上那么有效率。想想吧，普林斯顿大学真的会有 13 万 1 千台计算机吗？IPv4 地址耗尽的可能性是真实存在并且迫在眉睫的，大体上在 2012 年就会分配光［1］。

［1］ 原文如此，实际上 IPv4 地址已经在 2011 年分配完毕，由于原书出版于 2011 年，作者来不及跟踪其最新状态。—— 译者注

有一种用单个 IP 地址肩扛手挑多台主机的技术，可以让我们在这个灾难面前获得喘息之机。家用无线路由器一般都提供网络地址转换服务（Network Address Translation，NAT），即用单个外部 IP 地址为多个内部 IP 地址提供连网服务。使用 NAT 之后，家里所有联网设备从外部网络看都具有相同的 IP 地址，内外地址的双向转换完全由 NAT 设备的硬件和软件搞定。

当互联网地址迁移到使用 128 位地址的 IPv6 之后，这种地址短缺的压力就会消失。IPv6 有 2128 个，也就是大约 1038 个地址，是不会马上耗尽的。

9.2.3 根服务器

DNS 的关键功能是把名字转换为 IP 地址。顶级域的转换工作由一组根域名服务器负责，它们知道所有顶级域（比如 mit.edu）的 IP 地址。为获取 www.cs.mit.edu 的 IP 地址，需要先向根服务器查询 mit.edu 的 IP 地址，这样就能访问到 MIT 域，然后向 MIT 的域名服务器查询 cs.mit.edu 的 IP 地址，从得到的 MIT 计算机系的域名服务器就可以查到 www.cs.mit.edu 的 IP 地址。

