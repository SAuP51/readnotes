# 10 电影

本章我们编写了一个类似「豆瓣影评」的小功能，所有数据来自于豆瓣开放的 API。通过编写这部分的功能，我们将学习如何使用 wx.request 获取真实的网络数据，并将这些数据「填充」到小程序中。此外，本章中最重要的内容是多层嵌套模板的使用技巧，多层嵌套模板的优势将在本章中得到体现。此外本章还指出了很多小程序的「坑」，希望可以帮助开发者节约宝贵的时间。

## 10.1 小程序的 tab 选项卡

从本章开始，我们将着手编写 Orange Can。项目的电影部分。电影部分同文章部分属于同一级别，我们在本章的开始部分使用小程序提供的 tab 选项卡来实现电影模块和文章模块的切換。tab 选项卡的效果如图 10-1 所示。

需要注意的是，我们不需要自己编写代码实现 tab 选项卡。小程序提供了现成的 tab 选项卡，我们只需要在 app. Json 中配置一些参数即可实现 tab 选项卡的效果。

Tab 选项卡的配置是通过 app. Son 文件中的 tabbar 选顼来实现的。在配置 tab 选项卡之前，我们新建一个页面 - movie 页面（位于 pages/movie 目录下）。或者直接在 app. Son 的 pages 选项下新增 ρages/move/ move 并保存，这将直接在 pages/move 目录下新建 movie 页面的 4 个页面文件

接着配置文章和电影页面的 tab 选项卡，代码如下：

黑色加粗部分是新增的代码。tabbar 配置项有以下几个属性

color 未选中时的 tab 选项卡文字颜色。

selected Color 选中时 tab 选项卡文字颜色。

background Color tab 选项卡背景颜色。

borderstyle tab 选项卡上边框的颜色，注意它只支持 black 和 white 两个取值，默认是 black。

list tab 选项卡列表，是一个数组，接受一组 object：对象，我们在后面会具体给出每个对象的属性。

position 可选值有 bottom 和 top，默认为 bottom，指定选顼卡位于底部还是顶部。

再来具体看看 lit 这个数组。ist 数组的每一项都是一个 object 对象，每个 object》对象代表ー个 tab 选项，最少必须有两个 tab 选项，而最多只能有 5 个 tab 选项。tab 选项卡出现的顺序由数组中 objectp 的顺序来決定。object 对象包含以下几个属性：

pagepath 每个 tab 选项的页面路径。注意，用于 pagepath 的路径必须预先已在 app. Son 的 pages。中定义。

text tab 选项卡上出现的文字。

iconpath tab 选项卡上的图片路径，图片大小限制为最大 40KB，建议尺寸为 81pxx81px

selectedlconpath 选中是的图片路径，图片大小限制为最大 40kb，建议尺寸为 81pxx

81

这里要特别注意，对于 pagepath、iconpath？和 selectedlconpath 这几个路径，一定不要以「/」开

头。即使它们看起来是绝对路径也不要在路径前面加 /」。在 pagepathp 前面加「/」将导致错误。如果在 iconpathp 前加 /」，虽然在模拟器中不会出现问题，但将项目在真机上预览时（在开发工具的「项目」里点击「预览」时）开发工具将报如图 10-2 所示的错误。

所以，建议开发者不要在 pagepath、iconpathz 和 selectedlconpathi 前使用「/」开头。

此时，我们保存并运行代码，会发现页面停留在 welcome I 页面，点击「开启小程序之旅」，页面没有反应。如果在 welcome.js 的 navigate o 中设置了 fai 函数，点击「开启小程序之旅」就将进入 navigate TOI 的 fai 函数中。

为什么会出现这样的情况？

我们在 4.112 小节中介绍 redirect 和 navigate Tol 时，提到过这两个方法只能用于不帯 tab 选顼卡的页面。此时要跳转的 post 页面已经被设置成了带选项卡的页面，所以无论使用 redirect 还是 navigate 都不能成功跳转，必须使用 4.112 小节中我们提到的另外一个导航方法（wx. Switchtab 方法）, オ能成功跳转到帯有 tab 选项卡的页面。

修改 welcome jsi 页面的 on Tapjump 方法。

以上代码仅仅是将原先所调用的 wx. Navigate 修改成了 wx. Switch Tab。保存并运行代码，此时再次点击 welcome l 页面的「开启小程序之旅」，可以成功打开 post 页面。此时的 post 页面底部出现了ー个 tab 选项卡，如图 10-3 所示。

可以通过点击『文字）和『光影）进行文章和电影页面的切換。

需要特别注意的是，W, redirect 和 WX navigate o 无法跳转到带有 ab 选项卡的页面；同理，使用 Wx. Switch ab 也无法跳转到不带 tab 选项卡的页面。它们各司其职，不能滥用

开发者还可以尝试ー下 tab 选项卡在页面上部的布局，将 app. J son 中 Itabbarp 配置下的 position 由 bottom」修改为「top」，tab 选项卡将出现在页面的上部，如图 10-4 所示。

可以看到在上部的 tab 选项卡是不包含 tab 图标的，即使你设置了 tab 的图标也不会出现。

## 10.2 电影页面介绍

电影模块部分总共有以下几个展示模块

电影首页展示正在热映、即将上映和豆瓣 top250 三种类型的电影。每种电影只展示最前面 3 部。

·每种电影有一个「更多」按钮，点击将打开一个新页面，展示该类型下所有的电影。

支持电影搜索功能。

点击任意一部电影都将打开电影详情页面。

开发者可以参考本书彩页中的设计图，直观且详细地了解各个功能模块。所有电影数据均来自于豆瓣电影开放 API，以下是豆瓣电影 AP 文档的地址

https://developers.douban.com/wiki/?title=movie_v2

对于电影页面的编写，我们将大量使用 template 模板，甚至是使用多层次嵌套模板。

图 10-5 解释了电影模块中所有页面及模板的结构关系。开发者不需要现在马上看明白上面的结构关系图，只需要在后续章节中时时回顾一下此图即可。箭头中没有标注包含数量的表示只包含个模板。

我们大概解释一下以上关系调用图：电影功能部分总共有 3 个页面，分别是电影首页、更多电影和电影详情页面以及 1 个电影搜索模块（电影搜索不是单独的一个页面，位于电影首页）。

以电影首页为例：电影首页由 3 个 move-list-tpl 模板构成，每个 move-ist-tpl 模板由 n 个 move-tpl 模板构成，而每个 move-tpl 模板又包含 1 个 stars-tp이模板。

图 10-6~ 图 10-8 是以上几个模板的示意图。

我们基本可以人以上 3 个示意图中完全解析出模板的嵌套关系：电影首页由 3 个 move-ilst-tpl 模板构成，每个 movie-list-tpl 模板又由 3 个 movie-tpl 模板构成，而每个 movie-tpl 模板又包含了 1 个 stars-tρ 模板。

从图 10-5 中我们可以看到，嵌套模板的使用可以避免编写重复代码，大量的 wxml 代码将被复用。如果你已经忘记了 template 模板的使用，请回顾一下本书第 5 章的内容。

## 10.3 编写豆瓣

星星评分组件：stars-tpl 模板当点击 tab 选项卡的「光影」选项时将跳转到电影首页。

在 10.3~10.5 这 3 节中，我们将连续编写 3 个模板。对于这些模板，我们只需要大概浏览一下它们

的骨架结构，对于 {补} 中所绑定的数据，无须太过关心。当这 3 个模板被编写完成并在电影首页中传入数据调用时自然会明白每个份所绑定的数据意义。

在 10.2 节中，我们分析了电影首页的模板构成。下面我们首先编写电影首页所需要的几个模板，这里从最小的模板（stars-tpl 模板）开始编写。

在 movie 目录下新建一个 stars 文件夹，并在该文件夹下新建两个文件：stars-tpl.Wwml 和 stars- l.wxss。随后在 stars-tpl.wxm 中新增以下代码

Stars 模板是需要从外部传入一些数据才可以正常使用的，所以我们现在无法直接预览 stars 模板的效果。

stars 模板接收一个数组作为参数，这里先给出接收数组的形式：[1,10,0] 表示 3 星评价

[1,1,1,1,1 表示 5 星评价，[1,1,1,0.5,0] 表示 3 星半。

注意，模板中 3 个 Image？组件的使用技巧在前面的已提过，条件渲染不仅仅可以使用 Wxf 和 Wx: else，还可以多层次地使用 i 讦 else if else.3 个 image 组件中的 if else 展示了这种多层次条件的用法。

block 标签将循环评分数组，循环一定会执行 5 次，出现 5 颗星星，但会根据数据组中当前位的取值是 1、0.5 还是 0 来決定当前的星星图片是满星、半星还是空星。这样评分组件的星级就实现

同时 {star} 还需要绑定一个评分的分数，这个分数也需要由外部传入。

接着，我们在 stars--tpl.WXSs 中编写 stars 模板的样式。

以上就是 tars-tpl 模板的全部代码，我们暂且放下，接着编写其他模板的代码，最后再将这些模板组装起来。

## 10.4 编写 move-tp 模板

接着我们编写电影首页中需要用到的另外一个模板：movie-tpl。模板的示意图请参考图 10-7。

在 pages。的 movie 目录下新建一个 single- movie 目录，用来存放 movie-tpl 模板。

在 /pages/ move/single- move 目录下新建两个文件：move- tpl wxml 和 move-tpl.WXSS 文件

首先在 movie- tpl. Xmi 中编写 movie-tpl 模板的骨架代码

在以上代码的顶部我们使用 Import 引入了在 10.3 节中定义 stars-tpl 模板。Moive-tpl 模板由一张电影海报、电影标题以及 stars-tpl 模板构成

对于整个 movie-tpl 模板，我们在其容器上注册了一个事件 onmoviet ap，并绑定了当前电影的 id

号 - movield

需要注意的是，stars-Tp 模板的 data 属性，该属性将 stars 数组和 score 评分传入 stars-Tpl 中（请开发者回顾一下 10.3 节中的 tars-Tpl 定义）

那么 movie-tpl 模板中的 stars 数组和 score 评分又是从哪里来的呢？答案依然是从外部传入的。在 10.5 节中编写 movie- -list-tpl 时将看到如何传入这两个参数。

接着编写 move-tpl 模板的样式。

注意，在样式的顶部我们依然需要引入 stars-tpl 模板所使用的样式。

## 10.5 编写 move- -list-tpl 模板

直接被电影首页调用的模板是 move-list-tp이模板，move-lilt-tpl 模板中引用了 move-tpl 模

板，而 movie-tpl 模板中又引用了 stars-tpl 模板。这就是我们所说的 3 层模板嵌套关系。

首先在 pages/movie 目录下新建 movie-list 目录，接着在 movie-ist 目录下新建两个文件

movie-lilt- tpl. Wxmi 和 movie-ist-tpl.Wxss 文件。

下面编写 novle-list-tpl 模板的骨架。在 movie-list- tpl. Wxmll 中添加以下代码：

同样，我们在代码的开头部分使用 import 引入 move-tp이模板，并在 block 标签中使用 move-tpl 这个模板。注意 template 标签中的 data 属性，我们在这里将 movie-t이模板所需要的数据传进去。

接着编写 movie-ist-tpl 模板的样式。在 movie-list-tpl, Wxss 文件中编写以下代码：

注意在代码的开头部分使用 import 引入 movie-lilt-t이模板所使用的 movie-tρl 模板的样式文件

movie-tpl.WXSs。

## 10.6 电影首页的骨架与样式

在我们编写好 3 个 template：组件后，电影首页的骨架编写将变得非常简单，只需要在电影首页中

引用 move-list-tp이模板即可。

在 movie.wxml 页面中添加以下代码：

注意，在代码开头部分使用 import 引入了 movie-list-tp이模板。同时，在本段代码中使用了 3 次 movie-list-tp 模板，分别代表 in Theaters 正在热映、coming Soon 即将上映和 top250 经典电影 3 种类型的电影。

接着编写电影首页的样式。在 move.WXss 文件中添加以下代码

## 10.7 豆瓣电影 API 分析

在编写电影首页的 js 调用豆瓣 API 之前，我们首先应当对豆瓣电影 AP 有一个直观的认识和了解。所谓开放 APl，是指某些公司、企业将自己公司所持有的数据、用户数据选择性地开放给开发者调用，让开发者可以使用数据并围绕这些数据构建自己的应用，从而帮助公司、企业完善其平台和生态。

目前，绝大多数的开放 AP 都属于 RESTFULL 风格的 APl，比如豆瓣 API、github 开发者 API 等。豆瓣 API (V2 版）就属于这类 API，其 AP 权限有 3 种

公开高级商务

所有开发者无须申请即可调用公开权限的 APl, 但只有部分 API 是公开权限的，一些高级接口无法 调用，且公开 AP 具有 40 次 / 分钟的访问限制。如果开发者在调试代码时遇到豆瓣返回错误信息，就有可能是因为已经超过允许访问的次数。这个时候唯一的办法就是稍等片刻。

高级权限和商务权限需要开发者向豆瓣发邮件申请。

本书中所调用的豆瓣 API 均为公开 AP，所以要注意访问频率限制的问题。在 Orange Can 项目中总共使用了以下几个豆瓣电影 API:

获取正在热映的电影

获取即将上映的电影。获取豆翔瓣이p250 电影电影搜索。

获取豆瓣 top250 电影。电影搜索。

获取电影条目信息（电影详情数据

以获取豆翔瓣 top250 的 AP 地址为例，一个完整的获取豆瓣 top250 电影的 API 地址为

https://api.douban.com/v2/movie/top250?start=0&count=15

在以上 APl 中，我们向豆瓣请求 top250 电影中的前 15 条电影信息。start=0 和 count=-15 是查询参

数，可根据需求自行调整，但要注意每次加载最多只能获取 20 条数据，counti 超过 20 是没有意义

开发者可直接在浏览器中输入以上 URL 地址，豆瓣将返回我们需要的数据，返回数据的类型是 JSON 类型，如图 10-9 所示。

关于其他几个 AP 接口的使用方法，我们将放在后续实例编码中讲解。

## 10.8 电影首页的 js 编写

电影首页 js 的编码工作主要做以下 3 件事情：

调用豆瓣 AI 获取电影数据。

处理豆瓣电影数据

绑定豆瓣电影数据。

首先在 app. JS 中的 globaldatat 中加入ー个全局变量 douban Base，用来记录豆瓣 APl 的基地址。因

为所有豆瓣的 API 访问都需要这个基地址，所以我们将它单独放在全局变量中，并在其他需要的地方获取这个全局变量。

黑色加粗部分为新增代码。

接着编写 move. S 中的代码。首先在 movie.js 中新增 Page 方法，并在 Page 方法的参数中定义

datt 初始化数据及页面 onload I 函数。

在 onload 函数中，主要拼接了 3 个不同的豆瓣 AP，分别用来获取正在热映、即将上映和豆瓣 top250 电影的数据。

这 3 个 API 唯一的区别在于 URL 路径中的一小段路径 / V2/movie/key 中的 key 不同:「正在热映」的

key 是 in T heaters，「即将上映」的 key 是 coming Soon，「top250」的 key 是 top250。

注意，我们使用「? start=0& count=3" 指定仅获取每种类型电影的前 3 条数据，因为在我们的业务需求中只需要每种类型的前 3 条数据。

在 data 属性中，预先定义了 3 个对象：in T heaters、comingsoon 和 top250。这 3 个对象将用于数据绑定，开发者可回顾一下代码清单 10-9。在代码清单 10-9 中，分别将这 3 个对象绑定到了 emplate 模板上。

在代码清单 10-12 的末尾部分，调用了 3 次 this. Getmovie Listdata 方法。这个方法的作用就是根

据传入的 urI 获取和处理数据。在 10.9 节中，我们将编写这个方法。

0.9WXrequest 发送 http: /https 请求

目前我们还没有编写 getmovie Listdata 方法，现在在 movie. JSE 的页面中添加这个方法。

Getmovie Listdata 接受 3 个参数：url、settedkey 和 category Title。url 被用来访问并获取豆瓣电影数据，settedkey？被用来作为不同类型电影数据绑定的 key, category Title 被用来作为电影的分类标题，最终将被显示在 move-ist-tpl 的标题上（参考代码清单 10-7) 。

getmovieListDatap 的核心代码是 WXrequest / 方法的使用，是小程序提供的发送 http 和 https 请求的方法，类似于传统 Javascript 编程中所使用的 ajax 方法。

wxrequest (object）方法用于发送 http: /https 请求，并接受服务器返回的请求结果 Object 参数包含以下几个属性用于配置请求参数

url String 类型，开发者服务器接口地址

data Object 或者 String 类型，请求的参数。

header Object 类型，设置请求的 header。注意，在 header 中不能设置 referer, 因为在小程序中 referer 是一个固定格式的值，格式固定为 https://servicewechat.com/fappid) /version/page- frame.html，其中 {appid）为小程序的 appid、version} 为小程序的版本号，版本号为 0 表示开发版。

method String 类型，默认为 GET，有效值为 OPTIONS、GET、HEAD、POST、PUT、DELETE、TRACE、CONNECT。注意，method 的取值必须大写。

data Type String 类型，默认为 json。如果设置了 data Type 为 json，就会尝试对响应的数据做

次 JSON. Parse。

success Function 类型，收到开发者服务成功返回的回调函数。函数会被传入一个 res 参数开发者可通过 res.data 来获取服务器返回的内容。

fail Function 类型，接口调用失败的回调函数。

Complete Function 类型，接口调用结束的回调函数（调用成功、失败都会执行）。

开发者可能注意到，在代码清单 10-13 中，我们在设置 header 的 content-type 时给出了一个奇怪的参数值：json。既没有给出常见的 application/json, 也没有直接省略掉 content-type 这个选项（官方文档中明确指出 content-type 的默认值是「application/json」)。原因是以下几个选项都无法正确调用豆瓣八 P이

不设置 content-type

content-type: 'application/json

content-type

在目前的 13040 版本中，如果将 content-type 设置为以上几个取值，那么豆瓣 AP 将返回如图 10-10 所示的错误信息。

经过反复调试发现，content-type 可以被指定为任意不为空的字符串：content-type: Json content-type: XXXXXX content-type: appli

只要 content-type 不为空或者是 application/json, 就可以正确调用豆辦 A 并获取到豆瓣的返回数据。

为了让 content-type 看起来合理一些，在 Orange Can 项目中ー律使用 content- type: json 的形式作为 content-type 的取值。

对于 WXrequest，还有以下几个注意事项

url 中不能有端口。

Wx. Requeste 的默认超时时间和最大超时时间都是 60s。wx request 的最大并发数是 5。

## 10.10 设置 wx. Request 的超时时间

很多开发者可能想知道如何在小程序中设置超时时间，答案是在 app.json 文件中配置这个超时时

在 app. Json 中除了我们之前讲到的 bages、window、tab Bar 等常用的配置项外，还有一个

network Timeout 配置项。network Timeout 配置项用来配置各类网络请求的超时时间

request WX. Requeste 的超时时间，单位为毫秒，默认值为 60000。

Connectsocket wx. Connectsocketl 的超时时间，单位为毫秒，默认值为 60000。

uploadfile wx. Upload Filef 的超时时间，单位为毫秒，默认值为 60000

downloadfile wx. Download Filel 的超时时间，单位为毫秒，默认值为 60000。

我们可以在 app.json 中添加以下代码来设置各类请求的超时时间

代码清单 10-14 设置请求的超时时间 app. Json

request: 20000,

connectsocket": 20000

uploadfile: 20000.

"'downloadfile": 20000

当然，如果目前位置只使用 wx request 请求，只设置 request 这个配置项也是可以的。如果服务器在 20 秒内没有响应，那么 wx. Request，将进入 fali 函数。

## 10.11 处理返回的电影数据

在代码清单 10-13 中，我们使用 WX request 来获取豆瓣 APl 所提供的电影数据。需要注意的是，WXrequest 是一个异步方法，且小程序只提供了异步发送 http: /https 请求的方法，没有同步版本。所以，不要尝试使用以下方法来获取 NX requeste 的返回值

var result=WX request (object)

对于同步的方法，可以使用以上方式来获取返回结果；但对于异步方法，只能在异步方法所提供的回调函数中进行返回结果的处理。比如在 wxrequest 中，就只能在 WXrequest 所提供的 succes 回调函数中处理豆瓣的返回结果。

回顾一下代码清单 10-13, 在 success【回调函数中，我们使用 res.data 来获取豆瓣 API 的返回结果，接着调用了一个 processdoubandata 方法来处理豆瓣 API 的返回数据，从豆瓣加载回来的数据格式如图 10-11 所示。开发者可自行使用 postman 或者 Fiddler？来调用豆瓣 A 川查看返回的数据格式。

目前，我们还没有实现 processdoubandata，下面来编写这个函数。

这个函数接收 3 个参数，第一个参数 moviesdouban，就是我们从豆瓣获取来的电影数据 processdoubandata 的主要功能就是处理 movies Douban；：第二个、第三个参数在之前已经解释过，这里只是简单地传入到 processdoubandatap 中，在最后才绑定到 setdata 方法中。

for 循环将遍历所有豆瓣电影的数据，并将豆瓣的数据格式转化成我们需要的命名格式，temp 就是一个临时保存转化后电影数据的变量。

最后将所有豆瓣电影数据处理完后调胴 s 的 Aray.push 方法将 temp 加入 movies？数组中，最终形成我们需要的电影数据数组。

在 for 循环中处理豆瓣电影数据时，调用了一个 uti. Convert ostarsarray 方法将豆瓣的评分格式转化成我们需要的数组格式一一形如【1,1,0,0,0] 的形式（开发者可回顾一下 10.3 节）。豆瓣 AP 返回的关于评分的数据格式为 50（表示 5 星）、35（表示 3 星半）、00 (0 星或者还没有星级）, util. Converttostarsarray 的任务就是将这些 50、35、00 等星级的简写形式转化成【1,1,1,1,1  [1,1,1,0.5,0 和【0,020,0,0] 等需要的数组形式，以方便 stars-tp이模板使用。

在 util. JSE 中加入一个 convert ostarsarrayl 函数。

记住，util 是一个模块，添加完方法后需要使用 module. Exports！输出。

黑色加粗部分为新增代码。

随后，要想在 movie.js 中引用 util，还需要在 move.js」顶部引用 uti 模块。

代码清单 10-18 引用 u 模块 movie js

var util -require (//util/util. Js

完成以上代码的补充后，我们才能够在 movie. JS 中调用 utl. Convert T ostarsarray subject rating. Stars）方法。
