# 1501. 思维笔记实例

前面对 Laravel 框架的大多数组件进行了详细的介绍，从它的使用到具体代码的实现细节都有所涉及，但知识和实践之间总是隔着一条鸿沟，阻挡了大部分人对知识升华的脚步。本章将设计一个简单的实例，将之前学习过的不同模块综合起来使用，进而实现某一项基本的应用功能。本章的实例以思维笔记为例，是一个简单的笔记记录软件，可以在日常生活中记录一些学习笔记，功能比较简单，如果需要可以继续拓展其他功能。

虽然目的已经明确，是设计一个笔记管理的软件，那么该从何处入手、分为几个步骤实现还是一个需要思考的问题。开发一个项目可能有不同的流程，如瀑布流、敏捷开发和测试开发等。瀑布流笼统地讲就是按需求分析、方案设计、程序开发、软件测试和软件部署每个环节顺序执行，每个环节结束后进行评审，如果不通过则需要返回重新整改。目前瀑布流开发已经不适应现实中快速开发、快速部署的要求了，更不适合我们这种小的学习项目的设计。我们的设计思路是从简单、直观的环节入手设计程序，一般情况下分为两种，一种是对业务已经基本掌握，改动不会太大，则可以从数据库设计入手；另一种是对需求和业务的了解还不够清楚，需要在实践中进一步理解，则可以从用户界面入手。对于本章中这个项目，由于项目较小，功能单一，可以从数据库设计入手，然后是路由设计，最后是控制器设计和 Web 页面设计。下面将对这些环节逐个进行介绍。

15.1　数据库设计

数据库的设计在项目中可以分为两个部分，一个是数据库中数据表的设计，另一个是对数据库中各数据表操作的接口设计。这两部分内容 Laravel 框架都提供了完美的基础支持，下面分别介绍这两部分内容。

15.1.1　数据表设计

在进行数据库设计时，一般是通过数据库设计软件（如 Power Designer 等）完成数据库的结构设计，之后再通过 SQL 语句完成数据表的创建，但是这种方法在数据表创建和后期修改时都比较麻烦，效率低下。Laravel 框架为我们提供了数据迁移工具，可以实时管理和更新数据库中各数据表的结构，为数据库的版本控制和管理提供了极大的方便。

首先，根据应用确定需要哪些数据表及每个数据表对应业务所需要的结构。简单的笔记系统只需要三个表就可以满足需求，第一个是用户表，主要用于记录用户信息，可以单人或多人共同使用；第二个是分类表，用于记录笔记中不同的类别，比如学习笔记中关于学科、技术、项目等分类；第三个是笔记内容记录表，用于记录笔记中的主要内容。根据以上分析，设计相应数据表的字段结构，并在 Laravel 框架中设计数据库迁移文件，可以通过 artisan 命令「php artisan make:migration create_users_table」直接生成，并在其中进行修改。数据库迁移文件的具体代码如下：

文件 mindlevel\database\migrations\2015_10_12_000000_create_users_table.php <?php use Illuminate\Database\Schema\Blueprint; use Illuminate\Database\Migrations\Migration; class CreateUsersTable extends Migration { // 执行数据库迁移 public function up () {// 建立用户表 Schema::create ('users',function (Blueprint $table){$table->increments ('id'); $table->string ('username',32); $table->string ('account',32); $table->string ('password',60); $table->rememberToken (); $table->unsignedInteger ('addtime'); $table->tinyInteger ('state')->unsigned ()->default (1); }); // 建立分类表 Schema::create ('tb_category',function (Blueprint $table){$table->increments ('id'); $table->string ('name',32); $table->unsignedInteger ('count')->default (0); $table->integer ('uid'); // 用户的 id $table->t i n y I n t e g e r (' s t a t e ')->u n s i g n e d ()->default (1); // 分类的状态，确认是否被删除，1 为正常，0 为删除 }); // 建立笔记内容表 Schema::create ('tb_records',function (Blueprint $table){$table->increments ('id'); $table->string ('title',64); $table->text ('content')->nullable (); $table->integer ('cid'); // 笔记类型的 id $table->integer ('uid'); // 用户的 id $table->unsignedInteger ('addtime')->default (0); $table->tinyInteger ('state')->default (1)->unsigned ();}); } // 返回数据库迁移 public function down () { Schema::drop ('tb_category'); Schema::drop ('tb_records'); Schema::drop ('users'); } }

设计好数据迁移文件后可以通过 artisan 命令「php artisan migrate」完成数据库迁移，迁移后数据库 mindlevel 中的数据表内容如图 15.1 所示。

图 15.1　数据库 mindlevel 中的数据表内容

通过上述数据库迁移文件创建三个数据表，具体的表结构为：users 表中有 7 个字段，分别是 id 字段、用户名字段、账户字段、密码字段、登录记录 Token 字段、时间字段和状态字段，这里的时间字段使用无符号整数进行记录；tb_category 表有 5 个字段，分别是 id 字段、类别名字段、笔记数量字段、用户 id 字段和状态字段，其中状态字段为 1 表示正常，为 0 表示该分类已经被删除，在实际项目中，一般的删除行为是不推荐将数据从数据表中删除的，而是在状态字段通过设定状态来标识是否被删除，这样被误删除的内容具有可恢复性；tb_records 表中有 7 个字段，分别是 id 字段、标题字段、内容字段、笔记类型字段、用户 id 字段、创建时间字段和状态字段。

15.1.2　模型类设计

数据库操作的接口可以通过 Laravel 框架提供的 Eloquent ORM 模块进行设计，其中在数据库设计中设计了三个数据表，于是需要为每个数据表建立一个模型类文件与其对应，通常情况下模型类直接放在 mindlevel\app 文件夹中，为了程序代码更加模块化，在该文件夹中创建一个 Models 文件夹，用来存放相应的模型类。创建的模型类虽然已经具备了对数据库中对应数据表的增加、删除、修改和查询的所有功能，但是在项目开发时还需要一些常用的数据处理接口，可以在模型类中直接添加。具体三个模型类的代码如下：

文件 mindlevel\app\Models\Users.php <?php namespace App\Models; use Illuminate\Auth\Authenticatable; use Illuminate\Database\Eloquent\Model; use Illuminate\Auth\Passwords\CanResetPassword; use Illuminate\Contracts\Auth\Authenticatable as AuthenticatableContract; use Illuminate\Contracts\Auth\CanResetPassword as CanResetPassword-Contract; class Users extends Model implements AuthenticatableContract, CanResetPasswordContract { use Authenticatable, CanResetPassword; // 数据表的名称 protected $table = 'users'; // 不使用 Laravel 框架提供的时间存储方式 public $timestamps = false; // 可填充数据表字段 protected $fillable = ['username', 'account', 'password', 'addtime']; // 保护数据表字段 protected $guarded = ['id']; // 查找所有用户 public function findAll () { $userList = $this->all (); return $userList;} }

这里定义了 users 数据表的模型类，其中重新定义了几个字段，$fillable 和 $guarded 两个字段不是很容易从字面上理解其本质，这里从源码实现的角度来介绍。在项目实现中，如果需要向数据表中插入一行数据，那么方便的做法是通过模型类中的 fill (array $attributes) 方法（如果使用 create () 方法也会调用 fill () 方法），该方法接收的参数是一个数组，可以将数据表相应字段的数据建立一个关联数组传给该方法，在该方法中并不是传入任何数据都会在表中进行存储，而是首先对数据的合理性进行过滤，满足要求的添加到模型类实例的 $attributes 属性数组中，这里的条件就是通过 $fillable 和 $guarded 两个属性设置的，其中 $guarded 定义保护对象，默认值是「*」，即保护所有，而 $fillable 标识可以填充对象，源码中的逻辑是对传入参数数组中每个关联键值通过 isFillable () 函数进行判断，即在 $fillable 属性数组中查找，如果具有相应的值，则进行添加，否则将舍弃，当舍弃时会判断是否所有数据都保护，如果所有数据都保护就会抛出异常。这里判断所有数据是否都保护是通过 totallyGuarded () 函数实现的，该函数判断如果 $fillable 属性中没有值并且 $guarded 属性中值为「*」则全局保护，两者是「与」的逻辑，也就是说只要 $fillable 中有值或者 $guarded 中值不为「*」就不会因为全体保护而抛出异常。一般情况下，两个值都使用默认值，即全体保护，在程序设计中只能通过逐个添加字段数据的方式进行数据表中数据的添加，或者将 $fillable 和 $guarded 两个属性设置成与数据表相符的形式，其中 $fillable 中添加需要向数据表中手动添加的字段，而 $guarded 设置成不需要向数据表中自动添加的字段，如「id」字段。下面给出 fill () 函数的源码来增加理解。

文件 Illuminate\Database\Eloquent\Model.php// 填充 model 类实例的 attributes 数组 public function fill (array $attributes) {$totallyGuarded = $this->totallyGuarded (); foreach ($this->fillableFromArray ($attributes) as $key => $value) {$key = $this->removeTableFromKey ($key); if ($this->isFillable ($key)) {$this->setAttribute ($key, $value); } elseif ($totallyGuarded) {throw new MassAssignmentException ($key); } } return $this; } 文件 mindlevel\app\Models\TbCategory.php <?php namespace App\Models; use Illuminate\Database\Eloquent\Model; class TbCategory extends Model { protected $table = 'tb_category'; public $timestamps = false; protected $fillable = ['name','count','uid','state']; protected $guarded = ['id']; // 定义类型的状态 static $state = array ('use' => 1, 'delete' => 0); // 加载所有笔记类别信息 public function findUserAll ($uid = 0) {if ($uid!=0){$st = self::$state ['use']; $catArr = static::whereRaw ("uid={$uid} and state={$st}")->get ()->toArray (); return $catArr;} else {return null;} } // 查找 $uid 的第一个分类或者创建一个，返回 id 号 public function firstOrNewId ($uid) {$st = self::$state ['use']; $modColl = static::whereRaw ("uid={$uid} and state={$st}")->get ();//builder if ($modColl->count ()>0){$id = $modColl->first ()->getAttribute ('id'); return $id; } else {return $this->createNewCat ($uid); } } // 添加一个新闻类别 public function categoryAdd ($param) {$param ['name'] = isset ($param ['name'])?$param ['name']:' 思维笔记 '; if (empty ($param ['uid'])){return;} $this->create (['name' => $param ['name'], 'count' => 0, 'uid' => $param ['uid'], 'state' => self::$state ['use'], ]); } // 删除本用户的一个分类，返回下一个该用户的分类，并将日记添加到其中 public function deleteCat ($uid, $cid) {$model = $this->find ($cid); $model->state = self::$state ['delete']; $model->save (); return $this->firstOrNewId ($uid); } // 获取笔记类别的第一个 id public function firstId ($uid) {$st = self::$state ['use']; $modColl = static::whereRaw ("uid={$uid} and state={$st}")->get (); if ($modColl->count ()>0){$id = $modColl->first ()->getAttribute ['id']; return $id; } else {return null;} } // 创建一个新类别 public function createNewCat ($uid, $name = null) {$username = $name?' 思维笔记 ':$name; $model = $this->create (['name' => $username, 'count' => 0, ]); return $model ['id']; } // 分类的数量减去 $num public function countReduce ($cid, $num) {$model = static::find ($cid); $model->count = $model->count-$num; $model->save ();} } 文件 mindlevel\app\Models\TbRecords.php <?php namespace App\Models; use Illuminate\Database\Eloquent\Model; class TbRecords extends Model { protected $table = 'tb_records'; public $timestamps = false; protected $fillable = ['title','content','cid','uid','addtime','s tate']; protected $guarded=['id']; // 定义类型的状态 static $state = array ('use' => 1, 'delete' => 0); // 执行增加操作 public function insert ($param) {if (isset ($param ['uid']) ＆＆ $param ['uid']>0){$tbmodel = new TbCategory (); $param ['cid'] = isset ($param ['cid'])?$param ['cid']:$tbmodel->firstOrNewId ($param ['uid']); $this->fill ($param); $suc = $this->save (); if ($suc){$cat = TbCategory::find ($param ['cid']); $cat->count = $cat->count+1; return $cat->save ();} } return false; } // 新闻的浏览 public function findUserAll ($uid,$cid = 0) {$st = self::$state ['use']; if ($cid>0){$recordsList = static::whereRaw ("uid={$uid} and cid={$cid} and state={$st}")->get ()->toArray ();} else {$recordsList = static::whereRaw ("uid={$uid} and state={$st}")->get ()->toArray ();} return $recordsList; } // 将用户 $uid 笔记的类型从 $cid 变成 $nextId public function changeCat ($uid, $cid, $nextId) {$st = self::$state ['use']; return static::whereRaw ("uid={$uid} and cid={$cid} and state={$st}")->update (['cid'=>$nextId]); } }

15.2　路由设计

15.2.1　模块划分

在路由设计时需要进行模块化设计，否则随着业务的不断增加将会导致路由设计混乱不堪，继而使相应路由入口的权限认证、中间件处理等功能的添加变得困难，最终导致一些安全问题和路由错误。对于思维笔记这个实例，将其划分为三个路由模块，第一个模块是思维笔记展示模块，即在用户没有登录的情况下依然可以看到相应内容；第二个模块是用户认证模块，这部分主要实现用户的注册和登录；第三个模块是思维笔记的管理模块，这部分内容是用户登录后可以操作的内容，主要包括用户的管理、笔记分类的管理和笔记的管理等内容。

15.2.2　程序设计

Laravel 框架提供了多种不同路由设计方式，有些方式使得路由设计简单灵活，如 get ()、post () 等方法，有些方式适合模块化设计，如 RESTful 资源控制器（resource () 方法）、隐式控制器（controller () 方法）等。这里结合上面两种路由设计方式，可以非常轻松地设计出路由。具体路由文件代码如下：

文件 mindlevel\app\Http\routes.php <?php // 用于 Web 浏览 Route::get ('/', 'WebController@index'); Route::controllers (['Web' => 'WebController', ]); // 用于 Web 认证控制 Route::controllers (['webauth' => 'Auth\WebAuthController', 'webpassword' => 'Auth\WebPasswordController', ]);

15.3　控制器设计与 Web 页面设计

控制器设计和 Web 页面设计之间具有一定的耦合性，大型项目需要通过文档约定进行解耦合，从而实现模块化分工设计。本章中的简单实例可以通过迭代的方式进行快速开发，即设计一个页面，再进行控制器内容的设计。这里主要分为几个模块，分别是用户认证模块、用户管理模块、笔记类别管理模块和笔记管理模块，下面将对这四个模块的设计分别进行介绍。

15.3.1　用户认证模块

用户认证模块主要设计了用户注册和登录两个基本功能，Laravel 框架中对用户认证模块各个功能已经提供了基础支持，这里直接使用相应模块实现即可，这部分可以参考认证和数据验证的相关内容。在页面设计时使用 Laravel 框架提供的 blade 模板，建立一个公共的模板文件 app.blade.php，用于提供所有视图公共的部分，其他视图页面都继承该视图。下面给出公共视图代码：

文件 mindlevel\resources\views\app.blade.php <!DOCTYPE html> <html lang="en"> <head> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1"> <title>MindLevel</title> <link href="{{ asset ('/css/app.css') }}" rel="stylesheet"> <link href='//fonts.googleapis.com/css?family=Roboto:400,300' rel='stylesheet' type='text/css'> <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script> <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script> </head> <body> <nav class="navbar navbar-default"> <div class="container-fluid"> <div class="navbar-header"> <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1"> <span class="sr-only">Toggle Navigation</span> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </button> <a class="navbar-brand" href="#">MindLevel</a> </div> <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1"> <ul class="nav navbar-nav"> <li><a href="{{ url ('/') }}">Web</a></li> </ul> <ul class="nav navbar-nav navbar-right"> @if (Auth::guest ()) <li><a href="{{ url ('/webauth/login') }}">Login</a></li> <li><a href="{{ url ('/webauth/register') }}">Register</a></li> @else <li class="dropdown"> <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">{{Auth::user ()->name }} <span class="caret"></span></a> <ul class="dropdown-menu" role="menu"> <li><a href="{{ url ('/webauth/logout') }}">Logout</a></li> </ul> </li> @endif </ul> </div> </div> </nav> @yield ('content') <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script> <script src="//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.1/js/bootstrap.min.js"></script> </body> </html>

下面设计用户登录和注册视图，这些视图在 blade 公共视图布局的基础上设计而成，具体代码如下：

文件 mindlevel\resources\views\auth\login.blade.php @extends ('app') @section ('content') <div class="container-fluid"> <div class="row"> <div class="col-md-8 col-md-offset-2"> <div class="panel panel-default"> <div class="panel-heading">Login</div> <div class="panel-body"> @if (count ($errors) > 0) <div class="alert alert-danger"> <strong>Whoops!</strong> There were some problems with your input.<br><br> <u l> @foreach ($errors->all () as $error) <li>{{$error}}</li> @endforeach </ul> </div> @endif <form class="form-horizontal" role="form" method="POST" action="{{ url ('/webauth/login') }}"> <input type="hidden" name="_token" value="{{ csrf_token () }}"> <div class="form-group"> <label class="col-md-4 control-label">Account</label> <div class="col-md-6"> <input type="text" class="form-control" name="account" value="{{ old ('email') }}"> </div> </div> <div class="form-group"> <label class="col-md-4 control-label">Password</label> <div class="col-md-6"> <i n p u t t y p e="p a s s w o r d" c l a s s="f o r m-c o n t r o l" name="password"> </div> </div> <div class="form-group"> <div class="col-md-6 col-md-offset-4"> <div class="checkbox"> <label> <input type="checkbox" name="remember"> Remember Me </label> </div> </div> </div> <div class="form-group"> <div class="col-md-6 col-md-offset-4"> <button type="submit" class="btn btn-primary">Login</button> <a class="btn btn-link" href="{{ url ('/password/email') }}">Forgot Your Password?</a> </div> </div> </form> </div> </div> </div> </div> </div> @endsection 文件 mindlevel\resources\views\auth\register.blade.php @extends ('app') @section ('content') <div class="container-fluid"> <div class="row"> <div class="col-md-8 col-md-offset-2"> <div class="panel panel-default"> <div class="panel-heading">Register</div> <div class="panel-body"> @if (count ($errors) > 0) <div class="alert alert-danger"> <strong>Whoops!</strong> There were some problems with your input.<br><br> <ul> @foreach ($errors->all () as $error) <li>{{$error}}</li> @endforeach </ul> </div> @endif <form class="form-horizontal" role="form" method="POST" action="{{ url ('/webauth/register') }}"> <input type="hidden" name="_token" value="{{ csrf_token () }}"> <div class="form-group"> <label class="col-md-4 control-label">User Name</label> <div class="col-md-6"> <input type="text" class="form-control" name="username" value="{{ old ('username') }}"> </div> </div> <div class="form-group"> <label class="col-md-4 control-label">Account</label> <div class="col-md-6"> <i n p u t t y p e="a c c o u n t" c l a s s="f o r m-c o n t r o l" name="account" value="{{ old ('account') }}"> </div> </div> <div class="form-group"> <label class="col-md-4 control-label">Password</label> <div class="col-md-6"> <i n p u t t y p e="p a s s w o r d" c l a s s="f o r m-c o n t r o l" name="password"> </div> </div> <div class="form-group"> <label class="col-md-4 control-label">Confirm Password</label> <div class="col-md-6"> <input type="password" class="form-control" name="password_confirmation"> </div> </div> <div class="form-group"> <div class="col-md-6 col-md-offset-4"> <button type="submit" class="btn btn-primary"> Register </button> </div> </div> </form> </div> </div> </div> </div> </div> @endsection

下面针对上述用户认证视图页面设计相应的控制器，用户认证控制器的相关方法在 Laravel 框架中已经通过 AuthenticatesAndRegistersUsers 模块设计好了，只需要包含这个 trait 并实现两个相应的接口函数即可，接口函数分别是 validator () 函数和 create () 函数，一个用于验证注册输入，另一个用于向用户数据表中添加信息，相应代码如下：

文件 mindlevel\app\Http\Controllers\Auth\WebAuthController.php <?php namespace App\Http\Controllers\Auth; use App\Models\Users; use Validator; use App\Http\Controllers\Controller; use Illuminate\Foundation\Auth\AuthenticatesAndRegistersUsers; class WebAuthController extends Controller { use AuthenticatesAndRegistersUsers; // 创建一个新的授权控制器实例 public function __construct () {$t h i s->m i d d l e w a r e (' g u e s t ' , [ ' e x c e p t ' => ['getLogout','getRegister']]); } // 对输入的登录数据进行验证 protected function validator (array $data) {return Validator::make ($data, [ 'username' => 'requiredlmax:255', 'account' => 'requiredlmax:255lunique:users', 'password' => 'requiredlconfirmedlmin:6', ]); } // 向用户数据表中添加一行数据 protected function create (array $data) {return Users::create ([ 'username' => $data ['username'], 'account' => $data ['account'], 'password' => bcrypt ($data ['password']), 'addtime' => time (),]); } }

15.3.2　用户管理模块

用户登录后会进入思维笔记的操作页面，该页面包含用户管理、笔记分类管理和笔记管理的操作，其视图页面如图 15.2 所示。

图 15.2　思维笔记操作视图页面

思维笔记操作视图文件的代码如下：

文件 mindlevel\resources\views\backyard\include\sidebar.blade.php <div class="col-xs-6 col-sm-3 sidebar-offcanvas" id="sidebar"> <div class="list-group"> <a href="/web/userlist" class="list-group-item"> 会员管理 </a> <a href="/web/categorylist" class="list-group-item"> 笔记分类 </a> <a href="/web/noteslist" class="list-group-item"> 笔记管理 </a> <a href="/web/notesadd" class="list-group-item"> 笔记添加 </a> </div> </div><!--/.sidebar-offcanvas--> 文件 mindlevel\resources\views\backyard\index\index.blade.php @extends ('/backyard/backyard') @section ('content') <div class="container"> <div class="row row-offcanvas row-offcanvas-right"> <div class="col-xs-12 col-sm-9"> <p class="pull-right visible-xs"> <button type="button" class="btn btn-primary btn-xs" data-toggle="offcanvas">Toggle nav</button> </p> <div class="jumbotron"> <h1> 思维笔记 </h1> <p> 思维笔记，记录你灵魂的变化。</p> </div> </div> @include ('backyard.include.sidebar') </div><!--/row--> </div> <!-- /container --> @endsection

如图 15.3 所示为会员管理视图页面。

会员管理视图文件的代码如下：

文件 mindlevel\resources\views\backyard\user\index.blade.php @extends ('/backyard/backyard') @section ('content') <div class="container"> <div class="row row-offcanvas row-offcanvas-right"> <div class="col-xs-12 col-sm-9"> <p class="pull-right visible-xs"> <button type="button" class="btn btn-primary btn-xs" data-toggle="offcanvas">Toggle nav</button> </p> <h3> 会员信息列表 </h3> <table class="table table-striped table-hover"> <thead> <tr> <th>ID 号 </th> <th> 账号 </th> <th> 注册时间 </th> <th> 状态 </th> <th> 操作 </th> </tr> </thead> <tbody> <?php foreach ($attributes ['userList'] as $vo){echo "<tr>"; echo "<td>{$vo ['id']}</td>"; echo "<td>{$vo ['username']}</td>"; echo "<td>".date ("Y-m-d",$vo ['addtime'])."</td>"; echo "<td>".(($vo ['state']==1)?"启用":"禁用")."</td>"; echo "<td> <a href=\"/backyard/userInfo?uid={$vo ['id']}\"><span class=\"glyphicon glyphicon-search\"title=\" 详情 \"></span></a>＆nbsp;＆nbsp; </td>"; echo "</tr>"; } ?> </tbody> </table> </div><!--/.col-xs-12.col-sm-9--> @include ('backyard.include.sidebar') </div><!--/row--> </div> <!-- /container --> @endsection

图 15.3　会员管理视图

思维笔记管理的控制器设计通过一个控制器类 (App\Http\Controllers\ WebController 类) 实现，用户管理的控制器方法的设计如下：

<?php namespace App\Http\Controllers; use App\Http\Controllers\Controller; use Illuminate\Contracts\Auth\Guard; use Request; use Validator; use App\Models\Users; use App\Models\TbCategory; use App\Models\TbRecords; class WebController extends Controller { // 自定义模板引擎的属性信息 private $attributes = array (); public function __construct (Guard $auth) {$this->middleware ('auth'); $this->auth = $auth; if ($this->auth->user ()){$this->authSave ();} } private function authSave () { $this->attributes ['username'] = $this->auth->user ()->getAttribute ('username'); $this->attributes ['uid'] = $this->auth->id ();} // 查询属性信息 private function getAttibute ($key) {return $this->attributes [$key]; } // 在 attributes 中放置的属性 private function addAttributes ($param,$value) {$this->attributes [$param] = $value; } //Web 访问根目录时的功能 public function getIndex () { $user = $this->auth->user (); return view ('/backyard/index/index')->with ('attributes',$this->attributes); } // 会员信息列表 public function getUserlist () { $modle = new Users (); $data = $modle->findAll ()->toArray (); $this->addAttributes ("userList", $data); return view ("/backyard/user/index")->with ('attributes',$this->attributes); } }

15.3.3　笔记类别管理模块

笔记类别管理主要需要实现几个功能，分别是笔记类别显示功能、笔记类别添加功能、笔记类别浏览功能和笔记类别删除功能，其中笔记类别显示功能用于显示该用户的所有笔记类别，以及每个类别中包含多少篇文章，笔记类别的添加和删除功能用于添加和删除新的笔记类别，而笔记类别浏览功能是浏览该类别中所有笔记的标题。笔记类别管理视图页面如图 15.4 所示。

图 15.4　笔记类别管理视图

笔记类别浏览视图页面如图 15.5 所示。

图 15.5　笔记类别浏览视图

笔记类别管理视图文件的代码如下：

文件 mindlevel\resources\views\backyard\category\index.blade.php @extends ('/backyard/backyard') @section ('content') <div class="container"> <div class="row row-offcanvas row-offcanvas-right"> <div class="col-xs-12 col-sm-9"> <p class="pull-right visible-xs"> <button type="button" class="btn btn-primary btn-xs" data-t o g g l e="o f f c a n v a s">T o g g l e n a v</b u t t o n> </p> <h3> 笔记类别信息列表 </h3> <button type="button" class="btn btn-primary" data-toggle="offcanvas" onclick="window.location='/web/categoryadd'"> 添加分类 </button> <table class="table table-striped table-hover"> <thead> <tr> <th>ID 号 </th> <th> 类别名称 </th> <th> 笔记数量 </th> <th> 操作 </th> </tr> </thead> <tbody> <?php foreach ($attributes ['catList'] as $vo){echo "<tr>"; echo "<td>{$vo ['id']}</td>"; echo "<td>{$vo ['name']}</td>"; echo "<td>{$vo ['count']}</td>"; echo "<td><button type=\"button\"class=\"btn btn-primary\"onclick=\"window.location='/web/noteslist/{$vo ['id']}'\"> 浏览笔记 </button></td>"; echo "<td><button type=\"button\"class=\"btn btn-primary\"onclick=\"window.location='/web/deletecat/{$vo ['id']}'\"> 删除分类 </button></td>"; echo "</tr>"; } ?> </tbody> </table> </div><!--/.col-xs-12.col-sm-9--> @include ('backyard.include.sidebar') </div><!--/row--> </div> <!-- /container --> @endsection 文件 mindlevel\resources\views\backyard\category\add.blade.php @extends ('/backyard/backyard') @section ('content') <div class="container"> <div class="row row-offcanvas row-offcanvas-right"> <div class="col-xs-12 col-sm-9"> <p class="pull-right visible-xs"> <button type="button" class="btn btn-primary btn-xs" data-toggle="offcanvas">Toggle nav</button> </p> <h3> 笔记类别添加 </h3> <input type="hidden" id="domain" value="http://7u2r8g.com1.z0.glb.clouddn.com/"> <input type="hidden" id="uptoken_url" value="/admin.php/uptoken"> <form class="form-horizontal col-sm-10" role="form" action="/web/categoryadd" method="post"> <div class="form-group"> <label for="inputEmail3" class="col-sm-2 control-label"> 类别名称 </label> <div class="col-sm-10"> <input type="text" name="name" class="form-control" id="inputEmail3" placeholder="text"> </div> </div> <div class="form-group"> <div class="col-sm-offset-2 col-sm-10"> <input type="submit" class="btn btn-default" value="添加" /> </div> </div> </form> </div><!--/.col-xs-12.col-sm-9--> @include ('backyard.include.sidebar') </div><!--/row--> </div> <!-- /container --> @endsection 文件 mindlevel\resources\views\backyard\notes\index.blade.php @extends ('/backyard/backyard') @section ('content') <div class="container"> <div class="row row-offcanvas row-offcanvas-right"> <div class="col-xs-12 col-sm-9"> <p class="pull-right visible-xs"> <button type="button" class="btn btn-primary btn-xs" data-toggle="offcanvas">Toggle nav</button> </p> <h3> 笔记列表 </h3> <table class="table table-striped table-hover"> <thead> <tr> <th>ID 号 </th> <th> 标题 </th> <th> 类别 </th> <th> 发布时间 </th> <th> 状态 </th> <th> 操作 </th> </tr> </thead> <tbody> <?php foreach ($attributes ['recordsList'] as $vo){echo "<tr>"; echo "<td>{$vo ['id']}</td>"; echo "<td>{$vo ['title']}</td>"; echo "<td>{$vo ['cid']}</td>"; echo "<td>".date ("Y-m-d",$vo ['addtime'])."</td>"; echo "<td>".(($vo ['state']==1)?"启用":"禁用")."</td>"; echo "<td> <a href=\"/web/noteshow/{$vo ['id']}\"><span class=\"glyphicon glyphicon-search\"title=\" 详情 \"></span></a>＆nbsp;＆nbsp; <a href=\"/web/noteedit/{$vo ['id']}\"><span class=\"glyphicon glyphicon-pencil\"title=\" 编辑 \"></span></a>＆nbsp;＆nbsp; <a h r e f=\"/w e b/deletenote/{$vo ['id']}\"><span class=\"glyphicon glyphicon-trash\"title=\" 删除 \"></span></a> </td>"; echo "</tr>"; } ?> </tbody> </table> </div><!--/.col-xs-12.col-sm-9--> @include ('backyard.include.sidebar') </div><!--/row--> </div> <!-- /container --> @endsection

接下来针对上述需要的功能和视图页面进行控制器方法的设计，这里对于笔记类别的显示通过 getCategorylist () 方法实现，主要是通过用户名 id 获取关于该用户的所有笔记分类，并通过 /backyard/category/index 视图显示出来；笔记类别的添加是通过 getCategoryadd () 方法和 postCategoryadd () 方法实现的，其中 get () 方法用于显示添加视图页面，而 post () 方法用于提交用户添加笔记分类的数据并在相应数据表中进行添加；删除笔记分类是通过 getDeletecat () 方法实现的，该方法接收一个分类的 id 并将数据表的状态字段设置为 0，表示该分类已经被删除，这里为了不丢失笔记，会将该分类中的笔记添加到其他的分类中。

// 显示笔记类别信息 public function getCategorylist () { $model = new TbCategory (); $data = $model->findUserAll ($this->getAttibute ('uid')); $this->addAttributes ("catList", $data); return view ("/backyard/category/index")->with ('attributes',$this->attributes); } // 添加笔记类别 public function getCategoryadd () { return view ("/backyard/category/add")->with ("attributes",$this->attributes); } // 添加笔记类别 public function postCategoryadd () { $model = new TbCategory (); $param = $_POST; $param ['uid'] = $this->getAttibute ('uid'); $param ['count'] = 0; $param ['state'] = TbCategory::$state ['use']; $model->categoryAdd ($param); return redirect ("/web/categorylist"); } // 删除一个分类 public function getDeletecat ($cid) {$model = new TbCategory (); $nextId = $model->deleteCat ($this->getAttibute ('uid'),$cid); $remodel = new TbRecords (); $num = $remodel->changeCat ($this->getAttibute ('uid'),$cid,$nextId); $nextCat = $model->find ($nextId); $nextCat->count = $nextCat->count+$num; $nextCat->save (); return redirect ("/web/categorylist"); } // 加载笔记列表页 public function getNoteslist ($cid=0) {$model = new TbRecords (); $data = $model->findUserAll ($this->getAttibute ('uid'), $cid); $this->addAttributes ("recordsList", $data); return view ("/backyard/notes/index")->with ("attributes",$this->attributes); }

15.3.4　笔记管理模块

笔记管理模块主要包含笔记浏览显示、笔记添加、笔记删除、笔记修改和编辑等操作。其中，笔记浏览显示功能将显示所有类别的笔记；在笔记添加功能页面，需要添加笔记的标题和内容；笔记类别是通过选择确定的，如果没有相应的类型需要先添加笔记类别；笔记修改和编辑是将原笔记内容取出并添加到视图中，可以对笔记所有的属性进行修改和编辑。笔记管理视图页面如图 15.6 所示。

图 15.6　笔记管理视图

笔记添加视图页面如图 15.7 所示。

图 15.7　笔记添加视图

笔记修改和编辑视图页面如图 15.8 所示。

图 15.8　笔记修改和编辑视图

笔记管理模块的代码如下：

文件 mindlevel\resources\views\backyard\notes\add.blade.php @extends ('/backyard/backyard') @section ('content') <div class="container"> <div class="row row-offcanvas row-offcanvas-right"> <div class="col-xs-12 col-sm-9"> <p class="pull-right visible-xs"> <button type="button" class="btn btn-primary btn-xs" data-toggle="offcanvas">Toggle nav</button> </p> <h3> 添加笔记信息 </h3> <input type="hidden" id="domain" value="http://7u2r8g.com1.z0.glb.clouddn.com/"> <input type="hidden" id="uptoken_url" value="/admin.php/uptoken"> <form class="form-horizontal col-sm-10" role="form" action="/web/notesinsert" method="post"> <div class="form-group"> <label for="inputEmail3" class="col-sm-2 control-label"> 笔记标题 </label> <div class="col-sm-10"> <input type="text" name="title" class="form-control" id= "inputEmail3" placeholder="text" value="{{ old ('title') }}"> </div> </div> <div class="form-group"> <label for="inputEmail3" class="col-sm-2 control-label"> 笔记类别 </label> <div class="col-sm-10"> <select name="cid"> <?php foreach ($attributes ['cglist'] as $vo){echo "<option value='{$vo ['id']}'>{$vo ['name']} </option>"; } ?> </select> </div> </div> <div class="form-group"> <label for="inputPassword3" class="col-sm-2 control-label"> 笔记内容 </label> <div class="col-sm-10"> <textarea cols="50" rows="10" name="content" value="{{ old ('content') }}"></textarea> </div> </div> <div class="form-group"> <div class="col-sm-offset-2 col-sm-10"> <input type="submit" class="btn btn-default" value="添加" /> </div> </div> </form> </div><!--/.col-xs-12.col-sm-9--> @include ('backyard.include.sidebar') </div><!--/row--> </div> <!-- /container --> @endsection 文件 mindlevel\resources\views\backyard\notes\edit.blade.php @extends ('/backyard/backyard') @section ('content') <div class="container"> <div class="row row-offcanvas row-offcanvas-right"> <div class="col-xs-12 col-sm-9"> <p class="pull-right visible-xs"> <button type="button" class="btn btn-primary btn-xs" data-toggle="offcanvas">Toggle nav</button> </p> <h3> 添加笔记信息 </h3> <input type="hidden" id="domain" value="http://7u2r8g.com1.z0.glb.clouddn.com/"> <input type="hidden" id="uptoken_url" value="/admin.php/uptoken"> <form class="form-horizontal col-sm-10" role="form" action="/web/notechange/{{$id}}}" method="post"> <div class="form-group"> <label for="inputEmail3" class="col-sm-2 control-label"> 笔记标题 </label> <div class="col-sm-10"> <input type="text" name="title" class="form-control" id="inputEmail3" placeholder="text" value="{{ $title}}"> </div> </div> <div class="form-group"> <label for="inputEmail3" class="col-sm-2 control-label"> 笔记类别 </label> <div class="col-sm-10"> <select name="cid"> <?php foreach ($attributes ['cglist'] as $vo){if ($vo ['id'] == $cid){echo "<option value='{$vo ['id']}' selected>{$vo ['name']}</option>"; } else {echo "<option value='{$vo ['id']}'>{$vo ['na me']}</option>"; } } ?> </select> </div> </div> <div class="form-group"> <label for="inputPassword3" class="col-sm-2 control-label"> 笔记内容 </label> <div class="col-sm-10"> <textarea cols="50" rows="10" name= "content">{{$content}}</textarea> </div> </div> <div class="form-group"> <div class="col-sm-offset-2 col-sm-10"> <input type="submit" class="btn btn-default" value="更新" /> </div> </div> </form> </div><!--/.col-xs-12.col-sm-9--> @include ('backyard.include.sidebar') </div><!--/row--> </div> <!-- /container --> @endsection 文件 mindlevel\resources\views\backyard\notes\show.blade.php @extends ('/backyard/backyard') @section ('content') <div class="container"> <div class="row row-offcanvas row-offcanvas-right"> <div class="col-xs-12 col-sm-9"> <p class="pull-right visible-xs"> <button type="button" class="btn btn-primary btn-xs" data-toggle="offcanvas">Toggle nav</button> </p> <h3>{{$title}}</h3> <p> {{$content}} </p> </div><!--/.col-xs-12.col-sm-9--> @include ('backyard.include.sidebar') </div><!--/row--> </div> <!-- /container --> @endsection

在笔记管理控制器的设计中，笔记列表显示与笔记类别管理中的笔记类别显示使用相同的视图和控制器方法，只是在显示笔记类别时会传递类别号，于是只显示该类别的笔记信息，而在笔记类别管理中的笔记显示则不传递类别号，于是显示所有类别的笔记信息；笔记添加是通过 getNotesadd () 方法和 postNotesinsert () 方法实现的，同样，get () 方法用于显示笔记添加视图页面与用户交互，而 post () 方法是将用户提交的数据添加到相应的数据表中，笔记添加需要注意的是验证其添加的内容是否符合数据表设计的要求；笔记的删除是通过 getDeletenote ($id) 方法实现的，在数据表中并没有真正地将笔记删除，而是将状态标识字段设置为 0；笔记修改和编辑是通过 getNoteedit ($id) 方法实现的，根据笔记的 id 号取出笔记并进行编辑，然后对数据表中的数据进行更新。笔记管理控制器的设计代码如下：

// 添加笔记 public function getNotesadd () { $model = new TbCategory (); $data = $model->findUserAll ($this->getAttibute ('uid')); $this->addAttributes ('cglist',$data); return view ("/backyard/notes/add")->with ("attributes",$this->attributes); } // 插入笔记 public function postNotesinsert () { $validator = $this->validator (Request::all ()); if ($validator->fails ()) {$this->throwValidationException (Request::instance (), $validator ); } // 准备数据 $model = new TbCategory (); $param = $_POST; $param ['uid'] = $this->getAttibute ('uid'); $param ['cid'] = (!empty ($param ['cid']))?$param ['cid']:$model- >firstOrNewId ($this->getAttibute ('uid')); $param ['addtime'] = time (); $param ['state'] = 1; // 存储笔记 $rmodel = new TbRecords (); $suc = $rmodel->insert ($param); if ($suc){return redirect ("/web/noteslist"); } else {return redirect ("/web/notesadd"); } } // 验证插入笔记的内容 private function validator (array $data) {return Validator::make ($data, [ 'title' => 'requiredlmax:255', 'content' => 'required', // 'cid' => 'required', ]); } // 删除笔记 public function getDeletenote ($id) {$model = TbRecords::find ($id); $model->state = TbRecords::$state ['delete']; $cid = $model->cid; $model->save (); $catModel = new TbCategory (); $catModel->countReduce ($cid,1); return redirect ("/web/noteslist"); } // 编辑笔记 public function getNoteedit ($id) {$model = new TbCategory (); $catData = $model->findUserAll ($this->getAttibute ('uid')); $this->addAttributes ('cglist',$catData); $model = TbRecords::find ($id); $data = $model->toArray (); $data ['attributes'] = $this->attributes; return view ('/backyard/notes/edit',$data); } public function postNotechange ($id) {$model = TbRecords::find ($id); $model->fill ($_POST); $model->save (); return redirect ("/web/noteslist"); } public function getNoteshow ($id) {$model = TbRecords::find ($id); $data = $model->getAttributes (); $data ['attributes'] = $this->attributes; return view ('/backyard/notes/show',$data); }

本章通过一个简单的实例将 Laravel 框架中各功能模块融合在一起完成一项简单的功能。在实现过程中可以看到，通过 Laravel 框架开发一个应用主要工作集中在前端界面、业务逻辑和数据库构建，这些工作量其实也不算少。Laravel 框架的优势是提供了一整套服务器程序组件，由于这些组件都是基础的、通用的，所以通过它们用户可以非常灵活、自由地开发一个项目，受到的约束很小；缺点是如果要实现一个项目还有大量的工作要做，所以 Laravel 更适合于企业级开发，有大型的团队做支持。如果需要快速开发一个应用或者自己创建一个应用，这个工作量可能也是无法承受的。所以，在一个项目中，是否采用 Laravel 框架还需视具体情况而定。