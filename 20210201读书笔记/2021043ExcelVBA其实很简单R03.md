# 2021043ExcelVBA其实很简单R03

## 记忆时间

## 0601. 用户界面设计

### 6.1 在 Excel 中自由地设计界面

6.1.1 关于用户界面 

为什么要设计用户界面 

用户界面就像电视机的遥控板，是用户与程序进行互动的窗口。一个合理的程序，总会设计一个或多个供用户操作的界面。用户界面不仅能为操作提供便利，还能增强视觉感，使程序显得更直观、更专业。怎样设计用户界面 同绘画一样，设计界面就是用户按自己的意愿，在工作表或用户窗体中有目的地添加控件，并给这些控件指定功能。

6.1.2 控件，必不可少的调色盘 

Excel 里有两种类型的控件：窗体控件（【窗体】工具栏中的控件）和 ActiveX 控件（【控件工具箱】中的控件）。

窗体控件 

要向工作表中添加窗体控件，应先调出【窗体】工具栏，如图 6-1 所示。

图 6-1 调出【窗体】工具栏 

【窗体】工具栏中一共有 16 个控件，其中有 9 个可以添加到工作表中，如图 6-2 所示，控件说明见表 6-1 所示。

图 6-2 窗体工具栏中可使用的控件 

表 6-1 各种窗体控件的说明     

| 控件名称 | 控件说明 |
| --- | --- |
| 标签 | 用于输入和显示静态文本 |
| 分组框 | 用于组合其他多个控件 |
| 按钮 | 用于执行宏命令 |
| 复选框 | 选择控件，可以多项选择 |
| 选项按钮 | 用于选择的控件，通常几个选项按钮用组合框组合在一起使用，在一组中只能同时选择一个选项按钮 |
| 列表框  | 显示多个选项的列表，用户可以从中选择一个选项  |
| 组合框 | 提供可选择的多个选项，用户可以选择其中的一个项目 |
| 滚动条 | 包括水平滚动条和垂直滚动条 |
| 微调控件 | 通过单击控件的箭头来选择数值 | 

ActiveX 控件 

要添加 ActiveX 控件，应先调出【控件工具箱】，如图 6-3 所示。

图 6-3 调出控件工具栏 

默认情况下，【控件工具箱】中有 11 个控件，如图 6-4 所示。

图 6-4 控件工具箱中默认的控件 

但能使用的 ActiveX 控件并不只有 11 个，单击【控件工具箱】中的【其他控件】按钮，如图 6-5 所示。

图 6-5 选择其他的控件

### 6.2 使用控件，将工作表当作画布

窗体控件和 ActiveX 控件就像两个调色盘，画蓝天的时候从里面选择蓝色，画白云的时候从里面选择白色。而 Excel 的工作表就像一张大画布，你可以在上面任意勾勒，绘出一幅漂亮的蓝天白云图。

6.2.1 在工作表中使用窗体控件 

添加一个组合框控件 

调出【窗体】工具栏，选中组合框控件，按住鼠标左键的同时，拖动鼠标即可在工作表中添加控件，如图 6-6 所示。

图 6-6 添加控件 

设置控件格式 

设置控件格式的步骤如图 6-7 所示。

图 6-7 设置控件 

如果想修改控件的名称，可以选中控件，在名称框里修改，如图 6-8 所示。

图 6-8 修改控件的名称 

使用控件 

使用窗体控件的步骤如图 6-9 所示。

图 6-9 使用窗体控件 

6.2.2 在工作表中使用 ActiveX 控件 

向工作表中添加选项按钮 在【控件工具箱】中选择【选项按钮】控件，按住鼠标左键的同时，拖动鼠标即可在工作表中添加一个选项按钮，如图 6-10 所示。

图 6-10 在工作表中添加选项按钮 

设置控件格式 新添加的按钮，可以在【属性窗口】中设置它的属性来更改它的外观样式，如图 6-11 所示。

图 6-11 设置 ActiveX 控件的格式 

继续在工作表中添加一个选项按钮控件，在【属性窗口】中设置标签为「女」，名称为 xb2，如图 6-12 所示。

图 6-12 新添加的 ActiveX 控件 

为控件添加程序 ActiveX 控件与窗体控件不同，在使用前，需要用户针对控件编写相应的代码。前文添加的两个控件，如果想知道用户选择的是「男」还是「女」，得分别给这两个控件编写事件过程，如图 6-13 所示。

图 6-13 为控件添加事件过程 

用同样的方法为控件 xb2 编写事件过程，如图 6-14 所示。

图 6-14 为控件添加的程序代码 

使用控件 

返回工作表区域，单击【控件工具箱】中的【退出设计模式】按钮，就可以使用控件了，如图 6-15 所示。

图 6-15 在工作表中使用 ActiveX 控件 

6.2.3 窗体控件和 ActiveX 控件的区别 

窗体控件只能在工作表中通过设置控件的格式或指定宏来使用，ActiveX 控件拥有很多属性和事件，可以在工作表和用户窗体中使用。如果是以编辑数据为目的，一般使用窗体控件就可以了，但如果在编辑数据的同时还要进行其他操作，使用 ActiveX 控件会灵活得多。

### 6.3 与用户交互，简单的输入输出对话框 

对话框是程序与用户进行交互的工具，用来输入或输出信息。

6.3.1 InputBox 函数 

InputBox 函数创建一个接受用户输入的对话框，供用户输入数据。运行程序后 Excel 会显示一个对话框，如图 6-16 所示。

图 6-16 运行程序后显示的对话框 

根据提示，在对话框中输入姓名后单击【确定】按钮，输入的姓名即可自动写进活动工作表的 A1 单元格，如图 6-17 所示。

图 6-17 利用对话框输入姓名 

编写代码时，所有的参数名称都是可以省略的。除了 prompt 参数外，其实参数都可以省略。也可以只省略其中的一个或几个参数。

6.3.2 Application 对象的 InputBox 方法 

使用 Application 对象的 InputBox 方法也可以创建接受用户输入的对话框。除了 Left 与 Top 参数，InputBox 方法的其他参数与 InputBox 函数的参数的作用相同。InputBox 方法的 Left 和 Top 参数指定对话框在 Excel 工作表窗口中的位置，如图 6-18 所示，而 InputBox 函数的 xpos 与 ypos 参数指定对话框在整个屏幕窗口中的位置，如图 6-15 所示。

图 6-18 InputBox 方法的 Top 与 Left 参数 

既生 InputBox 函数，何生 InputBox 方法 

对比一下它们的参数区别，可以知道二者的区别。完整的参数，可以在 VBA 帮助里看到，也可以在输入代码的时候，在代码窗口里看到，如图 6-19 所示。

图 6-19 在代码窗口中查看参数 InputBox 函数只能返回一个 String 型的字符串，而 InputBox 方法返回的数据类型不确定，并且，InputBox 方法比 InputBox 函数多一个 Type 参数。

Type 参数有什么作用 

设置 InputBox 方法的 Type 参数值，指定返回的数据类型，如表 6-2 所示。

表 6-2 Type 参数说明    

| 参数值 | 含义 |
| --- | --- |
| 0 | 公式 |
| 1 | 数字 |
| 2 |  文本（字符串）  |
| 4 | 逻辑值（True 或 False） |
| 8 | 单元格引用（Range 对象） |
| 16 | 错误值，如 #N/A |
| 64 | 数值数组 |

下面的程序让用户选择一个单元格区域，然后在单元格区域输入数值 100，如图 6-20 所示。

图 6-20 使用 InputBox 方法 

如果返回值为多种类型中的一种，就把 Type 参数的值设为相应类型的和。

练习小课堂：在表 6-2 中，你知道 Type 的参数值为什么是 0、1、2、4、8…… 这样有间隔而不是连续的自然数吗？ 

参考答案：因为中间空开的数值（如 3）可以是多种参数值之和（如 1+2），为了不混淆，所以参数值是有间隔而不是连续的自然数。

6.3.3 MsgBox 函数 

使用 MsgBox 函数，可以创建一个对话框，告诉用户某些信息，并等待用户单击其中某个按钮后继续运行。其效果如图 6-21 所示。

图 6-21 MsgBox 函数创建的对话框 

设置显示的按钮 MsgBox 函数一共有 6 种按钮设定，如表 6-3 和图 6-22 所示。

表 6-3 Msgbox 的 6 种按钮设定     

| 常数 | 值 | 说明 |
| --- | --- | --- |
| vbOkonly | 0 | 只显示【确定】按钮 |
| vbOkCancel | 1 | 显示【确定】和【取消】两个按钮 |
| vbAbortRetryIgnore | 2 | 显示【终止】、【重试】和【忽略】3 个按钮 |
| vbYesNoCancel | 3 | 显示【是】、【否】和【取消】3 个按钮 |
| vbYesNo | 4 | 显示【是】和【否】两个按钮 |
| vbRetryCancel | 5 | 显示【重试】和【取消】两个按钮 |

图 6-22 Msgbox 函数 6 种按钮设定 

设置显示的图标样式 MsgBox 函数一共有 4 种图标样式，如表 6-4 和图 6-23 所示。

表 6-4 Msgbox 的 4 种图标样式     

| 常数 | 值 | 说明 |
| --- | --- | --- |
| vbCritical | 16 | 显示「关键信息」图标 |
| vbQuestion | 32 | 显示「警告询问」图标 |
| vbExclamation | 48 | 显示「警告消息」图标 |
| vbInformation | 64 | 显示「通知消息」图标 |

图 6-23 不同的图标样式 

可以同时设置显示的按钮和图标，在两个常数或值之间用 + 号连接：

其效果如图 6-24 所示。

图 6-24 设置按钮及显示图标 

设置缺省按钮 

默认情况下按回车键即可执行的按钮称为缺省按钮，如图 6-25 所示。

图 6-25 缺省按钮 

如果要修改第二个按钮为缺省按钮，可以设置 Buttons 参数的参数值。其效果如图 6-26 所示。

图 6-26 设置第 2 个按钮为缺省按钮 如果想设置第三个、第四个按钮为缺省按钮，相应的参数如表 6-5 所示。

表 6-5 设置缺省按钮的参数     

| 常数 | 值 | 说明 |
| --- | --- | --- |
| vbDefaultButton1 | 0 | 第一个按钮为缺省按钮 |
| vbDefaultButton2 | 256 | 第二个按钮为缺省按钮 |
| vbDefaultButton3 | 512 | 第三个按钮为缺省按钮 |
| vbDefaultButton4 | 768 | 第四个按钮为缺省按钮 |

指定对话框类型 

Buttons 参数还有第四组设定值，用来决定对框的类型，如表 6-6 所示。

表 6-6 对话框的类型     

| 常数 | 值 | 说明 |
| --- | --- | --- |
| vbApplicationModal | 0 | 应用程序强制返回；暂停执行应用程序，直到用户对消息框作出响应才继续工作 |
| vbSystemModal | 4096 | 系统强制返回；暂停执行所有程序，直到用户对消息框作出 响应才工作 |

MsgBox 函数的返回值 

设置 Buttons 参数可以让对话框显示不同的按钮，单击不同的按钮，将返回不同的值，如表 6-7 所示，程序可以根据返回值选择不同的操作，如：

表 6-7 MsgBox 函数的返回值

| 常数 | 值 | 描述 |
| --- | --- | --- |
| vbOK | 1 | 单击【确定】按钮 |
| vbCancel | 2 | 单击【取消】按钮 |
| vbAbort | 3 | 单击【终止】按钮 |
| vbRetry | 4 | 单击【重试】按钮 |
| vbIgnore | 5 | 单击【忽略】按钮 |
| vbYes | 6 | 单击【是】按钮  |
| vbNo | 7 | 单击【否】按钮 |

6.3.4 Application 对象的 FindFile 方法 

使用 Application 对象的 FindFile 方法可以显示【打开】对话框，用户可以在对话框中选择并打开文件，如图 6-27 所示。

1-2『这里的 FindFile 以后很多地方会用到，收录进主题卡「VBA 对象方法」里去。（2021-03-20）』—— 已完成

图 6-27 用 FindFile 方法打开文件 

6.3.5 Application 对象的 GetOpenFilename 方法 

1-2『 GetOpenFilename 方法收录进主题卡「VBA 对象方法」里去。（2021-03-20）』—— 已完成

可以调用 Application 对象的 GetOpenFilename 方法显示【打开】对话框，在对话框里选择文件，获得文件名称。虽然同是显示【打开】对话框，但 GetOpenFilename 方法并不会打开选中的文件，而是返回所选文件的文件名（含路径）字符串，如图 6-28 所示。

图 6-28 不使用参数时 

可以使用 FileFilter 参数限制可选择的文件类型，如图 6-29 所示。

图 6-29 使用参数限制文件类型 

如果希望能在两种或多种类型的文件中选择，可以修改参数值，如图 6-30 所示。

图 6-30 使用参数限制文件类型 

也可以增加文件类型下拉列表中的项目，如图 6-31 所示。

图 6-31 增加文件类型下拉列表中的项目 

除了 filefilter，GetOpemFilename 方法还有其他参数，如图 6-32 所示。

图 6-32 当设置更多参数时 

6.3.6 Application 对象的 GetSaveAsFilename 方法 

可以调用 Application 对象的 GetSaveAsFilename 方法打开【另存为】对话框，在对话框里选择文件，获得文件名，如图 6-33 所示。

图 6-33 用 GetSaveAsFilename 方法获取文件名 

6.3.7 Application 对象的 FileDialog 属性 

使用 Application 对象的 FileDialog 属性可以获得指定目录的路径及名称，如图 6-34 所示。

图 6-34 获取目录名称 

除了 msoFileDialogFolderPicker，filedialogtype 参数还可以选用其他的值，如表 6-8 所示。

表 6-8 msoFileDialogType 

| 常量列表 | 常量说明 |
| --- | --- |
| msoFileDialogFilePicker | 允许选择一个文件 |
| msoFileDialogFolderPicker | 允许选择一个文件夹 |
| msoFileDialogOpen | 允许打开一个文件 |
| msoFileDialogSaveAs | 允许保存一个文件 |

### 6.4 构建用户窗体，自己设计交互界面 

6.4.1 关于用户窗体 

用户窗体是 Excel 中的另一对象 —— UserForm 对象。用户可以在窗体上自由添加 ActiveX 控件，并利用这些控件从用户那里获得信息，或将信息输出给用户。

1-2『 UserForm 对象，这不就是 autolisp 里的 dcl 组件么，跟三方包 opendcl 的功能也一样。做一张术语卡片。（2021-03-20）』—— 已完成

6.4.2 添加一个用户窗体 

添加一个用户窗体的方法如图 6-35 和图 6-36 所示。

方法一：图 6-35 利用菜单命令插入窗体 

方法二：图 6-36 利用右键菜单插入窗体 

6.4.3 设置窗体的属性 

作为对象，用户窗体也有自己的属性，如名称、大小等。新窗体的所有属性都是默认的，可以在【属性窗口】中重新设置，如图 6-37 所示。

图 6-37 设置窗体 想将窗体设置为何种样式，就在【属性窗口】里修改对应的属性。为了便于查询，Excel 允许用户按不同的排序方式查看对象的属性，如图 6-38 所示。

图 6-38 按分类序查看对象属性 

如果对属性列表中某个属性不太熟悉，选中属性名称，按 `<F1>` 键，即可查看关于它的帮助信息，如图 6-39 所示。

图 6-39 查看帮助信息 

6.4.4 在窗体上添加控件 

新插入的窗体，只是一个空白的对话框，要想实现同用户交互的目的，需要往窗体上添加不同的控件。要向窗体中添加控件，应先调出【工具箱】，如图 6-40 所示。

图 6-40 调出工具箱 

向窗体中添加控件的方法如图 6-41 和图 6-42 所示。

图 6-41 向窗体中添加控件 

图 6-42 设置控件的属性 

练习小课堂：参照添加和设置标签控件的方法，继续在窗体上添加其他控件，设计一个简单的信息录入界面，如图 6-43 所示。

图 6-43 信息录入界面 

6.4.5 显示窗体 

显示窗体就是把设计好的窗体显示给用户。手动显示窗体 手动显示窗体的方法如图 6-44 所示。

图 6-44 手动显示窗体 用代码显示窗体 

显示一个窗体要经过两个步骤：如果在调用窗体的 Show 方法前窗体没有加载，Excel 会自动加载这个窗体，然后再显示它。所以显示窗体可以省略加载窗体的语句，直接调用窗体对象的 Show 方法。

窗体的显示模式 

模式窗体：窗体显示后将停止执行「显示窗体」之后的代码，直到退出或隐藏窗体，并且只有退出或隐藏窗体后，才可以操作窗体外的其他元素，如图 6-45 所示。

图 6-45 显示模式窗体 

无模式窗体：窗体显示后会继续执行程序里余下的语句，并且可以操作其他窗体或界面，如图 6-46 所示。

图 6-46 显示无模式窗口 

6.4.6 关闭窗体 

手动关闭窗体 

手动关闭窗体如图 6-47 所示。

图 6-47 手动关闭窗体 

使用代码关闭窗体 

如果想取消显示窗体，可以隐藏或卸载它。尽管隐藏和卸载窗体都能将窗体从屏幕上删除，但因为显示一个隐藏的窗体比显示一个卸载的窗体用的时间短，所以当需要反复使用某个窗体时，建议用 Hide 方法隐藏，而不用 Unload 语句卸载它。

6.4.7 使用控件 

作为对象，窗体和窗体上的控件，都有不同的事件。想让窗体真正工作起来，应为窗体和控件编写相应的事件过程。初始化窗体，UserForm 对象的 Initialize 事件 加载窗体时会触发 Initialize 事件。在这个事件中，可以对窗体、变量等进行初始化设置，如图 6-48 所示。

图 6-48 使用 Initialize 事件 设置性别复合框的条目为「男」和「女」后如图 6-49 所示。

图 6-49 使用控件 

为命令按钮添加事件过程 

Step 1 ：用同样的方法给「确定」按钮添加事件过程。

Step 2 ：给【退出】按钮添加事件过程。使用窗体录入数据 完成上述设置后，显示窗体，就可以使用窗体向工作表中录入数据了，如图 6-50 所示。

图 6-50 使用窗体录入数据 

6.4.8 用键盘控制控件 

更改控件的 `<Tab>` 键顺序 只有对象具有焦点时，才能接受键盘输入。控件的 `<Tab>` 键顺序决定用户在按下 `<Tab>` 键或 `<Shift+Tab>` 组合键后激活控件的顺序。在设计用户窗体时，系统会按添加控件的先后顺序确定控件的 `<Tab>` 键顺序。当然，这个顺序是可以更改的，如图 6-51 所示。

图 6-51 更改控件的 `<Tab> `键顺序 给控件指定快捷键 

给控件指定快捷键如图 6-52 所示。

图 6-52 给控件设置快捷键 

设置【确定】按钮的 Accelerator 属性为 N 后，按下 `<Alt+N>` 组合键，就等同于在窗体中单击【确定】按钮。

### 6.5 改造 Excel 现有的界面

6.5.1 更改标题栏的程序名称 

Excel 的标题栏用于显示程序及文件名称，默认的程序名称为 "Microsoft Excel"，可以设置 Application 对象的 Caption 属性修改它，如图 6-53 所示。

图 6-53 更改标题栏程序名称 

6.5.2 显示或隐藏菜单栏 

隐藏菜单栏的代码如下所示：其效果如图 6-54 所示。

图 6-54 隐藏菜单栏 

也可以使用循环语句来隐藏所有的菜单项：

如果要隐藏全部的菜单项，代码可以为：

设置的属性不同，最后得到的效果也不相同，如图 6-55 所示。

图 6-55 设置 Visible 与 Enabled 属性的区别 

6.5.3 显示或隐藏工具栏 

默认情况下，Excel 窗口中显示的工具栏只有【常用】工具栏和【格式】工具栏，如图 6-56 所示。

图 6-56 默认显示的工具栏 

可以通过相应的代码来隐藏或显示它们，如图 6-57 所示。

图 6-57 隐藏常用和格式工具栏 

如果 Excel 窗口中显示的工具栏不只两种，如图 6-58 所示。

图 6-58 实际可能会同时显示很多工具栏 

想隐藏窗口中显示的所有工具栏，可以使用程序：其效果如图 6-59 所示。

图 6-59 隐藏所有工具栏 

6.5.4 设置窗口 

还可以对工作表的窗口进行设置，如图 6-60 所示。

图 6-60 设置窗口 

6.5.5 其他设置

### 6.6 典型的技巧或示例 

6.6.1 设计一张调查问卷 

Excel Home 免费培训中心第一期培训结束了，希望通过调查问卷了解学员对培训的评价和建议，因此，需要设计一张调查问卷，如图 6-61 所示。

图 6-61 用 Excel 设计的调查问卷 

问卷的内容包括学员基本资料、单项选择、多项选择和学员建议 4 部分。

设计学员基本资料部分 

设计学员基本资料部分的操作如图 6-62 所示。

图 6-62 设置学员基本资料 

设计单项选择部分 

设计单项选择部分的操作如图 6-63 所示。

图 6-63 设计单项选择部分 

设计多项选择部分 

设计多项选择部分的操作如图 6-64 所示。

图 6-64 设计多项选择部分 

设计其他部分 

其他部分的设计如图 6-65 所示。

图 6-65 其他部分的设计 

装饰问卷界面 

Step 1：设置适合的背景或边框线、字体及其颜色，如图 6-66 所示。

图 6-66 修饰界面 

Step 2：取消显示网格线，如图 6-67 所示。

图 6-67 取消显示网格线 

Step 3：隐藏多余的行和列区域。自动登记调查结果 

为方便统计分析，学员填写完问卷后，要将结果保存到工作簿中的「调查结果」工作表里，如图 6-68 所示，可以编写一个程序来实现这个目的。

图 6-68 保存结果的工作表 

Step 1：插入一个标准模块，在模块中输入程序。

Step 2：在「问卷」工作表中添加一个按钮，更改标签为「提交问卷」，如图 6-69 所示，将编写的程序指定给按钮。

图 6-69 添加按钮 

Step 3：填写并保存问卷结果，如图 6-70 所示。

图 6-70 使用问卷 

保护问卷工作表 

如果你担心设计好的表格会被别人修改，可以锁定该工作表。

Step 1：锁定单元格，如图 6-71 所示。

图 6-71 锁定单元格 

取消锁定要输入数据的单元格，如图 6-72 所示。

图 6-72 取消锁定单元格 

Step 2：保护工作表，如图 6-73 所示。

图 6-73 保护工作表 

6.6.2 职工信息管理界面 

阿强是单位人事部的工作员，负责管理所有职工的档案，如图 6-74 所示。

图 6-74 职工信息表 

带着这个念头，阿强决定动手设计一个职工信息管理界面。设计界面内容，添加 ActiveX 控件 添加 ActiveX 控件，如图 6-75 所示。

图 6-75 添加 ActiveX 控件 

美化界面 

你可以根据需要随意对工作表进行装饰，如设置单元格的边框、底纹、字体、将多余的行和列隐藏，锁定不需要修改的单元格，设置工作表背景等，如图 6-76 所示。

图 6-76 美化后的界面及各个控件的功能 

给控件添加代码 管理界面中每个按钮要达到的目的都可以通过编写不同的事件过程来实现。因为所有的控件都绘制在工作表中，因此所有的事件过程都必须保存在控件所在的工作表对象里。右键单击工作表标签，执行【查看代码】菜单命令，在【代码窗口】中输入代码：

完成后返回工作表区域，退出设计模式，就可以使用设计的界面了。

练习小课堂：利用工作表设计的界面很容易被人改动，试一试，能不能利用窗体来设计这个界面？ 

参考答案：

参阅 6.6.3 小节中设置登录界面的方法。

6.6.3 一个简易的登录窗体 

设计登录窗体界面 

Step 1：新插入一个窗体，用鼠标指针调整大小，直到满意为止，如图 6-77 所示。

图 6-77 新插入的窗体 

Step 2：在窗体上添加控件，如图 6-78 所示。

图 6-78 登录窗体上的控件 

Step 3：更改窗体的名称及标题栏显示的文本，并对窗体作适当装饰，如图 6-79 所示。

图 6-79 设置窗体属性 

Step 4：设置文字框的属性（如字体），特别设置输入密码的文字框的 PasswordChar 属性为「*」，如图 6-80 所示。

图 6-80 设置密码输入框 为控件指定功能 因为只有当用户名和密码都输入正确后，才显示 Excel 的编辑界面，所以在打开工作簿时，应先将 Excel 界面隐藏，同时显示设计的登录窗体。

Step 1：在 ThisWorkbook 模块中写入程序：

Step 2：设置初始用户名和密码。新建名称来保存用户名，如图 6-81 所示。

图 6-81　新建名称保存用户名 再新建一个名称来保存登录密码，名称名为：UserWord，初始密码为：1234。

练习小课堂：为了不让别人在【定义名称】对话框中看到保存用户名和密码的名称，可以将定义的名称隐藏。怎样隐藏名称（参阅 4.6.1 小节），动手试一试。

参考答案：

Step 3：为【确定】按钮添加代码。双击【确定】按钮，在打开的【代码窗口】中输入程序：

Step 4：为【退出】按钮添加代码。双击【退出】按钮，在【代码窗口】中输入程序：

Step 5：为【更改用户名】按钮添加代码。双击【更改用户名】按钮，在【代码窗口】中输入程序：

Step 6：为【更改密码】按钮添加代码。双击【更改密码】按钮，在【代码窗口】中输入程序：

Step 7：设置单击窗体关闭按钮失效，如图 6-82 所示。

图 6-82 设置单击窗体关闭按钮失效 

双击登录窗体的空白处，在【代码窗体】中输入程序：设置完成后保存并关闭工作簿，重新打开它，就可以使用登录窗体了。

1-2『这一小节里的源码很值得研读。（2021-03-20）』—— 未完成

## 0701. 代码调试与优化 

在 Word 里写一篇讲话稿，无论多么认真仔细，都会出现一些失误。如不小心打上几个错别字或写下几个病句等，要想一次性完成一篇优秀的文章而不出现任何错误是极少见的。编写程序也是如此，在编写过程中，总会有一些问题被自己忽略。文章需要修改，代码也需要调试。

### 7.1 VBA 中可能会发生的错误 

7.1.1 编译错误 

如果编写代码时不遵循 VBA 的语法规则，如未定义变量、函数或属性名称拼写错误、语句不配对（如有 If 没有 End If，有 For 没有 Next）等都会引起编译错误，如图 7-1 所示。存在编译错误的程序，运行时系统会显示一个提示对话框，程序不会被执行，如图 7-1 所示。

图 7-1 运行存在编译错误的程序 

7.1.2 运行时错误 

如果程序在运行过程中试图完成一个不可能完成的操作，如除以 0、打开一个不存在的文件、删除一个打开的文件等都会发生运行时错误。运行存在运行时错误的程序，执行到错误代码所在行时，Excel 会显示一个错误提示对话框，如图 7-2 所示。

图 7-2 运行存在运行时错误的程序 

7.1.3 逻辑错误 

当程序中的代码没有语法问题，程序运行时，也没有不能完成的操作，但程序运行结束后，却不能得到预期的结果，这样的错误称为逻辑错误。把 1 到 10 的自然数依次写进 `A1:A10` 单元格，如果程序写成这样：

这个程序里的每句代码都没有语法错误，也没有不能完成的操作，但运行后却不能得到预期的效果，如图 7-3 所示。

图 7-3 程序运行前后 

编写程序时，很多原因都会引起逻辑错误。如：循环变量的初值和终值设置错误，变量类型不正确，代码顺序不正确等，而这些代码单独存在并没有任何问题。同其他两种错误不同，存在逻辑错误的程序，运行后程序会正常执行，Excel 并不会给出任何提示。所以，逻辑错误最难被发现，但在所有错误类型中占的比例却最大。因此，调试代码时，多数时间都是在修改程序中存在的逻辑错误。

### 7.2 VBA 程序的 3 种状态

7.2.1 设计模式 

设计模式是用户设计和编写 VBA 程序时程序所处的模式。当程序处于设计模式时，用户可以对程序进行任意修改。

7.2.2 运行模式

程序正在运行时的模式称为运行模式。在运行模式下，用户可以通过输入输出对话框与程序「对话」，也可以查看程序的代码，但不能修改程序。

7.2.3 中断模式 

中断模式是程序被临时中断执行（暂停执行）时所处的模式。在中断模式下，用户可以检查程序存在的错误或修改程序的代码，可以逐句执行程序，一边发现错误，一边更正错误。

### 7.3 Excel 已经准备好的调试工具

对于不太复杂的程序，寻找错误并不太难。当程序过长时，从满堆的代码中查找和修正错误就要伤神得多。幸运的是，Excel 已经准备好了一套方便有效的代码调试工具，善用它，可以使调试代码的工作变得更简单、更快捷。

7.3.1 让程序进入中断模式 

正因为在中断模式下可以一边运行程序，一边发现错误并修正错误，所以调试代码多数时间都选择在中断模式下进行。

出现编译错误时 

如果程序存在编译错误，运行时系统会自动显示错误提示对话框，如图 7-1 所示。对话框上有两个按钮，单击【帮助】按钮可以查看该错误的帮助信息；单击【确定】按钮即可进入中断模式，如图 7-4 所示。

图 7-4 出现编译错误时 

出现运行时错误 

如果程序存在运行时错误，运行后会停止在发生错误的代码所在行，自动显示错误提示对话框，如图 7-2 所示。这时可以单击对话框上的【调试】按钮让程序进入中断模式，如图 7-5 所示。

图 7-5 出现运行时错误 

中断一个正在执行的程序 

如果程序中没有出现编译错误和运行时错误，程序会一直执行，直到结束。如果出现死循环，会一直执行下去，不会中止。如：如果一个程序正在运行，当按下 `<Esc>` 键或 `<Ctrl+Break>` 组合键后，系统会中断执行它，并弹出提示对话框，如图 7-6 所示，单击对话框上的【调试】按钮即可让程序进入中断模式。

图 7-6 中断一个正在运行的程序 

7.3.2 为程序设置断点 

什么是断点 

断点像公路中途在检查站，当汽车开到这里就得停车接受检查。如果你怀疑程序中某行（或某段）的代码存在问题，可以在该处设置断点。当程序运行到断点所在行时会暂停执行，停止在断点所在行，进入中断模式，如图 7-7 所示。

图 7-7 程序停止在断点所在行 

进入中断模式后，可以按 `<F8>` 键逐句执行程序，观察运行情况，从而发现并修正存在的错误。

给程序设置断点 

方法一：设置断点的方法一，如图 7-8 所示。

图 7-8　利用 `<F9>` 键设置或清除断点 

方法二：设置断点的方法二，如图 7-9 所示。

图 7-9 利用菜单命令设置或清除断点 

方法三：设置断点的方法三，如图 7-10 所示。

图 7-10 单击边界条设置或清除断点 

如果想清除程序中的所有断点，可以依次执行【调试】→【清除所有断点】菜单命令（或按 `<Ctrl+Shift+F9>` 组合键），如图 7-11 所示。

图 7-11 清除程序中的所有断点 

7.3.3 使用 Stop 语句 

给程序设置的断点会在关闭文件的同时自动取消，如果你需要重新打开工作簿后继续使用设置的断点，可以使用 Stop 语句。在程序里加入一个 Stop 语句，就像给程序设置了一个断点，当程序运行到 Stop 语句时，会停止在 Stop 语句所在行，进入中断模式，如图 7-12 所示。

图 7-12 使用 Stop 语句中断程序 

Stop 语句在重新打开文件后依然存在，当不再需要 Stop 语句时，需要手动清除它。

7.3.4 使用立即窗口 

如果你怀疑程序中的错误是因为变量设置错误引起的，可以在程序中使用 `Debug.Print` 语句将程序运行中变量或表达式的值输出到【立即窗口】中，程序运行结束后，在【立即窗口】中查看变量值的变化情况，如图 7-13 所示。

图 7-13 使用立即窗口查看变量的值 

如果程序处于中断模式下，也可以将光标移到变量名称上，直接查看变量的值，如图 7-14 所示。

图 7-14 在中断模式下查看变量的值 

7.3.5 使用本地窗口 

在中断模式下，还可以利用【本地窗口】查看变量的数据类型和当前值，如图 7-15 所示。

图 7-15 使用本地窗口查看变量的值和数据类型 

如果【本地窗口】没有打开，可以依次执行【视图】→【本地窗口】菜单命令打开它，如图 7-16 所示。

图 7-16 调出本地窗口 

7.3.6 使用监视窗口 

在中断模式下还可以使用【监视窗口】观察程序中变量或表达式的值。使用【监视窗口】来监视变量或表达式前，必须先定义要监视的变量或表达式，监视表达式可以在设计模式或中断模式下定义。使用快速监视 使用快速监视如图 7-17 所示。

图 7-17 快速监视 完成后为程序设置断点，运行程序，就可以在【监视窗口】中看到相应的信息了，如图 7-18 所示。

图 7-18 使用监视窗口 

手动添加监视 手动添加监视如图 7-19 所示。

图 7-19 手动添加监视 

只有当程序处于中断模式时才能使用【监视窗口】，所以只有将程序切换到中断模式，【监视窗口】才能正常工作。编辑或删除监视表达式 编辑或删除监视表达式如图 7-20 所示。

图 7-20 编辑或删除监视

### 7.4 错误处理的艺术 

因为总会有许多意想不到的错误发生，如激活一个不存在的工作表，删除一个已经打开的文件，所以无论多么认真和仔细，都不能避免程序在运行时发生错误。但有些错误是可以预先知道的，所以可以在程序中加入一些错误处理的代码，保证程序正常运行。VBA 通过 On Error 语句捕获运行时错误，该语句告诉 VBA，如果运行程序时出现错误应该怎么做。On Error 语句有 3 种形式。

7.4.1 Go Error GoTo 标签 

Go Error GoTo 该语句告诉 VBA，当发生错误时，继续执行标签所在行及之后的代码。没有出现错误的提示对话框，如图 7-21 所示。

图 7-21 使用 On Error 捕获错误 

关于标签的设置，请参阅 3.7.7 小节中对 GoTo 语句的介绍。

7.4.2 On Error Resume Next 

该语句告诉 VBA：如果程序发生错误，继续执行错误行后面的代码。如果在程序中加入 On Error Resume Next 语句，运行程序时，即使程序中存在运行时错误，也不会中断程序，显示错误信息，并且会继续执行错误语句之后的代码。运行这个程序后，无论当前活动工作簿中是否存在 abc 工作表，都不会出现错误信息，也不会出现最后 Msgbox 函数的对话框。

发现了吗？ 

在程序中，总是把 `On Error GoTo 标签` 或 `On Error Resume Next` 放在可能出错的代码之前，这是因为只有 On Error 语句之后出现的运行时错误才能被捕捉到，所以通常把捕捉错误的语句放在程序开始处。

7.4.3 On Error GoTo 0 

使用 On Error GoTo 0 语句后，将关闭对程序中运行时错误的捕捉。如果在 On Error GoTo 0 语句后，代码再出现运行时错误，尽管在程序一开始已经写入 `On Error GoTo 标签` 或 `On Error Resume Next`，运行时错误都不会被捕捉到，如图 7-22 所示。

图 7-22 关闭错误捕捉

### 7.5 让代码跑得更快一些

7.5.1 合理地使用变量 

声明变量为合适的数据类型 

不同的数据类型占据不同大小的内存空间，如表 3-1 所示，数据所占内存空间的大小直接影响计算机处理数据的速度。因此，为了提高程序的效率，在声明变量时，在满足需求的前提下，应该尽量选择占用字节少的数据类型。

尽量不使用 Variant 型数据 

Variant 是 VBA 中一种特殊的数据类型，所有没有声明数据类型的变量都默认为 Variant 型。但 Variant 型所占据的存储空间远远大于其他数据类型，所以除非必须需要，否则应避免声明变量为 Variant 型。不要让变量一直待在内存里 如果一个变量只在一个过程里使用，请不要声明它为公共变量，尽量减少变量的作用域，这是一个好习惯。如果你不再需要使用某个变量（尤其是对象变量）了，请记得释放它，不要让它一直呆在内存里。

7.5.2 避免反复引用相同的对象 

无论是引用对象，还是调用对象的方法或属性，都会用到点（`.`）运算符，每次运行程序，计算机都会对这些点（`.`）运算符进行解析，当点（`.`）运算符过多时，会花去不少的时间。在这个程序中，`ThisWorkbook.Worksheets (1).Range ("A1")` 是每一句代码都反复引用的对象。引用对象不可避免，但当反复引用同一个对象时，可以用一些方法来简化它，从而减少点（`.`）运算符。

使用 With 语句简化引用对象

```c
Public Sub WithTest()
  With ThisWorkbook.Worksheets(1).Range("A1")
    .Clear
    .Value = "Excel Home"
    .Font.Name = "宋体"
    .Font.Size = 16
    .Font.Blod = True
    .Font.ColorIndex = 3
  End With
End Sub
```

还可以使用嵌套的 With 语句进一步简化程序：

```c
Public Sub WithTest()
  With ThisWorkbook.Worksheets(1).Range("A1")
    .Clear
    .Value = "Excel Home"
      .Name = "宋体"
      .Size = 16
      .Blod = True
      .ColorIndex = 3
  End With
End Sub
```

关于 With 语句，请参阅 3.7.7 小节的内容。

使用变量简化引用对象 

除了 With 语句，还可以使用变量来简化对相同对象的引用。如：

还可以借助 With 语句进一步简化输入：

7.5.3 尽量使用函数完成计算 

Excel 已经准备了很多现成的函数（工作表函数和 VBA 内置函数），尽管你可以通过编写程序去实现相同的目的，但对于相同的计算，使用函数比编写程序解决效率要高很多。

7.5.4 去掉多余的激活和选择 

如果你的程序是通过录制宏得到的，那里面一定有很多的激活和选择操作，即 Activate 方法和 Select 方法。如：

这是一个复制单元格的程序，调用了 4 次 Select 方法。但事实上并不需要激活工作表，选中单元格后才能执行复制、粘贴操作，所以这些选中工作表和单元格的代码都是多余的，程序可以简化为：

```c
Range("A1").Copy Sheets("Sheet2").Range("B1")
```

去掉多余的操作，不仅可以让程序更简洁，降低阅读和调试的难度，还能提高程序运行的速度。

7.5.5 合理使用数组 

下面的程序把 1 到 65536 的自然数写入 `A1:A65536` 中。逐个将数据写入单元格，在笔者的电脑上，程序运行的时间是 2.52 秒，如图 7-23 所示。

图 7-23 逐个将数据写入单元格需要的时间 

很明显，这样的操作是比较费时的。如果想提高运行速度，可以先把数据写入数组，再通过数组批量写入单元格，如：

```c
Public Sub InputArr()
  Dim start As Double
  start = Timer
  Dim i As Long, arr(1 To 65536) As Long
  For i = i To 65536
    arr(i) = i
  Next
  Range("A1:A65536").Value = Application.WorksheetFunction.Transpose(arr)
  MsgBox "程序运行的时间约是 " & Format(Timer - start, "0.00") & " 秒"
End Sub
```

使用数组后的程序只需要 0.09 秒的时间，速度提高了 28.1 倍，如图 7-24 所示，差距显而易见。

图 7-24 数组批量写入单元格所需的时间 

1『之前开发用 PHP 写数据进 excel 时就采用的这种高效方式，先把要写的数据全部处理好，放到一个数组里，然后整体把数据插入一块「区域」里。（2021-03-20）』

将一维数组写入 A 列单元格前，必须先使用工作表的 TRANSPOSE 函数将数组进行转置。如果想省去转置的计算步骤，可以直接将数组定义为一个多行一列的二维数组，如：

```c
Public Sub InputArr()
  Dim start As Double
  start = Timer
  Dim i As Long, arr(1 To 65536, 1 To 1) As Long
  For i = i To 65536
    arr(i, 1) = i
  Next
  Range("A1:A65536").Value = arr
  MsgBox "程序运行的时间约是 " & Format(Timer - start, "0.00") & " 秒"
End Sub
```

7.5.6 关闭屏幕更新 

设置 Application 对象的 ScreenUpdate 属性为 False（参阅 4.2.1 小节），在程序运行过程中关闭屏幕更新，可以在一定程度上缩短程序运行的时间。如果你的程序很短，需要做的操作很少，那代码是否优化，也许差别并不大。但如果要处理的数据很多，进行的操作很复杂，编写的程序很长时，优化程序代码是很有必要的。

无论你现在是否接触到这些复杂的问题，但请相信我，养成一个良好的习惯，编写简洁、高效的代码会给你学习和使用 VBA，最终成为一个 VBA 高手带来很大的帮助。