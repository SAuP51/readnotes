# 
> 2018000模板



05 时间调度理论 要事先行


安妮·迪拉德

我们度过每一天的方式，自然就是度过一生的方式。

尤金·劳勒

“我们为什么不写一本关于时间调度理论的书呢？”我问，“不应该花太多时间！”写作，就像发动战争，其中常常包含严重的计算错误。15年后，其中的日程安排仍然未执行完。

现在是周一早晨，你的日程表上还有一大堆任务等着去完成。有些任务只有在其他人完成之后你才能开始（只有在洗碗机内的碗碟被拿出后才能再次放碗碟进去），有些只能在规定的时间开始（如果你在周二晚上之前将垃圾倒在路边，邻居们就会投诉）。有些任务迫在眉睫，有些没有时间要求，有些处于两者之间，比较灵活。有些任务时间紧迫，但没那么重要。有些很重要，但并没那么紧迫。你也许会想起亚里士多德的这句话——“重复的行为造就了我们”，这种行为可能是拖地、与家人共度更多时光、准时发传真，或者学法语。

所以，我们该怎么做，什么时候做，以什么样的先后顺序做？人生就是在等待中度过。

虽然我们总能找到一些方式安排我们每天要做的事情，然而我们似乎并不认为我们善于安排这些事情。因此，时间管理指南之类的书常年位居畅销书榜的前列。不幸的是，我们往往能发现这些指南之间的矛盾和不一致之处。《尽管去做》一书中提倡的是，一想到任何可以在两分钟内完成的任务就立即去做。另一本同类畅销书《吃掉那只青蛙！》建议从最困难的任务开始，再逐步转向更容易的事情。《战胜拖延》一书则建议首先执行调度者的社交活动和休闲活动，然后再将工作填充到空白时间之中，而不是我们经常做的相反的顺序。“美国心理学之父”威廉·詹姆斯曾断言，“没有什么比永远有一个未完成的任务悬在那里更让人感到疲惫不堪的”，但弗兰克·帕特诺伊在《等待》中提到一些故意不立即完成任务的例子。

每位大师都有其独特的思想体系，我们很难知道该听谁的。





安排时间是一门科学


虽然时间管理跟时间本身一样古老，但时间调度这门科学是在工业革命时期的机器工厂中产生的。弗雷德里奇·泰勒是一名有钱律师的儿子，1874年，他放弃了哈佛大学的学业机会，去费城的恩特普赖斯水压工厂做了机工学徒。4年后，他完成了他的学徒生涯，开始在米德维尔钢铁厂工作，在那里，他一路从车工车间领班做到了总工程师。在这个过程中，他发现，他监管的机器（和人）的时间并没有被很好地利用，这促使他开创了他所谓的“科学管理”这一门学科。

泰勒创建了一个规划办公室，它的中心是一个公告板，展示了商店的日程安排，以便所有人都能看到。公告板记录商店里的每一台机器，显示该机器目前正在执行的任务，以及后续将执行的所有任务。这一创意是由泰勒的同事亨利·甘特提出的，他在1910年开发的甘特图帮助了从胡佛大坝到州际公路系统等20世纪美国很多雄心勃勃的建设项目规划组织。一个世纪后，甘特图仍然出现在亚马逊、宜家和美国太空探索技术公司项目经理办公室的墙壁和屏幕上。

泰勒和甘特将调度变成一种研究对象，他们赋予它视觉和概念的形式。但他们并没有解决一个基本问题，那就是，到底怎样安排日程是最好的。直到几十年之后的1954年，兰德公司的数学家塞尔默·约翰逊在他发表的一篇论文里才第一个暗示这一问题可以被解决。

约翰逊研究的是书籍装订这个例子，在装订过程中，每本书都需要在一台机器上印刷，然后在另一台机器上进行装订。但这种最常见的双机器安装例子更类似于家庭中的洗衣服。当你洗衣服时，必须先用洗衣机再用烘干机，每次洗不同的衣服花费的时间也不同。大的污渍可能需要更长的清洗时间，但烘干时间均不变；衣服数量多可能需要更长的烘干时间，但洗衣时间不变。所以，约翰逊问，如果在同一天你有很多衣服要洗和烘干，最好的处理方法是什么？

他的答案是，你首先应该找到一个需要最少时间的洗衣或者烘干的方法，如果这种最短时方法需要用洗衣机，那么先洗这批衣服。如果这种方法需要用烘干机，将这一步放到最后。剩下的衣服重复此最优分类过程，也就是在安排上从两端向中间进行。

直观地说，约翰逊的算法之所以合理是因为无论你如何安排洗衣的顺序，在开始时总有一段时间是洗衣机单独运行的，而在结束时总有一段时间是烘干机单独运行的。将开始时的洗衣时间和结束时的烘干时间最小化后，你就能将洗衣机和烘干机共同工作的时间最大化。因此，用于洗衣的总时间就会是绝对最小值。约翰逊的分析产生了时序安排的第一个最佳算法：从最好洗的衣服洗起，以最少的烘干衣量结束。

在直接应用之外，约翰逊的研究还揭示了更深层次的两点内容：第一，时序安排可以通过算法表达；第二，存在最优时序安排方案。这引发了一项庞大的研究，为大量假定工厂中不同数量和种类的机器运行提供策略。

与装订或洗衣过程不同，我们将重点研究这其中的一小部分：单一机器调度。因为最重要的时间调度问题只涉及一台机器：我们自己。





处理时限


一提到单机调度，我们立马会遇到一些问题。约翰逊的装订调度是基于最小化两机共同工作时间来降低总时间的。然而，在单机调度的情况下，如果我们要完成所有被赋予的任务，那么所有的安排都应该用同样长的时间去完成，这与先后顺序无关。

这一点最基本且违反直觉，值得重复应用。如果你只有一台机器，同时你必须完成所有的任务，那么对于任务的任何排序都将花费相同的时间。

因此，甚至在开始之前，我们就会遇到单机调度的第一堂课：明确你的目标。我们只有知道如何保持得分时才能宣布哪种安排更好。这是计算机科学中的一个主题：在你有一个计划之前，必须首先选择一个衡量指标。而事实上，我们最终挑选的这个指标将直接影响哪种安排方法的实施效果最好。

紧随约翰逊的装订理论，第一批单机调度研究应运而生，这些研究提供了几种合理的衡量指标。对于每一种指标，他们都提出了一种简单的、最优的策略。

这当然是很常见的，比如对有截止日期的任务，我们需要根据延期的程度进行判断。所以我们可以认为，在一批任务中“最大延迟”的任务就是超过截止日期最多的任务——这可能是你的老板在员工绩效评估中会在意的任务。（或者是你的客户在零售或服务过程中可能会关心的任务，其中“最大延迟”的任务对于顾客来说，是跟等待时间直接相关的。）

如果你要降低最大延迟时间，那么最佳策略就是你先从截止日期最近的任务开始，再以此类推逐渐执行。这一策略被直观地称为最早到期日原则。（例如，在服务行业，每位客户的“到期日”就是他们走进店的那一刻，这就意味着要按照客户进店的顺序进行服务。）但其中也有很多令人惊讶的问题。例如，每个任务要用多长时间完成是完全不相关的：它不会改变整体计划，所以实际上你甚至不需要知道任务时长，重要的是任务何时到期。

你可能已经使用最早到期日原则来统筹你的工作，在这种情况下，不需要计算机科学来证明这是个明智的策略。但你可能不知道，这就是最优策略。更确切地说，它假设你对一种衡量标准尤其感兴趣，即要减少你的最大延迟。但是，如果这不是你的目标，另一种策略可能就会更适合。

以冰箱为例。如果你是社区支持农业组织的成员，那么每一周或两周就会有很多新鲜农产品被送到你家。每一件产品生产于不同日期，所以你要根据它们的最早到期日期吃这些食物，根据保质期这个顺序吃它们似乎是一个合理的出发点。然而，事实不完全是这样。最早到期日是为了更好地减少最大延迟，这就意味着，它将最大限度地减少你吃到过期食物的概率，但这也许不是从最可口这个标准来衡量的。

也许我们要尽量减少腐烂食物的数量，穆尔的BM算法可以帮我们做出最好的计划。穆尔算法认为，我们第一步应该先按照最早过期日，也就是食物的腐烂日期将食物进行排序，最早过期的先吃，一次吃一个。然而，一旦我们意识到，也许不能在过期日之前吃完下一个食物时，我们就会暂停该计划，转过头考虑之前已有的计划，并拿出最大的项目（即一个将吃最长时间的食物）。例如，这可能意味着放弃要吃6顿的西瓜，甚至没有考虑尝试此食物之后很快能吃完的所有食物。然后，我们重复这种模式，按照食物的过期日排序，又在计划好的最大项目上停滞。只要我们能按照过期日的先后顺序将剩下的所有食物在过期之前吃完，那我们就完成了计划。

穆尔的算法最大限度地减少需要扔掉的项目数量。当然，你也可以用食物堆肥，或捐到当地的食品站，或者送给你的邻居。在工业或官僚资本的背景下，你不能简单地抛弃一个项目，但过期项目的数量而不是重要性仍然是你最大的关注点。穆尔的算法并没有关注如何处理那些过期的任务。任何从你的主体安排中分离出来的任务都可以按照任何顺序完成，这都不要紧，因为它们都已经超过时限了。





把事情做好


老子

千里之行，始于足下。

有时，最后期限并不是我们主要的考虑因素，我们只是想要把事情都做好：在尽可能少的时间里完成尽可能多的事情。这就使这一看似简单的要求很难转化成具体的统筹指标。

其中一种方法就是站在旁观者的角度。我们注意到，在单机调度中，我们所做的任何事情都不能改变我们完成所有任务所需要的时间。但如果每个任务都代表一个等待中的客户，那么就有一种方法能尽量少地占用他们的共同时间。想象一下，从星期一早上开始，你的日程表上有一个为期4天的项目和一个为期1天的项目。如果你在星期四下午完成那个大项目（经过4天），然后在星期五下午完成小项目（经过5天），两位客户会等共9（4+5）天。然而，如果将顺序颠倒，你可以先在星期一下午完成小项目，在星期五完成大项目，那两位客户总共等待的时间只有6（1+5）天。你5天的工作日时长不变，但是这样你就可以为你的客户共节约3天时间。调度理论家称这个标准为“完成时间的总和”。

将完成时间总和最小化可以引申出一个非常简单的优化算法——最短加工时间：总是先做能最快完成的任务。

即使不是每项工作都有暴躁客户的催促，但用最短加工时间法也可以帮助你把事情做好。（因此，最短加工时间法推荐你先做任何耗时不到两分钟的任务。）当然，这没有办法改变你的工作总量，但最短加工时间法可以尽快减少未完成的任务数，从而抚慰你的心灵。它的完成时间总和这一标准可以用另一种方式来表达：它就像是把重点放在减少待办事项列表的长度。如果每一件未完成的工作就像你身边的一根刺，那么尽快完成简单的任务可能会给你的心情带来一些舒缓。

当然，所有未完成的项目并不都是平等的。扑灭厨房里的火肯定比用邮件熄灭顾客的怒火更重要，虽然前者可能耗费的时间更长。在时间调度中，这种重要性的区别通常用权值这一变量表示。当你在完成你的待办事项时，这个权值可能就是很明显的负担——每完成一项任务都会让你觉得在减轻这种负担。一个任务的完成时间就是你背负这个负担的时间，所以最小化加权完成时间总和（也就是每个任务的持续时间乘以它的权值）就意味着是去最小化完成整个日程表所承受的全部压力。

针对这一目标的最优策略是对最短加工时间法的一种完善：将每个任务的权值通过其需要的完成时间进行划分，然后将单位时间重要性（如果你喜欢的话可以称之为“密度”，延续权值的隐喻）结果从高到低排序。虽然可能很难将日常工作的每一个任务都赋予一定的重要性，但这一策略仍然提供了很好的经验法则：只需优先完成那些可能需要双倍完成时间且具有双倍重要性的任务。

在商业环境中，“权值”很容易被理解为完成每个任务所带来的利益数额。按完成时间的长短划分奖励这一想法，因此可以被理解为每项任务的小时率。（如果你是一名顾问或自由职业者，这个小时率可能就已经为你计算好了：只要简单地按照每个项目的大小来划分其费用多少，并根据你的工作方式，将时薪从高到低排序。）有趣的是，这种加权策略也体现在动物觅食研究中，坚果和浆果就相当于美元和美分。动物为了最大限度地提高从食物中积累能量的速率，应该按照获得和食用该食物所需的时间和其热能比值高低来摄取食物——它们似乎也的确是这么做的。

当该原理应用于债务而不是收入时，就产生一个处于黑暗中、后来被称为“债务雪崩”的策略。减债战略是指忽略债务整体的数量和大小，只是把钱注入利息最高的那一笔债务。这就相当于按照单位时间重要性的顺序安排工作。这一策略能尽可能快地减轻债务的总负担。

另一方面，你可能更关心的是减少债务的数量而不是数额，例如，如果无数账单和不停接听催款电话所带来的麻烦对你来说可能比利息更令你烦心，那你就不用考虑权值了，你“只是想把事情解决好”而不是用最短处理时间原则，因此你应该先偿还最小的债务，让这些小债务先被处理掉。在削减债务圈，这种方法被称为“债务雪球”，实际上，无论是在大众媒体还是经济学研究中，人们到底应该优先降低债务的数额还是数量仍然是一个具有争议性的话题。





找出问题所在


这将涉及我们之前所讨论的单机调度问题。有人说：“戴一只手表的人知道时间，而戴两只手表的人就不能确定时间了。”计算机科学能给我们提供用单机调度执行的运用不同度量标准的最优算法，但选择哪种度量标准就取决于你自己了。在很多事情中，我们都得决定到底想解决什么问题。

这为我们提供了一种激进的方法来重新思考“拖延”这一时间管理的经典问题。我们通常认为拖延是一个错误的算法。但如果它正好相反呢？如果它是一个错误问题的最佳解决方案呢？

连续剧《X档案》的一集中，主角马尔德正被吸血鬼攻击，无力反抗，看上去命不久矣，为了自卫，他将一袋葵花籽倒在地板上。吸血鬼无力对抗自己的冲动，俯身拾起一个接一个的葵花籽，在他最终品尝到“马尔德大餐”之前，太阳出来了。计算机科学家称之为“PING攻击”或“拒绝服务”攻击：给系统无数琐碎的事情做，重要的东西就会迷失在混乱中。

我们通常把拖延、懒惰或逃避行为联系在一起，但拖延也会出现于在充满热情且想努力完成任务的人（或电脑，或吸血鬼）的身上。在2014年的一项由宾夕法尼亚州立大学戴维·罗森邦进行的研究中，研究者要求受试者将两个沉重的水桶中的一个拿到走廊的另一端。一个水桶在参与者的旁边，另一个则在大厅中间。让实验人员吃惊的是，人们立即拿起身边的水桶，一路将它拎到另一边，径直路过可以让他们少走一段路的另一个水桶。正如研究者所写：“这个看似理性的选择反映了一种趋势——超前主义，这是我们新提出的一个术语，是指完成任务时为了加速子目标的完成，甚至牺牲额外的体力。”推迟主要项目的工作，去完成各种琐碎的小任务也与此类似，这可以被视为“加速子目标的完成”。这是在换一种方式说，拖延症者也在努力行动，以尽快地减少他们头脑中悬而未决的任务数量。这并不是说他们在完成任务时使用了糟糕的策略，而是他们用一个伟大的策略选择了错误的指标。

在计算机上工作会带来额外的危险，当我们想到并仔细思考我们的调度标准时：用户界面可能会微妙（或不那么微妙）地将自己的度量使用在我们身上。例如，一个现代智能手机用户，已经习惯于看到“未读消息标签”徘徊在应用程序图标之上，令人恐慌的红白数字就是每个特定的应用程序在告诉我们希望我们完成多少任务。如果它是电子邮件收件箱中的未读邮件，那所有的消息都在无形中被赋予相同的权重。我们是否应该运用最短处理时间算法——先处理最简单的电子邮件，再处理更难的，以尽快减少未读邮件的数量呢？

人们的生死都充斥着各种标准。如果所有的任务都同等重要，那么这正是我们应该采取的方法。但是，如果我们不想被琐事所奴役，那么我们需要采取措施来结束这种状况。这首先要确保我们正在解决的单机问题是我们想要解决的问题。（在应用程序未读消息标签问题上，如果我们不能让它们反映我们实际的优先处理顺序，也不能克服减少摆在我们面前的任何数字图像的冲动，最好下一步就把未读消息这一功能关闭。）

重点不只是要把事情做好，更重要的是把权值更高的事情做好——在每一个时刻都做好最重要的工作，这听起来像是治愈拖延症的一个行之有效的方法。但事实证明，仅仅这样还不够。一组计算机调度专家将以一种最戏剧化的方式来感受这一点：在火星表面，全世界的人都在注视着他们。





优先级反转和优先约束


1997年夏，人类迎来一件值得庆祝的大事。人类火星探测车第一次降落在火星表面。价值1.5亿美元的火星探路者飞船加速到每小时16000英里的速度，穿越3.08亿英里的太空空间，并用太空安全气囊降落在红色岩石状的火星表面。

现在它却被暂停了。

在地球这边，喷气推进实验室的工程师们既担心又为难。探路者号最优先的任务（给“数据总线”输入输出信息）被神秘地忽视，而机器人却在没那么重要的任务上消磨时间。到底发生了什么？难道机器人不应该知道得更多吗？

突然，探路者号发现信息总线在一段不可接受的长时间里都没有被处理，并且没有一个细微的追索来源，它便进行了一次完全重启，使当天剩下的工作能被更好地完成。大约一天后，同样的事情再次发生。

喷气推进实验室团队经过仔细研究，终于成功重现并诊断该行为。其罪魁祸首是一种经典的危险调度行为，称为优先级反转。该行为是指低优先级任务做某些工作时拥有系统资源（这里我们可以说是访问数据库），但在做该任务时被定时器中断，该定时器使其暂停并触发系统调度器。调度器启动一个高优先级任务，但该任务不能运行，因为数据库已被占用。因此，调度器向下移动优先级列表，改为执行中等优先级工作，而不是高优先级任务（已被阻塞），或低优先级任务（已被锁定在中优先级任务之后）。在这种可怕的状况下，系统的最高优先级有时可以在任意长时间里被忽略。[1]

当喷气推进实验室团队的工程师将探路者号的这一问题识别为优先级反转的情况后，他们立即编写了一个修正代码，并将新代码数传送到百万英里之外的探路者号上。他们穿越太阳系发射的解决方案是什么呢？那就是优先级继承。如果发现低优先级任务阻塞高优先级资源，那么所有低优先级任务应该立刻变成系统上的最高优先级任务，“继承”被阻塞的优先级。

喜剧演员米奇·赫德伯格讲述了一件事：“当时我在赌场，我正在做自己的事情，有个人走过来说：‘你要挪一下位置，你挡住消防出口了。’我说，如果这里有火灾，我还不会跑吗！”这件事中，保镖的论点是优先反转，赫德伯格的反驳是优先继承。赫德伯格随便在一个暴徒的面前闲逛，将自己的低优先级（游玩任务）置于他的高优先级（逃生任务）之前。但如果他继承了优先级便不会这样。凶残的暴徒总有一种方式使其他人非常快地继承他们的优先权。正如赫德伯格所说：“只要你是可燃体，且双腿健全，你就永远不会堵住消防出口。”

这其中值得一提是，想把事情做好的热情不足以避免调度上的陷阱，光有想把重要事情做好的热情也不够。要承诺坚持做你所能做的最重要的事情，如果你一直目光短浅而不远望前方，那么你眼中的整个世界都仿佛处于拖延之中。正如汽车轮胎的旋转一样，只有当你的轮子被卡住时你才会渴望它立即开始运转。歌德曾说：“最重要的事情永远不应该受到不重要事情的影响。”虽然这有一定的道理，但它也不都是真的。有时候，最重要的事要等不重要的事情完成之后才能进行，所以这里只有将这些不重要的事情看得跟被阻塞的重要任务一样重要。

当某个任务在另一个任务完成之前无法启动时，调度理论家称之为“优先约束”。操作研究专家劳拉·艾伯特·麦克莱表示，她清楚地记得这一原则在她自己家里不止一次地产生了作用。“如果你能看到这些东西，这可能是有用的。当然，安排好三个孩子的一天，有很多需要统筹的事务……孩子们必须先吃完早餐，我们才能出门，如果我不记得递给他们勺子，那他们就不能吃早餐。有时，你忘记做一件小事会导致整个任务的延迟。在调度算法方面，仅仅知道这是什么并使其保持运转就已经大有裨益了。这就是我每天如何安排事情的。”

在1978年，调度理论研究者简·卡雷尔·伦斯特拉使用了相同的原理帮助他的朋友吉恩搬到伯克利的新家。“吉恩正在拖延一些事，这些事是必须在我们开始其他紧急事情之前就完成的。”伦斯特拉回忆说，他们需要退还一辆面包车，但又需要用这辆车运送一台设备，而又需要用这台设备来修理公寓里的东西。这个修理的任务没那么紧急（因此它被推迟），但换车是很紧急的。伦斯特拉说：“我向他解释道，应该考虑到前任务更加紧急。”伦斯特拉是调度理论的中心人物，因此他有能力给他的朋友提供这个建议，这也带来了特别有趣的讽刺意味。这是一个由优先约束引起的优先级反转的标准案例。可以说，20世纪最优秀的优先约束专家就是他的朋友尤金“吉恩”劳勒。

[1]具有讽刺意味的是，探路者号的软件团队负责人格伦·里夫斯将该问题归结于“截止日期压力”的错误，并认为在开发过程中修复这个问题被认为是“较低优先级”。因此，其根本原因在某种程度上来说，就是镜像问题本身。





减速带


劳勒考虑到他一生大部分时间都在思考如何最有效地完成一系列的任务，他便对自己的职业生涯采取了一种有趣的迂回路线。他在佛罗里达州立大学学习数学，后于1954年在哈佛大学攻读研究生，但在获得博士学位前便离开。后又在法学院、军队和机械加工车间工作，1958年他回到哈佛大学，得到博士学位后他开始在密歇根大学工作。1969年，在休假期间他去了伯克利，在一场声名狼藉的反越南战争的抗议中被逮捕。次年，他成为加州大学伯克利分校的一名教师，并获得了计算机科学系的“社会良知”的美誉。他于1994年去世，此后计算机协会设立了劳勒奖，表彰那些体现出计算机科学人道主义潜力的人。

劳勒的优先约束理论的第一次调查表明，它们应用起来十分容易。例如，采取最早到期日算法将一组任务的最大延迟量进行最小化。如果你的任务有优先约束，那只会使事情更加棘手——如果有些任务必须在其他任务之后完成，那你就不能简单地按照到期日的先后顺序来安排任务。但在1968年，劳勒证明了只要你按照从后往前的顺序建立时间表就没有问题：只看跟其他没有依赖关系的任务，并把到期日最后的任务排在日程表的最后。然后重复这一过程，每一步都只考虑那些不作为其他（还未做安排的）任务完成前提的任务。

但当劳勒更深入地考虑优先约束时，他发现了一些奇怪的问题。我们所看到的是，如果你想尽可能快地从你的待办事项列表中理清尽可能多的项目，最短处理时间算法就是最佳策略。但是，如果某些任务有优先约束，便没有一个简单或明显的调整原则。虽然这看起来像一个基本调度问题，但无论是劳勒还是其他任何研究人员似乎都没能找到一个有效的解决方法。

然而，事实比这还糟。在那之后不久，劳勒自己也很快发现这一问题属于大多数计算机科学家认为没有行之有效的解决办法的范畴——在该领域被称为“难解性”[1]。影响调度理论发展的这第一个减速带就是一个难以逾越的障碍。

正如我们看到的，在“三倍或无”（要么赢三倍，要么全部输光）的情况下，最优停止理论并没有圣人的指导，每一个问题也并不都能用一个正式答案表达。在调度问题上，其定义就很清楚地表明，每一组任务和约束都有一些最好的调度安排，所以本质上调度问题并不是不可回答的，但它可能没有简单直接的算法帮你在一个合理的时间量里的找到最优安排。

这使劳勒和伦斯特拉这样的研究者面临一个不可抗拒的问题：究竟什么比例的调度问题是难解的？在塞尔默·约翰逊初创调度理论的20年后，对个人解决方案的探索已变成一项更浩大、更雄心勃勃的研究：通过这一探索可以纵观整个调度理论。

研究人员发现，即使是对调度问题进行最微妙的改变，也经常会跨越易处理和不易处理之间细致而又不规则的分界线。例如，当所有任务都具有相同权值时，穆尔算法就最大限度地减少了过期任务（或腐烂水果）的数量。但如果一些任务比其他更重要，这个问题就变得难解，没有算法可以很轻松地提供最佳安排。同样，如果某些任务必须等到某个时间点才能开始，那几乎所有的安排都会陷入难解的境地。在收垃圾车到来的前一天晚上才能把垃圾倒出去，这可能是一个合理的市政规章，但它会让你的日程安排变得棘手。

对调度理论边界的绘制一直持续到今天。最近的一项调查表明，在所有问题中大约有7%是仍然未知的，就是调度的未知领域。然而，在我们所理解的93%的问题中，现实也并不是很理想：只有9%的问题可以被有效解决，其他的84%已经被证明是难解的。[2]换句话说，大多数的调度问题都没有现成的解决方案。如果你觉得很难完美地管理你的日程，那也许因为实际上这就是难以管理的。尽管如此，我们讨论过的算法往往是解决那些困难问题的起点——也许不是那么完美的，但至少是可以预期的。

[1]我们将在第8章详细研究“难解性”这一问题。



[2]事实也并非数据显示的那么糟糕，因为这包括多机调度问题，更像是管理一组员工而不是管理你的日历。





放弃所有：抢占和不确定性


谚语

种树最好的时间要么是20年前，要么就趁现在。

到目前为止，我们只考虑了使调度变得更加困难的因素。但有一个转折可以使它更容易：能够中途停止一个任务的执行切换到另一个任务。“抢占”这个属性最后会戏剧性地改变整个游戏。

如果有些任务不能在一个特定的时间开始，那么将最大延迟（为咖啡店的顾客服务）或完工时间（为了快速缩短你的待办事项列表）最小化都越过了难解性那条线。但一旦允许抢占，那就还有其他高效的解决方案。在这两种情况下，经典的策略——最早到期日和最短加工时间，只要进行一个相当简单的修改，就是表现最好的。当任务开始时，将该任务与正在进行的任务进行比较。如果你运用最早到期日原则，新的任务甚至比现在的任务截止日期更早，那么就转换档位，否则它将停滞不前。同样，如果你运用最短加工时间原则，新的任务可以完成的比目前的任务更快，那么先暂停处理这一个，否则就继续你正在做的事情。

现在，如果一周的生意好，一家机械工厂可能会知道在接下来的几天里他们所期望的一切，但是我们大多数人通常都是盲目的，至少部分人是这样。例如，我们可能不确定我们何时才能启动一个特定的项目。（某人会就某个问题给我一个确定的答案吗？）在任何时候，我们的电话或电子邮件都可能弹出一个新任务的消息，添加到我们的原议程之中。

事实证明，即使你不知道什么时候会开始工作，最早到期日和最短加工时间仍然是最佳的策略，这能够保证你在面对不确定性时表现出最佳状态（平均来说）。如果在不可预知的时刻，你的桌子上突然出现一堆任务，最小化最大延迟仍然是最早到期日的抢先版最佳策略——如果新来的任务比手头上的截止日期更早的话，那就转而执行这一新任务，如果不是就忽略它。同样，最短加工时间的抢先版策略（比较当前任务的剩余完成时间和完成新任务所需要的时间）仍然是最小化完成总时间的最佳方法。

事实上，在面对不确定性时，最短加工时间的加权版本是一种最通用的调度策略。它提供了一个简单的时间管理方法：每接到一件新工作时，通过其将耗费的时间来对其进行重要性的划分。如果该重要性高于当前正在执行的任务，就切换到新任务，不然就坚持当前任务。该算法是调度理论最接近“万能钥匙”的地方，最佳策略并不只是为了解决一个问题，而是许多问题。在一定条件下它所要最小化的并不只是加权完工时间的总和，如我们所期待的，也是超期任务的权值以及这些任务的加权超时数的总和。

有趣的是，如果我们提前知道任务的开始时间和持续时间，想要优化所有其他的指标也都是难解的。所以，调度不确定性的影响揭示了一些违反直觉的东西：在有些情况下，透视是一种负担。即使拥有完全的预知，寻找完美的调度计划实际上也许也是不可能的。相比之下，驻足思考，工作来时反应灵敏，也许不能给你想象中完美的调度执行，但这是你可以做的最好的一件事，也最容易计算。这会带来一些安慰。作为商业作家和编码员的杰森·弗瑞德曾说：“直到做出一个万能计划，你才会继续吗？用‘猜测’代替‘计划’，并放轻松。”当未来充满迷雾的时候，原来你不需要日程表，只需要一个待办事项清单。





抢占并不是随意的：关联转换


谚语

走的越急，就落得越远。

埃伦·厄尔曼

程序员不说话，因为他们不能被打断……与其他人同步（电话、蜂鸣器和门铃）只能意味着打断思路。中断就意味着会发生一些错误。你不能中途下车。

所以，调度理论还是告诉人们一个合理而又鼓舞人心的道理。解决许多调度问题时，有最简单和最优算法，而要解决的这些问题都已经非常接近我们在日常生活中遇到的情况。但是，在现实世界中，当涉及实际操作的单机调度问题时，事情就会变得复杂。

首先，人们和计算机操作系统都面临着一个奇怪的挑战：正在进行调度的机器和将要进行计划的机器是同一个。要想理顺你的待办事项清单上的项目，需要你的待办事项列表本身进行优先处理和调度。

其次，抢占也不是随意的。每当你转换任务时，你都要付出代价，这在计算机科学领域被称为上下文切换。当计算机处理器把注意力从给定的程序上转移时，总要付出一定的代价。它需要有效地标记该任务的位置，并将其所有相关信息放置一边，然后找出它下一步运行的程序。之后，必须取得该程序的所有相关信息，找到它在代码中的位置，最后进入该档位。

这种来回切换并不是“真正的工作”，也就是说它们都没有实际提高计算机所切换的程序的状态。这是无用功，每一次上下文切换都在浪费时间。

人类在上下文切换时也会付出代价。对于这一点，我们在以下时刻会有所体会，我们将办公桌上的文件拿来又拿走，电脑上的文件关闭又打开，走进房间却不记得我们要来做什么，甚至我们会大喊：“我在哪里？”“我在说什么？”心理学家的研究表明，对于我们来说，任务切换的影响可以包括延迟和错误，影响时间会是几分钟而不是几微秒。任何一个人，如果你在一小时内被中断几次，那么你就有这一个小时什么都做不成的危险。

就个人而言，我们已经发现，编程和写作需要考虑整个系统的状态，所以其进行切换的成本就非常大。我的一位编程的朋友说，正常的一周工作时间不适合他的工作，因为对他来说，一天工作16小时的效率是每天8小时的两倍多。对于布瑞恩来说，他认为写作是一种锻造。金属在具有可塑性之前都要一段时间来加热。他发现，写不到90分钟就不会有什么成果，因为前半个小时几乎出不了成果，除了将“我在做什么？”这个大问题装进他的大脑。匹兹堡大学的调度专家柯克·普鲁斯，也有同样的经历。“如果只有不到一个小时是时间，我就去做些简单的小差事，因为我要花35分钟才能真正弄清楚我想做什么，然后我可能就没有时间去做这件事了。”

英国作家吉卜林在其1910年创作的著名的诗《如果》最后高度呼吁对时间的管理：“如果你能惜时如金，那就利用每一分钟不可追回的光阴……”

真希望是这样。但事实是，我们总会将大量时间花在无用的工作上，比如考虑如何记账和任务管理。这是调度的基本权衡之一。你承担的越多，花费的时间就越多。在极端的噩梦中，这变成一个被称为颠簸的现象。





颠簸状态


《社交网络》

盖齐：扎克伯格先生，你现在是完全专心地在听吗？

扎克伯格：你只吸引了我的部分注意力——只有最低限额。

计算机多任务处理的过程被称为“线程”，你可以想象为在玩一组球。就像一个杂耍者一次只能投掷一个球，而同时其他的球都在空中，计算机中央处理器一次也只能处理一个程序，但可以快速地切换（以1/1000秒为单位），像放电影、浏览网页，或立即提醒你收到的电子邮件。

20世纪60年代，计算机科学家开始思考如何在不同的任务和用户之间实现计算机资源共享的自动化过程。“这是一个激动人心的时刻。”皮特·丹宁说道。他现在是计算机多任务处理的顶级专家，当时正在麻省理工学院攻读博士学位。令人兴奋又不确定的是：“你会如何划分一个主内存之间的大量工作？如果它们中的某些想变大，某些可能要缩小，而且它们会相互影响，试图窃取‘记忆’和所有东西……你如何管理这整套的任务？没有人知道该怎么做。”

一点儿都不奇怪，由于研究人员并不真正清楚他们在做什么，他们付出的努力便遇到了困难。有一件事引起了他们的注意。丹宁说，在一定条件下一个戏剧性的问题“就会出现，由于你不断给多任务处理增加更多工作，在某个时刻，当你超过一个临界阈值时（这个值的准确位置在你未到达之前很难预测），你就会知道。因为这时，系统似乎突然死了”。

想想之前的杂耍者形象。当一个球被抛在空中时，杂耍者有足够的时间将另一个球抛向空中。但如果再加一个球他能处理吗？如果他不把那个球抛向空中，那其他所有的球都会掉到地上。很明显，整个系统就会崩溃。正如丹宁所说：“多增加一个程序就会造成服务的崩溃……这两个例子之间显著的差异最初是违背直觉的，这可能使我们在新程序被引入到拥挤的内存时对服务的期望逐步下降。”相反，这却是灾难性的。虽然我们可以理解一个不知所措的杂耍者，但究竟是什么让这样的事情发生在一个机器上的呢？

这里的调度理论与缓存理论交叉。缓存理论的全部思想就是保持所需项目“工作集”可用，以便快速访问。这其中的一个方法就是让计算机正在使用的信息保存在快存上，而不是在慢存硬盘上。但是，如果一项任务需要跟踪很多事情，那它们就无法被全部存入内存，那么你可能会花更多的时间在内存上录入和提取信息，而没有时间做实际工作。更重要的是，当你切换任务时，新活动的任务可能要给正在进行中的工作集腾出空间，即从内存中删除部分工作组。即将被激活的下一个任务，将重新获得其工作集的部分空间，将它们重新放回内存，这也将再次取代其他信息。这一问题（相互窃取空间的问题）在处理器和内存之间具有层次结构的高速缓存系统中会变得更糟。皮特·泽吉尔斯达是Linux操作系统的调度程序的主要开发者之一，他说：“缓存对目前的工作量来说还是很柔和的，当你进行上下文切换时，几乎所有缓存都会失效。而这带来的伤害很大。”在极端情况下，一个程序可以运行足够长的时间，把它所需要的项目转换成内存，然后再让路给另一个程序运行，该程序会再运行足够长的时间以覆盖之前的信息。

这就是颠簸：系统全速运行，却一事无成。丹宁第一次诊断出这种现象是在内存管理领域，但计算机科学家现在使用的“颠簸”这一术语是指任何情况下的系统停止，因为它完全被无用功占据。颠簸的电脑不是逐渐停下来，而是像从悬崖上掉下来的。“真正的工作”已经降到了零，这也意味着要走出这种困局几乎是不可能的。

颠簸对于人类来说是一个非常好辨识的状态。如果你曾经有过这样一个时刻，例如你想停止手头上的事情，以便有机会写下所有你应该做的事，但并没有多余的时间，由此你就陷入颠簸状态。对于计算机来说，原因是一样的：每一个任务都基于我们有限的认知资源。如果记住一切我们需要记住的事情就已经占据我们全部的注意力了，或者优先考虑每个任务就已经消耗掉这些任务所需要完成的所有时间，或者我们的思绪在被转化为行动之前就常被打乱，那么这种感觉很令人恐慌。这就是颠簸，电脑对这一点很清楚。

如果你的系统曾经陷入颠簸（如果你曾经在这样一种状态）那么你可能会想知道计算机科学是如何摆脱这种困局的。在丹宁20世纪60年代的一篇以此为主题的划时代的论文中，他指出，一盎司的预防胜过一磅的治疗。最简单的方法就是获得更多的内存，例如足够的RAM（随机存取存贮器）将所有运行中的程序工作集同时转换为内存，并减少切换所花费的时间。但这一预防颠簸的建议在你深陷其中时却不能帮你。此外，当涉及人类注意力时，我们就会陷入我们已有的事物之中。

另一种避免颠簸的方式是学会说“不”的艺术。丹宁举例说，如果一个系统没有足够的空余内存以保存其工作组，那就应该拒绝添加新的程序，这可以防止机器的颠簸。这是给所有任务繁多者的明智忠告。但这似乎也是一个遥不可及的奢侈品，我们中的一些人发现自己已经超负荷运转，或者无法缩减分配给我们的需求。

在这种情况下，显然已经没有办法工作得更努力，但你可以工作得更——笨。随着思考存储，上下文切换时无用功的一个最大来源就是选择下一步要做什么。这有时也会使实际工作陷入困境。例如在面对收件箱里满满的邮件时，我们从排序理论得知，重复搜索其中最重要的一个邮件进行回答，就会带来O（n2）多个操作步骤——n个邮件每个都要进行n次搜索。这就意味着，如果当你起床后发现收件箱里邮件的数量是平时的3倍，那你就要花比平时长9倍的时间去处理这些邮件。更重要的是，搜索那些电子邮件就意味着在你回复任何一个邮件之前，要将每一条消息都一个接一个地录入你的脑海里：解决存储颠簸的一个万全之策。

在颠簸的状态中，你基本上没有任何进展，所以即使以错误顺序做工作也比什么都不做要强。不是首先回复最重要的邮件（这需要对整体进行评估，因此可能要比工作本身花更多时间），也许你应该回避这种二次时间流沙，而只是以随机顺序或者屏幕上显示的任何顺序来回复电子邮件。同样的，Linux操作系统的核心团队在几年前，用一个不太“聪明”的调度师代替了原来的调度师，这位新调度师可能没那么精于优先处理计算，却计算得更快。

然而，如果你仍然想保持你的优先事项，你还可以争取另一个，甚至更有趣的交易，以重获你的工作效率。





中断合并


使实时调度变得如此复杂和有趣的部分原因是，它本质上是两个完全不兼容的原则之间的协调。这两个原则被称为反应速度和吞吐量：是指你能多快地进行反应，以及你可以做多少。任何曾经在办公室工作过的人都可以很容易地体会到这两个指标之间的紧张关系。对那些工作是接电话的人来说，这就是部分原因：他们反应速度越快，其他人的吞吐量就越大。

同样，生活更困难时你必须像一台电脑一样在反应速度和吞吐量之间做出自己的权衡。但矛盾的是，要想把事情做好，最好的策略就是慢下来。

操作系统的调度程序通常被定义为一个“周期”，其中的每个程序至少要保证运行自己的那部分任务，这样系统就给每个程序提供该周期的其中一个“切片”。程序运行得越多，这样的一片就越小，每一期发生的上下文切换就越多，这样就要以吞吐量为代价保持反应速度。然而，如果不加以控制，这种保证在每个周期中每一进程至少都会得到一些关注的策略，可能导致灾难。当有足够多的程序运行时，任务切片就会缩得极小，以至系统会将整个切片都花费在上下文切换上，而不是切换到下一个任务上。

罪魁祸首是硬反应保证。因此，现代操作系统实际上为其程序切片设置了一个最小长度，若长度达到该最小值，系统将拒绝再进行细分。（例如，在Linux系统中，这个最小切片的值被设定为一毫秒，但就人类而言，现实中这一时间可能至少要几分钟。）如果添加了超越这一数字的进程，周期就会变得更长。这意味着那些进程将不得不等待更长的时间才能轮到被处理，但它们所等待的时间至少要足够做一些事情。

设置花在任何一个任务上的最低时间量，有助于防止过于强调反应速度而完全忽视吞吐量：如果系统最小切片时间比其上下文切换的时间长，则系统永远不会进入一种只进行上下文切换的状态。这也是一个很容易转化为人类生活建议的原则。如“时间盒子”或“番茄时钟”等方法（你随便设置一个厨房定时器或承诺做一个任务）就是这一思想的体现。

但是你应该设置多长时间呢？面对在执行重复任务之间要等待多长时间这样一个问题，比如检查你的电子邮件，从吞吐量的角度来看，答案很简单：尽可能长的时间。但这并不是故事的结尾，毕竟更高的吞吐量也意味着更低的反应能力。

对于你的电脑来说，它必须定期检查的恼人干扰并不是邮件，而是你。你可能不会把鼠标移动几分钟或几个小时，但当你移动鼠标时，你会期望看到屏幕上的指针立即移动，这意味着机器为了跟上你的步伐将耗费大量的努力。检查鼠标和键盘的频率越高，它在输入时就能反应得越快，但是它需要做的上下文切换就越多。因此，计算机操作系统在决定花多长时间来完成一些任务的时候，所遵循的规则很简单：用尽可能长的时间，以免用户感到紧张或迟钝。

当我们离开家去做一件快速完成的差事时，我们可能会说：“你甚至不会注意到我已经离开了。”而当我们的机器进行上下文切换去做计算时，在我们发现系统已经切换走之前，其必须由我们所控制。为了找到这个平衡点，操作系统的程序员便转向心理学方面进行研究，心理物理学研究能精确地计算出人类大脑滞后或延迟时所需的毫秒数。比这更密切地关注于用户是没有意义的。

多亏了这些努力，当操作系统工作正常时，你甚至不会注意到你的计算机正在发挥着多么大的作用。即使你的处理器在全速运转，你也可以继续在屏幕上顺畅地移动你的鼠标。顺畅性可能会导致吞吐量的下降，但这是由系统工程师设计的一个权衡：你的系统会尽可能多地花时间与你交流，然后及时刷新鼠标。

再次，这是一个可以应用到人类生活的原则。其寓意是，你应该尽可能长时间地停留在一个任务上，而不是将你的反应降低到最低可接受的限度以下。决定你的反应速度，然后，如果你想把事情做好，就不要超过此反应速度。

如果你发现自己在进行很多上下文切换（因为你在处理一系列短任务），你也可以使用计算机科学的另一个做法：“中断联合”。例如，如果你有5张信用卡账单，不要在刚收到第一张账单时就立即支付它，一直等到第五张账单来时再做处理。只要你的账单在到期31天之内，你就可以指定每个月的第一天作为“账单支付日”，然后在这一天，把每张账单放在你的办公桌上开始处理，不管你是在三周前还是三小时前收到的。同样，如果你的电子邮件通信者没有要求你在24小时内回复，你可以限制自己每天只检查一次消息。电脑可以自己做这些事：等到固定时间间隔进行一次检查，而不是在上下文切换时处理那些不相关、不协调的各种子任务。[1]

有时，计算机科学家发现自己的生活中并没有中断联合的存在。谷歌的研究部主任彼得·诺维德说：“我今天要跑去市区办三次事，我说‘哦，好吧，这只是你的算法中的一个单线错误代码。你应该等待，或者把这些事先添加到待办事项列表中，而不是按顺序一个一个执行，因为他们每次只增加一个’。”

就人类而言，我们会中断联合邮政系统，就像它们的投递周期一样。因为信件一天只揽收一次，所以你若投寄迟了几分钟，你的信件就要多花24个小时才能送达。考虑到上下文切换的成本，其原因应该是显而易见的：你每天最多只能被账单和信件打断一次。更重要的是，我们的24小时邮政系统要求的最小反应速度就是：你在收到信后的5分钟或5小时回复邮件，并没有任何区别。

在学术界，上班时间就是一种中断联合。而在私营部门，中断联合提供一个最恶毒的办公室礼仪的救赎观：每周例会。无论其缺点是什么，定期会议都是我们对自发的中断和计划外的上下文切换的一种最好防御。

也许最小上下文切换生活方式的守护神就是传奇程序员高德纳·克努斯。“我一次只做一件事，”他说，“这就是计算机科学家们称之为批处理的方法，它是用来代替交替进出的。因此我不交替进出。”克努斯不是在开玩笑。2014年1月1日，“2014版克努斯排版”出现了，他在其中修正了该软件过去6年来所报告出现的所有错误代码。他在报告最后愉快地说道：“敬请期待2021版！”同样的，克努斯直到1990年才有第一个电子邮箱的地址。“电子邮件对于那些在生活中扮演着重要角色的人来说是件美妙的事情，但我并不是这样的人，我的身份是在底层，我所做的事情需要很长时间的学习和不断的集中精力。”他每3个月查收一次他的邮政邮件，每6个月查收一次传真。

但是，你并不需要事事都参照克努斯的极端原则，以期望我们生活中有更多事可以使用中断联合作为一个设计原则。邮局遵照这种原则的情况很少，在其他地方，我们需要为自己建立原则，或进行要求。各种能发出声音的设备都有“请勿打扰”模式，我们可以手动切换打开和关闭一整天，但这种工具都太生硬。相反，我们可能会想进行一些设置，为中断联合提供一个明确的选择。这就相当于在设备内部进行的人类时间尺度。它每10分钟提醒我一次，然后告诉我一切细节。

[1]由于每当计算机想要我们进行某种操作时，它们往往会弹出错误信息和对话框，这种行为是有点儿虚伪的。用户界面以一种中央处理器本身很少容忍的方式要求提起用户的注意。





